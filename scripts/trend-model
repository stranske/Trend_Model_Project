#!/usr/bin/env bash
# Development wrapper for trend-model CLI
# Makes 'trend-model' command available without requiring package installation
# Ensures deterministic hash seeding unless user already provided one.

if [[ -z "${PYTHONHASHSEED:-}" ]]; then
    export PYTHONHASHSEED=0
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
SYSTEM_PYTHON="$(command -v python || true)"

if [ -f "${PROJECT_ROOT}/.venv/bin/activate" ]; then
    # shellcheck disable=SC1090
    source "${PROJECT_ROOT}/.venv/bin/activate"
fi

PYTHON_EXEC="python"
VENV_PYTHON="${PROJECT_ROOT}/.venv/bin/python"
if [ -x "${VENV_PYTHON}" ]; then
    PYTHON_EXEC="${VENV_PYTHON}"
fi

can_import_cli() {
    PYTHONPATH="${PROJECT_ROOT}/src:${PYTHONPATH:-}" "$1" - <<'PY' >/dev/null 2>&1
import importlib
import sys

try:
    importlib.import_module("trend_analysis.cli")
except ModuleNotFoundError:  # pragma: no cover - shell wrapper guard
    sys.exit(1)
sys.exit(0)
PY
}

if ! can_import_cli "$PYTHON_EXEC"; then
    if [ -n "$SYSTEM_PYTHON" ] && [ "$SYSTEM_PYTHON" != "$PYTHON_EXEC" ] && can_import_cli "$SYSTEM_PYTHON"; then
        PYTHON_EXEC="$SYSTEM_PYTHON"
    else
        echo "trend_analysis package not installed. Run 'pip install -e .' first." >&2
        exit 1
    fi
fi

PYTHONPATH="${PROJECT_ROOT}/src:${PYTHONPATH:-}" exec "$PYTHON_EXEC" -m trend_analysis.cli "$@"
