1. Agents keepalive: always create a new instruction comment with required hidden markers and TRACE

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
The keepalive workflow sometimes edits a status comment instead of creating a fresh instruction comment. Our PR‑meta only listens to issue_comment.created, so edits never trigger detection or dispatch. Separately, the detector requires hidden markers; when they’re missing, detection skips. We must make it impossible to post anything but a brand‑new instruction comment that includes the required markers each round.

Scope

For every keepalive round, create a new instruction comment (do not edit any prior bot comment).

Always include the two hidden markers at the top of the comment:

<!-- keepalive-round: {N} -->

<!-- codex-keepalive-marker -->

Also include a unique trace token for observability:

<!-- keepalive-trace: {TRACE} -->

Keep the visible @codex instruction and the task/acceptance content as‑is.

Non‑Goals

Changing acceptance criteria, Gate logic, labels, or agent selection

Dispatching to external connectors directly (handled by PR‑meta issues)

Any textual rewrite of the visible instruction beyond inserting the markers

Tasks

- In the keepalive poster (Codex Keepalive Sweep):

  - Generate a KEEPALIVE_TRACE (e.g., epoch‑timestamp plus random suffix) and export to env.

  - Compute next round number as today; do not infer from edited comments.

  - Use peter-evans/create-issue-comment@v3 (or equivalent) to create a new comment with body starting:

    <!-- keepalive-round: {N} -->
    <!-- codex-keepalive-marker -->
    <!-- keepalive-trace: {TRACE} -->
    @codex

    followed by the existing instruction and checklist.

  - Authenticate comment creation with the bot PAT that posts as stranske-automation-bot.

  - Add a brief step summary with Round and TRACE for quick correlation.

- Verify behavior on a test PR: confirm an issue_comment.created event appears for the new bot comment.

Acceptance criteria

- On each keepalive cycle, the PR gains exactly one new bot comment (no edits) whose body begins with the three lines above.

- An issue_comment.created event is emitted for that comment.

- The comment’s visible text still includes @codex and the task/acceptance content.

- The step summary for the keepalive poster shows Round = N and TRACE = <value>.

Implementation notes

Likely touchpoints: .github/workflows/agents-70-orchestrator.yml (Codex Keepalive Sweep step) and/or scripts/keepalive-runner.* if used to assemble the body.

Use SERVICE_BOT_PAT (or the repo’s canonical bot PAT) for comment write.

Do not remove the existing status summary comment; this change only governs the instruction comment.

2. Keepalive pipeline: PR‑meta detect & dispatch with dedupe; Orchestrator carry TRACE, avoid self‑cancellation, and emit explicit bail reasons (assignees skip bots)

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
Even with correct instruction comments, we saw rounds that didn’t lead to work due to: missed detection, duplicate triggers, orchestration runs killed by concurrency, silent exits at gates, and assignee enforcement failing on bot/app accounts. We need hardened invariants so a valid keepalive comment always results in either a worker run or a clear, machine‑readable reason.

Scope

PR‑meta (issue_comment.created on PRs):

Detect keepalive only when the body contains both markers <!-- keepalive-round:N --> and <!-- codex-keepalive-marker --> and the author is allow‑listed.

Extract N and TRACE (<!-- keepalive-trace: … -->).

Dedupe by adding a “rocket” reaction to the comment and skipping if already present.

Dispatch Agents 70 Orchestrator via createWorkflowDispatch with an options_json that includes { keepalive_trace, round, pr }.

Post a concise job summary with ok | reason | round | trace.

Ignore issue_comment.edited.

Orchestrator (Agents 70):

Accept options_json, parse keepalive_trace, round, and pr.

Set concurrency.cancel-in-progress = false and key the group by keepalive_trace (or pr+trace) so later events don’t cancel the run.

Before any early exit (Gate not green, labels missing, branch mismatch, etc.), post a one‑line PR comment:
**Keepalive {round}** `{trace}` skipped: <reason-code>` and write the same to the job summary.

Assignee enforcement: treat app/bot logins as non‑assignable, use the PR number with issues.addAssignees, and skip gracefully if no human assignees remain.

Proceed to belt/worker when keepalive is enabled, even if a PR already exists.

Non‑Goals

Changing Gate semantics or acceptance criteria

Re‑introducing command listeners for arbitrary text beyond keepalive detection

Altering worker implementation beyond logging TRACE

Tasks

- PR‑meta (.github/workflows/agents-pr-meta.yml):

  - Add/confirm marker checks, author allow‑list, and issue_comment.created only.

  - Implement reaction‑based dedupe (rocket).

  - Dispatch orchestrator with ACTIONS_BOT_PAT and inputs:
    - options_json: {"keepalive_trace":"<TRACE>","round":"<N>","pr":<PR_NUMBER>}.

  - Write a job summary logging ok | reason | round | trace.

- Orchestrator (.github/workflows/agents-70-orchestrator.yml):

  - concurrency: { group: "agents-70-orchestrator-${{ inputs.options_json || github.run_id }}", cancel-in-progress: false }

  - Parse options_json into env (TRACE, ROUND, PR).

  - Implement explicit gate checks; on failure, post the one‑line PR comment with ROUND and TRACE and write the same to the step summary, then end the run.

  - Assignee enforcement: filter out login values ending with [bot] or known app/connector names; use PR number for issue_number; skip assignment when the filtered list is empty.

  - Ensure the keepalive path allows worker execution against the existing PR branch when keepalive_enabled == true.

  - Add a short “worker outcome” summary (and optionally a PR comment) echoing TRACE and the head commit SHA created by the worker.

Acceptance criteria

- On a test PR with agents:keepalive and agent:codex:

  1. A keepalive instruction comment (from Issue 1) triggers PR‑meta with ok: true, reason: ok, and the expected round and trace.

  2. Exactly one orchestrator run starts via workflow_dispatch carrying that TRACE; no previous run is canceled by this one.

  3. If any gate fails, the PR shows a single‑line comment in the format:
    **Keepalive {round}** \{trace}` skipped: <reason-code>` and the orchestrator step summary contains the same reason.

  4. If gates pass, the belt/worker runs and either produces a new commit or posts a PR comment that includes TRACE and the reason for not committing (e.g., “no code changes needed”).

  5. Running two consecutive keepalive rounds produces two distinct traces, two orchestrator runs, and no duplicate dispatches; no run is silently canceled.

Implementation notes

Secrets: use ACTIONS_BOT_PAT for dispatch; GITHUB_TOKEN is insufficient for cross‑workflow dispatch reliability in some contexts.

Author allow‑list: include stranske-automation-bot and designated humans (e.g., stranske).

Assignee enforcement: keep it strictly best‑effort; do not fail the sweep when only bot/app accounts remain.

Logging: use $GITHUB_STEP_SUMMARY for human‑readable status and PR one‑liners for traceable reasons.
