1. Agents keepalive: embed required hidden markers in keepalive comment body

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
The Agents PR meta manager workflow only treats a bot comment as a valid keepalive trigger when the comment body contains both hidden HTML markers:

<!-- keepalive-round: N -->

<!-- codex-keepalive-marker -->

Current keepalive comments are posted as plain text without these markers, so PR‑meta records reason=missing-sentinel/not-keepalive and does not dispatch the orchestrator. This issue adds the markers to every keepalive “Round N” instruction comment so PR‑meta can reliably detect and dispatch.

Scope

Update the keepalive poster (the step that creates the “Keepalive Round N” instruction comment) to always include:

<!-- keepalive-round: {roundNumber} -->
<!-- codex-keepalive-marker -->


before the visible content.

Continue to create a new comment (not edit) for each round.

Do not change acceptance criteria text, Gate logic, or how the scope/tasks are rendered.

Non‑Goals

Re‑enabling command listeners or changing dispatch events

Modifying agent selection, labels, or belt/worker behavior

Altering the visible wording of the instruction, other than inserting the two hidden markers

Tasks

- Update the keepalive poster in .github/workflows/agents-70-orchestrator.yml:

- Add the two hidden HTML markers at the top of the comment body, substituting the computed round number for {roundNumber}.

- Update `.github/workflows/agents-70-orchestrator.yml` so the Codex Keepalive Sweep step prepends the markers before the visible instruction text.

- Verify the step uses a token that posts as stranske-automation-bot.

- Ensure the poster uses create semantics (e.g., peter-evans/create-issue-comment@v3), not “edit,” so issue_comment.created fires.

- Confirm with a test PR:

- Create a keepalive round and verify that Agents PR meta manager logs reason=keepalive-detected and runs the Dispatch keepalive orchestrator job.

Acceptance criteria

- Every keepalive round comment contains:

<!-- keepalive-round: N -->
<!-- codex-keepalive-marker -->


- On issue_comment.created from stranske-automation-bot, Agents PR meta manager:

    - recognizes the comment as keepalive (reason=keepalive-detected),
    - emits repository_dispatch event_type codex-pr-comment-command,
    - runs Dispatch keepalive orchestrator (not skipped).
    - the Codex connector acknowledges the keepalive dispatch without manual intervention.
    - No duplicate dispatch occurs on issue_comment.edited.

Implementation notes

Likely touchpoints:

.github/workflows/agents-70-orchestrator.yml (Codex Keepalive Sweep step that posts the instruction), or

the helper that assembles the keepalive comment body (e.g., scripts/keepalive-runner.js if used).

Use the same PAT already used for bot-authored comments (posting as stranske-automation-bot).

Keep the visible instruction compatible with the connector's templating (preserve the "@{agent}" placeholder so downstream automation stays aligned).

Coordinate wording with the PR kickoff comment so both surfaces present a consistent call-to-action.

Keep the PR title prefix guidance aligned so the connector recognises the automation source on new pull requests.
Call out the `@{agent}` placeholder in the visible instruction so the PR kickoff comment automation stays aligned with the bootstrap "PR title prefix" guidance.

2. PR‑meta: re‑enable guarded listen_commands to emit Codex dispatch for keepalive rounds

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
Keepalive posts are detected, but no agent run starts because the translator that turns a PR comment into a Codex repository_dispatch is disabled. The listen_commands job in agents-pr-meta.yml is currently if: ${{ false }}, so neither bot nor human comments generate the codex-pr-comment-command dispatch the connector expects. This issue safely re‑enables listen_commands with strong guards so bot‑authored keepalive instructions (with the required hidden markers) trigger the dispatch, and accidental chatter does not.

Scope

Re‑enable the listen_commands job in .github/workflows/agents-pr-meta.yml for issue_comment.created on PRs.

Treat a comment as a valid activation only if:

  - author is allowed (stranske-automation-bot and approved human maintainers), and

  - the body contains both hidden markers:

    <!-- keepalive-round: {roundNumber} -->
    <!-- codex-keepalive-marker -->

When valid, emit:

  - repository_dispatch with event_type: codex-pr-comment-command

  - client_payload containing at least { issue: <PR number>, base, head, agent: "codex", comment_id, comment_url }

  - Use secrets.ACTIONS_BOT_PAT.

Non‑Goals

Changing belt/worker scheduling or Gate logic

Rewriting connector payload format beyond the fields above

Accepting edited comments as triggers (creation only)

Tasks

In .github/workflows/agents-pr-meta.yml:

  - Change listen_commands condition from if: ${{ false }} to run on issue_comment for PRs.

  - Add guards:

    - Author allow‑list (e.g., stranske-automation-bot plus designated maintainers).

    - Require presence of both hidden markers in the body.


Emit repos.createDispatchEvent with:

  - event_type: 'codex-pr-comment-command'

  - payload { issue, base, head, agent: 'codex', comment_id, comment_url }

  - token: secrets.ACTIONS_BOT_PAT.

Ignore issue_comment.edited.

Validation:

  - On a test PR with agents:keepalive and agent:codex, post a keepalive round (now containing the hidden markers from Issue 1).

  - Confirm PR‑meta → listen_commands runs and logs one successful dispatch.

  - Confirm the connector acknowledges and begins work (or that the intended downstream workflow triggers off the dispatch).

Acceptance criteria

- For a keepalive comment created by stranske-automation-bot that includes both hidden markers:

  - listen_commands runs and emits exactly one repository_dispatch with type codex-pr-comment-command.

  - The event contains { issue, base, head, agent: "codex", comment_id, comment_url }.

  - No dispatch is emitted for edited comments or for comments missing the markers.

  - A test PR shows two successive keepalive rounds both result in properly emitted dispatches without duplicates.

Implementation notes

File: .github/workflows/agents-pr-meta.yml

Token: ACTIONS_BOT_PAT (must have repo + workflow).

- Include the literal `@{agent}` placeholder in the repository_dispatch payload so the PR kickoff comment automation maps the request to the correct worker.
- Keep the bootstrap “PR title prefix” guidance aligned with the orchestrator comment so downstream tooling stays in sync with the PR kickoff comment copy.

If you later choose to drive dispatch directly from the keepalive sweep instead, open a separate issue to track that alternate path and keep this translator disabled to avoid double‑dispatch.
