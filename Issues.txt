1) Fix import shadowing: rename joblib.py to avoid hijacking third‑party joblib

Labels: bug, refactor, backend, priority: high

Summary
The repository includes a top‑level joblib.py. Any import joblib will import this local file rather than the package, causing hard‑to‑diagnose failures. Rename the file and fix local imports. Context: joblib.py exists at repo root. 
GitHub

Why it matters
Shadowing a core dependency breaks caching/parallelization quietly and inconsistently across environments.

Scope / Tasks

 Rename joblib.py to joblib_shim.py (or remove if unused).

 Grep for import joblib and ensure they import the real package. If the local code is needed, update to from .joblib_shim import ... or relocate into src/....

 Add a safety test: assert "site-packages" appears in joblib.__file__ at runtime.

Acceptance criteria

Importing joblib resolves to the third‑party package across app, CLI, tests.

CI tests (local) confirm joblib.__file__ path is outside the repo.

Out of scope
Performance tuning or swapping joblib for alternatives.

2) Contain global side effects: relocate/gate sitecustomize.py

Labels: bug, config, priority: high

Summary
sitecustomize.py at the repo root is auto‑imported by Python if the repo is on PYTHONPATH. Move it under src/trend_model/_sitecustomize.py and require an explicit opt‑in env var before any code runs. Context: sitecustomize.py exists at repo root. 
GitHub

Scope / Tasks

 Move file to src/trend_model/_sitecustomize.py or delete if obsolete.

 If behavior is still needed, guard with if os.getenv("TREND_MODEL_SITE_CUSTOMIZE") == "1": ....

 Add a unit test that ensures importing a random module does not execute any repo global side effects.

Acceptance criteria

No implicit imports or side effects occur just by importing the package.

Running tests shows zero references to top‑level sitecustomize.py.

3) Define the public API: TrendSpec, SignalFrame, BacktestSpec, BacktestResult

Labels: engine, enhancement, refactor

Summary
Introduce four dataclasses that become the only inputs/outputs across library, CLI, and app. This stabilizes interfaces and reduces copy‑paste parameter drift.

Scope / Tasks

 Add TrendSpec (model params: lookbacks, vol adjustment, execution lag, rebalance frequency, TC bps default, etc.).

 Add SignalFrame wrapper (DataFrame with columns: signal, vol_target, optional confidence, plus index alignment to prices).

 Add BacktestSpec (evaluation params: rolling vs expanding, rebalancing calendar, TC model, cash rate, position limits).

 Add BacktestResult (returns, equity, drawdown, exposures, turnover, summary stats).

 Update downstream functions to accept these objects rather than ad‑hoc dicts.

Acceptance criteria

A minimal end‑to‑end run uses only TrendSpec + BacktestSpec and yields a BacktestResult.

App and CLI call the same public API in src/trend_model/.

4) Enforce a data contract at ingest (CSV, Parquet, DataFrame)

Labels: data, enhancement, documentation

Summary
Hard‑fail early on schema problems: index monotonicity, duplicate timestamps, return vs price mode, symbol presence, and frequency.

Scope / Tasks

 Implement validate_market_data(data: DataFrame) -> DataFrame with checks: sorted Date index, no dupes, consistent frequency, and either price or return mode clearly inferred.

 Decide simple dependency: pandera for DataFrame schema or pydantic for record‑level schema; document the choice.

 Integrate into app upload flow and CLI input path with clear error messages.

Acceptance criteria

Invalid uploads surface a single, descriptive error banner in the app; CLI exits non‑zero with the same message.

Validation runs automatically before any modeling.

5) Frequency detection and missing‑data policy

Labels: data, pipeline, enhancement

Summary
Detect daily/weekly/monthly automatically. Force a policy for missing data per asset (drop, FFILL with max window, or zero return). Show the choice in the final report.

Scope / Tasks

 Implement detect_frequency(index) -> Literal["D","W","M"] with tolerance for holidays and short months.

 Implement apply_missing_policy(df, policy, limit) with per‑asset option.

 Add a one‑liner summary to the report of frequency and NA policy.

Acceptance criteria

Backtests are consistent no matter the input frequency, with a visible record of the policy applied.

6) One signal engine to rule them all

Labels: engine, enhancement

Summary
Unify trend extraction variants behind signals.py. Enforce lag discipline by construction.

Scope / Tasks

 Implement baseline time‑series momentum with optional vol‑adjustment and z‑score normalization.

 Enforce execution lag by shifting the signal prior to rebalance_date.

 Return SignalFrame with consistent columns and index alignment.

Acceptance criteria

Swapping parameters in TrendSpec changes behavior without touching downstream code.

All signals pass a unit test that forbids look‑ahead.

7) Lightweight risk engine: vol targeting, turnover caps, max weights

Labels: weights, engine, enhancement

Summary
Add a small risk.py that standardizes volatility targeting and basic constraints.

Scope / Tasks

 Vol targeting: compute realized vol per asset and scale to portfolio target.

 Constraints: turnover cap per rebalance, max position weight, long‑only toggle, sum‑to‑one normalization.

 Produce a diagnostic panel: realized vol and turnover series.

Acceptance criteria

Risk controls are applied the same way in CLI and app.

Report includes turnover and realized vol charts.

8) Honest backtesting harness: walk‑forward, costs, and calendar

Labels: engine, pipeline, testing, enhancement

Summary
Create backtest.py with rolling/expanding windows and a fixed rebalancing calendar. Include a simple transaction cost model.

Scope / Tasks

 Implement calendar logic for rebalance frequency.

 Implement transaction cost model (bps per trade) applied to absolute changes in weights.

 Return BacktestResult with rolling Sharpe, drawdown, CAGR, vol, Sortino, Calmar.

Acceptance criteria

Changing from expanding to rolling materially changes outcomes; tests verify no look‑ahead.

A JSON summary of metrics can be emitted for the app to consume.

9) Bootstrap uncertainty bands for the equity curve

Labels: engine, ui, enhancement

Summary
Add block bootstrap to estimate uncertainty around the cumulative return path.

Scope / Tasks

 Implement bootstrap_equity(result: BacktestResult, n=500, block=20) returning median and 5–95% band.

 App toggle to display the band on the main chart.

Acceptance criteria

Bands appear in the app and export correctly in the report.

10) One report builder (HTML/PDF) shared by CLI and app

Labels: exports, documentation, ui, enhancement

Summary
Single report generator producing HTML and optional PDF with the same content users see in the app.

Scope / Tasks

 Sections: executive summary; metrics table; turnover/exposure charts; parameter summary; caveats.

 Deterministic narrative paragraph from BacktestResult and specs (no LLM).

 CLI --output path and Streamlit “Download report” button.

 Include a small “Past performance…” footer.

Acceptance criteria

Running the CLI produces an HTML report identical to the app download.

11) Make the Streamlit app the front door

Labels: streamlit, ui, enhancement

Summary
Restructure the app into three screens, add a sample dataset default, cache expensive steps, and polish error handling.

Scope / Tasks

 Pages: Data (upload or sample + validation results), Model (compact TrendSpec form with presets), Results (equity, drawdown, rolling Sharpe, turnover, exposures).

 Default sample dataset path points to repo sample data.

 Use st.cache_data for loads/transforms; clear banners for validation failures.

 Consistent chart style and palette across pages.

Acceptance criteria

A non‑technical user can upload a CSV and get a report without touching Python.

No stack traces are shown to users; errors are summarized in plain English.

Context
streamlit_app/ already exists; this issue formalizes it as the primary UX. 
GitHub

12) Add two strategy presets: “Conservative” and “Aggressive”

Labels: engine, enhancement, ui

Summary
Ship two named presets wired to TrendSpec so users don’t face a wall of sliders.

Scope / Tasks

 Define preset parameter sets in a small registry.

 Surface preset selector in the app and CLI.

Acceptance criteria

Selecting a preset updates forms and parameters consistently across app and CLI.

13) Regime tagging and breakdown table

Labels: engine, enhancement

Summary
Tag months as risk‑on/off using a simple market filter and show performance by regime.

Scope / Tasks

 Implement regime tagging (e.g., sign of rolling market return or vol threshold).

 Add a table to the report showing performance by regime.

Acceptance criteria

Report highlights when the strategy tends to work or struggle.

14) CLI: trend-app and trend-run

Labels: config, documentation, enhancement

Summary
Provide a console entry point for the app and a headless runner that reads a config and produces a report.

Scope / Tasks

 In pyproject.toml, add scripts:

trend-app = trend_model.app:main (launches Streamlit entry)

trend-run = trend_model.cli:run (reads a TOML/YAML config, runs backtest, writes report)

 Add docs/CLI.md with examples.

Acceptance criteria

pip install -e . then trend-app launches the GUI; trend-run -c config/trend.toml -o reports/run.html produces a report.

Context
pyproject.toml is present in the repo. 
GitHub

15) Standardize config: TOML spec for model and backtest

Labels: config, documentation, enhancement

Summary
Use a single config file format feeding directly into TrendSpec and BacktestSpec.

Scope / Tasks

 Create config/trend.toml example with comments.

 Implement loader that validates and instantiates the dataclasses.

 Render the resolved spec into the report for provenance.

Acceptance criteria

App and CLI both accept the same config file and produce identical runs.

16) Move sample data under data/raw and wire the app default path

Labels: data, documentation

Summary
Reduce root clutter and make sample data easy to discover.

Scope / Tasks

 Move Trend Universe Data.csv, hedge_fund_returns_with_indexes.csv, and similar into data/raw/.

 Update app “Use sample dataset” to point there.

Acceptance criteria

No CSVs remain at repo root; app “sample” loads successfully.

Context
Those CSVs currently live at the repo root. 
GitHub

17) Tests that matter: E2E, NA‑robustness, and spec round‑trip

Labels: tests, testing

Summary
Keep tests focused on behavior, not internals.

Scope / Tasks

 E2E: CSV → validate → signals → backtest → report; assert key metrics exist and are reasonable.

 NA‑robustness: inject NaNs and confirm the app path renders results without crashing.

 Spec round‑trip: serialize/deserialize TrendSpec and BacktestSpec from TOML unchanged.

Acceptance criteria

All three tests pass locally.

Regressions in data validation or reporting are caught.

Context
There are already tests like test_multi_period_selection.py and test_upload_app.py in the repo. 
GitHub

18) Optional fast‑path: Polars acceleration behind a feature flag

Labels: backend, enhancement

Summary
Offer optional polars implementations for the heaviest transforms when users have large universes.

Scope / Tasks

 Add a small adapter layer: TREND_USE_POLARS=1 to enable, otherwise default to pandas.

 Implement fast versions of rolling stats and joins used in signals and backtest.

Acceptance criteria

Enabling the flag yields identical outputs to pandas within tolerance on sample data.
