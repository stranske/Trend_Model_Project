1. Keepalive parallelism: capâ€‘aware concurrency (default 2), no unintended serialization, perâ€‘comment dedupe, and â€œlastâ€‘greenâ€ Gate window

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
Weâ€™re seeing only one run at a time even when agents:keepalive and Gate are satisfied. Root causes are likely: (1) activeâ€‘run counting that overâ€‘counts (serializing runs), (2) a tooâ€‘coarse concurrency group, and (3) a Gate policy that forces a fresh Gate cycle between backâ€‘toâ€‘back instructions on the same unchanged head SHA.

Scope

- Activeâ€‘run counting: compute active as the number of Orchestrator (and optionally Worker) runs for this PR only with status âˆˆ {queued, in_progress}. Do not count PRâ€‘meta, status jobs, or other PRs.

- Cap: default cap = 2; allow override via label agents:max-runs:X (X âˆˆ 1..5).

- Concurrency: set Orchestrator concurrency.group = "pr-${PR}-agent-${ALIAS}", cancel-in-progress: false. PRâ€‘meta may keep a PRâ€‘wide group as long as it does not cancel inâ€‘flight.

- Perâ€‘comment dedupe: PRâ€‘meta dedupes only by the current comment id (via ğŸš€ reaction). No PRâ€‘wide locks.

- Gate window: treat Gate conclusion=success on the current head SHA as valid for launching up to cap parallel runs on that unchanged SHA (no extra Gate cycle required between the first and second instruction if the head didnâ€™t move).

- Observability (no PR noise): print one line to $GITHUB_STEP_SUMMARY showing cap and active for each gate evaluation.

Nonâ€‘Goals

Changing acceptance criteria, Gate internals, or adding new agent types

Any connector configuration changes

Tasks

- Gate helper (.github/scripts/keepalive_gate.js)

  - Implement countActive({ prNumber, agentAlias? }) that lists Orchestrator (and, if needed, Worker) runs only, filters to this PR (use inputs.options_json.pr or head ref pattern), and counts queued + in_progress.

  - Default cap = 2; read override from label agents:max-runs:X (clamp 1..5).

  - Expose outputs: { ok, reason, cap, active, primaryAgent, headSha, lastGreenSha }.

- Orchestrator (.github/workflows/agents-70-orchestrator.yml)

  - Set concurrency:
    concurrency:
      group: pr-${{ env.PR_NUMBER }}-agent-${{ env.AGENT_ALIAS }}
      cancel-in-progress: false


  - Before posting an instruction, call the gate helper; block when active >= cap.

- PRâ€‘meta (.github/workflows/agents-pr-meta.yml)

  - Deduplicate strictly per comment id (ğŸš€ on that comment).

  - Gate before dispatch; allow lastâ€‘green window when headSha === lastGreenSha.

- Summary line: in both workflows, always print:
  GATE: ok=<bool> reason=<code> pr=#<n> agent=<alias> cap=<cap> active=<active> head=<sha7>


Acceptance criteria

- On a test PR with agents:max-runs:2, two instruction comments posted close together start two Orchestrator runs (no cancellations); gate summaries show active: 0 â†’ 1 â†’ 2.

- A third instruction while both are active is blocked (no comment/dispatch), summary shows reason=run-cap-reached.

- PRâ€‘meta dedupes by comment id only; separate comments process independently.

- Gate is considered satisfied for multiple instructions off the same unchanged, lastâ€‘green head SHA.

Implementation notes

Filter runs by orchestrator workflow id/name to avoid counting PRâ€‘meta and status jobs.

If Worker is a separate workflow, you may include it in active (document the choice in the summary).

No PR comments are added for gate failures; use summaries only.

2. Keepalive: make branchâ€‘sync a blocking gate â€” try update-branch, then create-pr + autoâ€‘merge, else label agents:sync-required and block Roundâ€¯N+1

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
After an agent â€œdoneâ€ response, the PR head often doesnâ€™t change; you have to click Update Branch (or Create PR) on the Codex site. We need a headless, blocking sequence that lands the agentâ€™s work before the next instruction, or cleanly pauses with agents:sync-required.

Scope

- When: After a round completes and before posting the next instruction.

- If head SHA unchanged since the instruction was posted:

  - Try updateâ€‘branch via repository_dispatch (exact event type/payload the connector supports); poll PR head for â‰¤ 2â€“5 min.

  - If still unchanged, try createâ€‘pr, then autoâ€‘merge the created PR into the working branch (squash/ff), poll again.

  - If still unchanged, apply agents:sync-required and do not post Roundâ€¯N+1.

- Observability (no PR noise): print one line to $GITHUB_STEP_SUMMARY with action and outcome.

Nonâ€‘Goals

Changing moderation rules for connector comments

Turning off quiet: true / reply: 'none' flags in dispatch (keep them)

Tasks

- Orchestrator postâ€‘work step:

  - Capture head_sha_at_instruction. After agent â€œdoneâ€, compare to current head_sha.

  - If unchanged â†’ call a helper (e.g., .github/scripts/keepalive_post_work.js) that:

    - emits repoâ€‘dispatch for update-branch (event_type and payload fields the connector actually supports), polls the PR head;

    - if unchanged â†’ emits repoâ€‘dispatch for create-pr, then autoâ€‘merges the PR using ACTION_BOT_PAT, polls again;

    - if unchanged â†’ adds agents:sync-required and returns escalate;

    - sets outputs { action, changed }.

  - If changed: false â†’ exit without posting next instruction.

- Summary line:
  SYNC: action=<update-branch|create-pr|escalate|skip> head_moved=<true|false> trace=<trace>

Acceptance criteria

- In a test where the agent doesnâ€™t push, the workflow attempts update-branch; if head moves, posts Roundâ€¯N+1; otherwise tries create-pr + autoâ€‘merge; if head moves, posts Roundâ€¯N+1; otherwise labels agents:sync-required and does not post Roundâ€¯N+1.

- No human clicks are needed; no PR noise (only summaries).

- When branchâ€‘sync succeeds, Roundâ€¯N+1 never repeats the previous work.

Implementation notes

Confirm connector contract: if the connector doesnâ€™t honor repoâ€‘dispatch for these actions, implement a commentâ€‘command fallback issued as stranske (e.g., /update-branch, then /create-pr) while keeping the moderation workflow to delete any connector replies.

Use ACTION_BOT_PAT for autoâ€‘merge; whitelist and redact any connector URLs.

3. Keepalive: eliminate duplicate round comments (single source of truth) while preserving stranskeâ€‘automationâ€‘bot posts; unambiguous instruction detection by markers + id

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
Itâ€™s acceptable for stranskeâ€‘automationâ€‘bot to author comments; however, we occasionally see duplicated round content (one from the bot and one from stranske). Duplication confuses detection and users. We need a lowâ€‘risk cleanup that keeps the current behavior but ensures only one comment per round is treated as the instruction, and that the other (status) never triggers a new round.

Scope

- Instruction source of truth: Only comments that (a) are created (not edited), (b) include the three hidden markers plus TRACE, and (c) have an idempotency key (e.g., reaction keepalive-instruction) are treated as instructions.

- Status/summary comments (including edited bot comments) must not be considered instructions.

- No functional change to who authors (bot is fine), but ensure only one instruction comment per round and detection is unambiguous.

Nonâ€‘Goals

Changing which identity posts (human vs bot)â€”we will not switch authorship in this issue

Editing/moderating the status updater logic beyond excluding it from instruction detection

Tasks

- PRâ€‘meta detection

  - Match only issue_comment.created events where the comment body contains:

    <!-- keepalive-round: N -->,
    <!-- codex-keepalive-marker -->,
    <!-- keepalive-trace: ... -->.

  - Immediately add a distinct reaction (e.g., ğŸ¯) to mark it as â€œinstruction processedâ€ (separate from ğŸš€ used for dedupe if you prefer).

  - Ignore edited comments and any comments missing the full marker set (e.g., status summary).

- Poster (Orchestrator)

  - Post only one instruction comment per round. Use the same TRACE in the hidden markers and in your stepâ€‘summary; after posting, add the ğŸ¯ reaction yourself (idempotency) to guard against doubleâ€‘posts in retries.

- Summary line for detection:
  INSTRUCTION: comment_id=<id> trace=<trace> source=<stranske|bot> seen=<true|false> deduped=<true|false>

Acceptance criteria

- Each round results in exactly one instruction comment (created, not edited) that contains the three hidden markers + TRACE.

- Status/summary comments never trigger PRâ€‘meta detection (no duplicate launches).

- Detection marks the instruction with a distinct reaction and prints the oneâ€‘line summary; retries do not create additional instruction comments.

Implementation notes

This keeps both identities working but avoids duplicate processing by making the instruction contract unambiguous (markers + comment id + reaction).

If you prefer not to add a new reaction, you can reuse ğŸš€ strictly for the instruction idempotency and use PRâ€‘meta run success as the ACK.

No PR noise: donâ€™t post explanatory comments unless a debug label (e.g., agents:debug) is present.
