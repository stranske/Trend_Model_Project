1.Keepalive finalization: silence connector comments (without affecting stranske posts) + robust ACK + strict Gate=success + perâ€‘PR runâ€‘cap + branchâ€‘sync hard gate + deterministic scope extraction + quiet/noâ€‘noise

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why

The connector (e.g., chatgpt-codex-connector[bot]) sometimes posts comments that clutter the thread or collide with instruction flow. We want to prevent connector-authored comments while preserving automation posts authored as stranske (using ACTION_BOT_PAT) so the agent still acts on humanâ€‘authored instructions.

We still hit timing races and occasional content gaps:

Orchestrator sometimes misses PRâ€‘metaâ€™s ACK within TTL and fires a fallback dispatch even though ACK arrives seconds later.

Some instruction rounds render â€œNo scope information availableâ€, weakening prompts.

Gate needs to be enforced as conclusion=success for the current head SHA (not just â€œcompletedâ€).

Branchâ€‘sync must be a blocking gate before Roundâ€¯N+1.

We must keep the PR quiet when gates fail (step summaries only), and keep a runâ€‘cap (default 2; labelâ€‘driven override).

This issue delivers those corrections without expanding scope.

Scope

Implement the following, and only the following:

- Silence the connectorâ€™s PR comments while preserving all posts authored by stranske:

- Do not send connector commentâ€‘based command prompts anymore (repositoryâ€‘dispatch only).

- Add a â€œmoderate connector commentsâ€ workflow: on issue_comment.created, if author âˆˆ { chatgpt-codex-connector[bot] } (extensible allow/deny lists), delete the comment using the human PAT, unless a debug label (e.g., agents:debug) is present.

- If the connector supports a â€œquietâ€ flag in repository_dispatch payload, set it; otherwise rely on autoâ€‘delete as above.

- Instruction author & creation:

    - Post the instruction as stranske using ACTION_BOT_PAT; fallback to SERVICE_BOT_PAT only if missing.

    - Create a new instruction comment (never edit). Body must begin with the three hidden markers + TRACE, then @<agent> derived from agent:* labels, then the Scope/Tasks/AC block.

- PRâ€‘meta & Orchestrator preâ€‘gates (both paths):

  - Require agents:keepalive label.

  - First activation: require a human @<agent> (where <agent> is from agent:* labels). When the gate passes the first time, autoâ€‘apply agents:activated; later rounds must not require another human comment.

  - Gate strictness: for the PRâ€™s current head SHA, Gate.status='completed' && Gate.conclusion='success'.

  - Perâ€‘PR runâ€‘cap: default 2; override by label agents:max-runs:X (X=1..5). Count only this PRâ€™s Orchestrator/Worker runs in {queued,in_progress}.

  - No noise: if any gate fails, post no PR comment; write a oneâ€‘line reason to $GITHUB_STEP_SUMMARY.

  - ACK robustness:

  - Orchestrator should wait up to ~120â€“180s for PRâ€‘metaâ€™s ACK (ğŸš€ reaction) on the exact instruction comment id containing the same TRACE; treat a fresh, successful PRâ€‘meta run for that comment as equivalent ACK; only then consider fallback dispatch.

  - Branchâ€‘sync hard gate (before Roundâ€¯N+1):

  - If PR head SHA unchanged after a â€œdoneâ€ round, attempt updateâ€‘branch (repoâ€‘dispatch/recognized command); if still unchanged, attempt createâ€‘pr + autoâ€‘merge; if still unchanged, apply agents:sync-required and do not post the next instruction.

- Deterministic Scope/Tasks/AC extraction:

  - When rendering the instruction body, source the block in this order: (1) PR body ### Keepalive checklist â†’ (2) linked Source Issue body â†’ (3) most recent Automated Status Summary comment. If none found, insert a short placeholder and retry next round; never omit hidden markers.

- Branchâ€‘protection GraphQL:

  - If the â€œUpsert PR body sectionsâ€ step requires branchâ€‘protection info, use ACTION_BOT_PAT for that GraphQL call; otherwise guard it and skip cleanly if unauthorized.

Nonâ€‘Goals

Changing acceptance criteria content or Gateâ€™s internal tests

Altering belt/worker code beyond preâ€‘gate call and branchâ€‘sync gate placement

Introducing new secrets (use existing: ACTION_BOT_PAT preferred; SERVICE_BOT_PAT fallback)

Replacing ACK dedupe or the status/checklist updater

Tasks
- Silence connector comments (but keep stranske posts)

  - Stop commentâ€‘based prompts to the connector (keep repositoryâ€‘dispatch only).

  - Add a workflow .github/workflows/agents-moderate-connector.yml:

  - on: issue_comment: [created]

  - If comment.user.login âˆˆ denyâ€‘list (start with chatgpt-codex-connector[bot]) and PR lacks agents:debug:

  - Delete the comment via REST issues.deleteComment using ACTION_BOT_PAT.

  - Write a brief line to $GITHUB_STEP_SUMMARY (no PR noise).

  - Allowlist maintainers and stranske/automation bot explicitly.

  - Add a quiet: true / reply: 'none' field to the repository_dispatch payload if the connector supports it (optional; harmless if ignored).

- Instruction author & creation

  - In Orchestratorâ€™s poster, prefer ACTION_BOT_PAT (author=stranske), else fallback SERVICE_BOT_PAT.

  - Create a new comment (never edit) with required markers + TRACE + @<agent> + Scope/Tasks/AC; capture comment_id & comment_url; write a summary line.

- Preâ€‘gates in PRâ€‘meta & Orchestrator

  - Call the shared gate helper before any detection/dispatch (PRâ€‘meta) and before any instruction posting (Orchestrator).

  - Firstâ€‘run only requires a human @agent. If gate passes and agents:activated is absent â†’ add label via ACTION_BOT_PAT.

  - Enforce: Gate.conclusion='success' on head SHA; runâ€‘cap (label override); presence of agents:keepalive.

  - On failure: no PR comment; write the oneâ€‘liner to $GITHUB_STEP_SUMMARY.

- Robust ACK

  - Orchestrator waits up to 120â€“180s; poll for ğŸš€ on that comment id and confirm keepalive-trace: {TRACE} is present; also treat a new successful PRâ€‘meta run that started after the comment time as an ACK.

  - Only if no ACK by deadline, emit the fallback dispatch; note outcome in summary.

- Branchâ€‘sync gate (blocking)

  - After â€œdoneâ€, if head SHA unchanged:

  - Try updateâ€‘branch; poll for head change (TTL short).

  - If still unchanged, try createâ€‘pr + autoâ€‘merge; poll again.

  - If still unchanged, add agents:sync-required; do not post Roundâ€¯N+1; summary only.

- Deterministic Scope/Tasks/AC extraction

  - Implement the 3â€‘stage fallback (PR body â†’ Source Issue â†’ last Summary).

  - Never omit hidden markers; if all sources fail, insert placeholder + retry flag.

- Branchâ€‘protection GraphQL

  - Use ACTION_BOT_PAT for the GraphQL call; on 403, skip quietly (no PR noise).

Acceptance criteria

- Connector comments are gone: when the connector attempts to comment, the moderation workflow deletes it unless agents:debug is present; posts authored by stranske remain untouched.

- Instruction comments are authored by stranske (PAT present) or by the automation bot only on fallback; always created (not edited) and begin with the three hidden markers + TRACE + @<agent>.

- Preâ€‘gates work in both paths: with agents:keepalive + first human @agent + Gate success + under cap, PRâ€‘meta/Orchestrator proceed; otherwise no PR comment is posted, and the run summary shows the oneâ€‘line reason.

- agents:activated is autoâ€‘applied on first valid activation; later rounds do not require a new human @agent.

- ACK: Orchestrator observes ACK (ğŸš€ or PRâ€‘meta success) within the extended window in normal cases; fallback dispatch triggers only when ACK truly never arrives.

- Branchâ€‘sync hard gate: when the agent â€œdoneâ€ round didnâ€™t move the head SHA, the system performs updateâ€‘branch â†’ createâ€‘pr+merge as needed; if still unchanged, applies agents:sync-required and suppresses Roundâ€¯N+1.

- Scope/Tasks/AC: every instruction contains a nonâ€‘empty block sourced via the 3â€‘stage fallback; no â€œNo scopeâ€¦â€ posts.

- Strict Gate: keepalive posts/dispatches occur only when Gate succeeds on the current head SHA.

- Quiet when blocked: on missing label, missing firstâ€‘run human @agent, Gate not success, cap reached, or sync unresolved, no PR comments are posted; the reason appears only in the run summary.

Implementation notes

Secrets: use existing ACTION_BOT_PAT (preferred) and SERVICE_BOT_PAT only.

Deny/allow lists for moderation: start with deny { chatgpt-codex-connector[bot] }; allow { stranske, stranske-automation-bot, maintainers }; make both lists configurable at the top of the workflow.

Repositoryâ€‘dispatch payload: keep your current shape; add an optional quiet: true flag if the connector recognizes it.

Gate helper: expose outputs { ok, reason, cap, active, hasKeepaliveLabel, hasActivatedLabel, primaryAgent } so both workflows can write the same oneâ€‘line summary:

GATE: ok=<bool> reason=<code> pr=#<n> agent=<alias> cap=<cap> active=<active> head=<sha7>


No PR noise: donâ€™t post explanatory comments unless a debug label (e.g., agents:debug) is present.
