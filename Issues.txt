1. Keepalive PRâ€‘meta: Gate replay must always evaluate a real activation; print mandatory oneâ€‘line DISPATCH summary for comment and gate lanes

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
On some PRs the activationâ†’dispatch hop doesnâ€™t fire because the Gate lane requires activation_comment to be prefilled and silently skips if it isnâ€™t. Also, when either lane (comment/gate) decides to skip, thereâ€™s no standardized, machineâ€‘readable reason in the run summaryâ€”making diagnosis and AC verification hard.

Scope

- In .github/workflows/agents-pr-meta.yml:

  - Gate lane: if activation_comment is empty, fetch the mostâ€‘recent human @agent activation comment on the PR and pass it to detection (fallback).

  - Both lanes (comment & gate): after the decision, always write a singleâ€‘line DISPATCH summary to $GITHUB_STEP_SUMMARY (even on skip).

  - When the instruction segment is missing/empty, fail the job with reason=instruction-empty (no silent success).

- Do not change label policy, reactionâ€‘lock behavior, runâ€‘cap numbers, or connector settings.

Nonâ€‘Goals

No edits to orchestrator/worker

No change to acceptance criteria content or Gate internals

No changes to moderation workflows

Tasks

- Gate replay fallback (githubâ€‘script)

  - In the Gate lane, before detection, if steps.gate.outputs.activation_comment == '' then:

    - Resolve pr_number from workflow_run.pull_requests[0].number (fallback to matching by head SHA if needed).

    - List PR comments; pick the most recent comment where:

      - author type is human (not a bot), and

      - body contains an allowed agent mention (@codex, @claude, â€¦), and

      - body does not contain the keepalive hidden markers.

    - Expose that comment JSON as activation_comment for the existing detection step.

  - Reaction lock before dispatch

    - On the activation_comment.id, add ðŸš€. If already present (409), skip dispatch (reason lock-held).

  - Instruction guard

    - If detection yields an empty instruction segment, do not dispatch; fail with reason instruction-empty.

  - Mandatory decision summary (both lanes)

    - After the decision (dispatch or skip), write exactly one line to $GITHUB_STEP_SUMMARY:
      DISPATCH: ok=<true|false> path=<comment|gate> reason=<ok|missing-label|no-human-activation|gate-pending|gate-failed|cap-reached|no-linked-pr|no-activation-found|lock-held|instruction-empty> pr=#<n> activation=<comment_id|none> agent=<alias> head=<sha7> cap=<k>/<c> trace=<trace|->

Acceptance criteria

- With a prior human @agent comment and Gate success, a Gateâ€‘triggered PRâ€‘meta run always prints a DISPATCH: line with path=gate and either ok=true (and orchestrator starts) or a precise reason (e.g., cap-reached, lock-held, no-activation-found).

- When a human @agent comment is posted (comment lane), PRâ€‘meta prints a DISPATCH: line with path=comment showing ok=true or a precise reason.

- If the instruction segment is missing, the job fails with reason=instruction-empty (no silent success).

Implementation notes

Keep reactionâ€‘lock behavior unchanged; this issue only ensures replay always brings a concrete activation into detection and that decisions are visible.

The summary line must be printed even on skip and must include cap/active, head, and activation id.

2. Keepalive PRâ€‘meta: enforce runâ€‘cap at dispatch edge using orchestrator runs in {queued,in_progress} for this PR; print cap/active in summary

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
Bursts happen when multiple PRâ€‘meta instances evaluate the cap before any orchestrator run flips to in_progress. The cap must count queued + in_progress orchestrator runs for this PR at the dispatch edge, and the decision must be visible.

Scope

- In .github/workflows/agents-pr-meta.yml (both lanes, before dispatch):

  - Compute active = number of Agents 70 Orchestrator runs for this PR with status âˆˆ {queued, in_progress}.

    - If active â‰¥ cap (default 2, label override agents:max-runs:X with clamp 1..5) â†’ do not dispatch.

    - Append cap=<cap> active=<active> to the DISPATCH: summary line from Issue 1.

Nonâ€‘Goals

No changes to orchestrator concurrency (already handled by Option A)

No change to cap default/labels

No edits to worker/branchâ€‘sync

Tasks

- Activeâ€‘run query (githubâ€‘script)

  - List runs for the orchestrator workflow twice (status=queued and status=in_progress).

  - Filter to this PR using a PRâ€‘scoped discriminator you already control (e.g., the orchestratorâ€™s concurrency.group includes the PR number, or the run name/title embeds #<PR>).

  - Compute active and resolved cap.

- Cap gate

  - If active â‰¥ cap â†’ set decision ok=false reason=cap-reached and skip dispatch.

- Summary

  - Ensure the DISPATCH: line includes cap=<cap> active=<active>.

Acceptance criteria

- On a test PR with agents:max-runs:2, two nearâ€‘simultaneous dispatch attempts succeed; a third prints DISPATCH: ok=false reason=cap-reached â€¦ cap=2 active=2 and does not dispatch.

- The DISPATCH: line always shows accurate cap/active.

Implementation notes

Filter by workflow id/name to avoid counting PRâ€‘meta/status jobs.

Use the same counting function in both lanes to avoid drift.

3. Keepalive Orchestrator: enforce author invariant (post as stranske or fail) and print mandatory INSTRUCTION, WORKER, SYNC lines in job summary

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
When the roundâ€‘start instruction is posted by the automation bot, some external agents ignore it and no code is produced. Also, without invariant oneâ€‘line summaries, itâ€™s hard to prove the orchestrator actually posted, executed, and synced.

Scope

- In .github/workflows/agents-70-orchestrator.yml:

  - Author invariant: Before posting the instruction, assert the selected token is ACTIONS_BOT_PAT (post as stranske). If not, fail the step and do not post.

  - After posting, print an INSTRUCTION: line; before/after worker, print WORKER: and SYNC: lines to $GITHUB_STEP_SUMMARY (always, even when skipping).

Nonâ€‘Goals

No change to runâ€‘cap logic in orchestrator (PRâ€‘meta controls cap at dispatch edge)

No change to branchâ€‘sync algorithm

No change to instruction text or hiddenâ€‘marker protocol

Tasks

- Author assertion

  - Resolve the posting token (ACTIONS_BOT_PAT preferred; SERVICE_BOT_PAT fallback).

  - If ACTIONS_BOT_PAT is not selected, fail the post step and write:
    INSTRUCTION: ok=false reason=wrong-author token=<SERVICE_BOT_PAT|github.token> head=<sha7> trace=<trace>

- Instruction summary

  - After a successful post + ACK, write:
    INSTRUCTION: ok=true author=stranske comment=<id> ack=<ok|fail> head=<sha7> trace=<trace>

- Worker summary

  - Before executing worker logic, decide execute vs skip using your new guard (new instruction vs head unchanged).

  - Write:
    WORKER: action=<execute|skip> reason=<new-instruction|no-new-instruction-and-head-unchanged|cap-reached|...> pr=#<n> head=<sha7> instr=<comment_id> trace=<trace>

- Branchâ€‘sync summary

  - After branchâ€‘sync gate, write:
    SYNC: action=<update-branch|create-pr|escalate|skip> head_changed=<true|false> trace=<trace>

Acceptance criteria

- Orchestrator fails fast if it would post as the bot (no instruction posted; INSTRUCTION: ok=false reason=wrong-author â€¦).

- On a successful round: INSTRUCTION ok=true author=stranske, followed by WORKER action=execute, and a SYNC line reflecting the action taken.

- On a skipped worker: WORKER action=skip reason=no-new-instruction-and-head-unchanged.

- The three summary lines appear on every orchestrator run.

Implementation notes

Keep your existing ACK logic; just surface the result in INSTRUCTION:.

Do not post any of these summaries as PR commentsâ€”summary only.

4. CI guardrail: validate GitHub workflow files on PRs to block merges with YAML parse/annotation errors

Labels: ci, automation, enhancement

Why
A single topâ€‘level expression error previously invalidated the orchestrator workflow and blocked keepalive entirely. We want a fastâ€‘failing check that prevents merges when any workflow is invalid.

Scope

- Add a small CI workflow (e.g., .github/workflows/validate-workflows.yml) that runs on pull_request and push to default branch and:

  - Lints/parses all files under .github/workflows/*.yml

  - Fails if GitHubâ€™s workflowâ€‘parser annotations indicate an error (or if act/actionlint reports an error)

Nonâ€‘Goals

No behavior changes to existing workflows

No changes to keepalive logic

Tasks

- Add validator workflow

  - Use rhysd/actionlint (or a pinned container) to parse all workflow YAMLs.

  - Optionally run a quick dryâ€‘parse with yq to catch schema errors.

  - If any error occurs, fail the job.

- Status integration

  - Mark this workflow as a required check for the default branch (repo settings).

Acceptance criteria

- A PR that introduces a parse/annotation error in any workflow is blocked with a red check and a clear error line.

- Clean PRs pass without noise.

Implementation notes

Pin action versions; do not grant extra permissions.

Keep the job fast (<30s) so it doesnâ€™t slow innerâ€‘loop iteration.
