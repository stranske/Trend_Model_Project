1) Agents 72/73: Per‑PR concurrency locks to prevent parallel work on the same Issue

Labels: agent:codex, agents, workflows, ci, devops, priority: medium, risk:low

## Why
The Codex belt worker runs with a global concurrency group, so two runs targeting the same Issue can overlap and step on each other. We need one worker-at-a-time per PR/Issue while allowing parallelism across different PRs.

Scope
Agents 72 (Worker) and Agents 73 (Conveyor).

  - Non-Goals
    - Changing keepalive cadence, dispatcher logic, or task sizing.

## Tasks
  * Agents 72: change `concurrency.group` to incorporate the Issue number, e.g. `codex-belt-${{ github.event.client_payload.issue || github.event.inputs.issue || github.run_id }}`; keep `cancel-in-progress: false`.
  * Agents 73: mirror the same per‑PR group scheme.
  * Add a summary row that prints the computed concurrency group and the targeted Issue/branch for auditing.
  * Add a cheap guard that bails if the computed group is empty (misconfigured dispatch).

## Acceptance criteria
  * Two worker dispatches for the same Issue never run at the same time; the second queues until the first completes.
  * Workers for different Issues can run concurrently.
  * Run summaries show the per‑PR group string and the targeted Issue number.

## Implementation notes
  * Files: `.github/workflows/agents-72-codex-belt-worker.yml`, `.github/workflows/agents-73-codex-belt-conveyor.yml`
  * No behavior change to label gates; only concurrency scoping.
  * Preserve current permissions and tokens.

Branch: codex/issue--per-pr-worker-locks
PR title prefix: [Agents] Per‑PR worker/conveyor locks
Touch only: .github/workflows/agents-72-codex-belt-worker.yml, .github/workflows/agents-73-codex-belt-conveyor.yml

2) Worker preflight: enforce branch HEAD freshness and safe “step‑branch” fallback

Labels: agent:codex, agents, workflows, ci, priority: medium, risk:low

## Why
If a worker continues without incorporating prior commits, it repeats or ignores work. We need a lightweight freshness check and a safe fallback so each step builds on the latest branch state.

Scope
Agents 72 (Worker) preflight and short-circuit behavior.

  - Non-Goals
    - Complex rebase automation or multi-branch merges inside the worker.

## Tasks
  * Add a “HEAD freshness” step:
    - `git fetch --no-tags origin <base> <branch>`
    - Fail fast if `origin/<branch>` has advanced since checkout (mismatch between local HEAD and remote HEAD).
  * Optional safe fallback:
    - Create ephemeral `codex/issue-<n>/step/<short-id>` when behind base, apply the step there, push, and open/refresh the automation PR to merge the step branch back into the issue branch. Close step branch after merge.
  * Emit a summary table with: Issue, branch, freshness verdict, fallback branch (if used).

## Acceptance criteria
  * Worker refuses to proceed when `<branch>` is stale and reports the reason.
  * When fallback is enabled, the step lands via the step-branch path without losing prior work.
  * No duplicated or skipped step commits when two steps fire close together.

## Implementation notes
  * Start minimal: fail-fast first; add the step-branch path behind a small `inputs.use_step_branch` flag.
  * Reuse existing environment tokens; no new scopes required.

Branch: codex/issue--worker-freshness-preflight
PR title prefix: [Agents] Worker branch freshness + optional step-branch
Touch only: .github/workflows/agents-72-codex-belt-worker.yml

3) Add durable progress ledger (.agents/issue-<n>-ledger.yml) and integrate in Worker

Labels: agent:codex, agents, workflows, automation, ci, priority: medium, risk:low

## Why
Without a durable ledger, the agent doesn’t reliably incorporate prior completed tasks in subsequent work, which causes repeats and skips. A tiny on-branch YAML ledger makes progress explicit and machine-readable.

Scope
Define the ledger format and teach Agents 72 to read/update it.

  - Non-Goals
    - Fancy orchestration UI or off-repo storage.

## Tasks
  * Define `.agents/issue-<n>-ledger.yml` (versioned schema):
    - `version`, `issue`, `base`, `branch`
    - `tasks: [{id, title, status: (todo|doing|done), started_at, finished_at, commit, notes}]`
  * Worker read path:
    - Load ledger if present; select the next `todo` task; mark it `doing`.
  * Worker write path:
    - On success, mark task `done` with the resulting commit SHA; on failure, append a `notes` entry with a short reason.
  * Add a `scripts/ledger_validate.py` with CI check to prevent schema drift.
  * Summarize ledger delta in the job summary.

## Acceptance criteria
  * Re-running the worker advances exactly one task per run until all are `done`.
  * No task repeats after success.
  * Ledger changes are committed alongside code changes for traceability.

## Implementation notes
  * Keep the file tiny and stable; YAML with a strict minimal schema.
  * Fall back gracefully when ledger is missing (create it from the Issue task list).

Branch: codex/issue--agent-ledger
PR title prefix: [Agents] Durable progress ledger + worker integration
Touch only: .github/workflows/agents-72-codex-belt-worker.yml, scripts/ledger_validate.py, .agents/*

4) Autofix: bounded remedial loop for lint/type/test failures on agent PRs

Labels: agent:codex, autofix, ci, workflows, devops, priority: medium, risk:low

## Why
Formatting and trivial test fixes shouldn’t block progress or require manual nits. A gated, bounded autofix cycle reduces churn and human time.

Scope
Agent-created PRs only; limited to safe classes of changes (formatting, import order, trivial asserts).

  - Non-Goals
    - Large refactors, risky logic changes, or changing required checks.

## Tasks
  * Add a small “Autofix” workflow that listens for CI failure on agent PRs and:
    - Confirms opt-in via `autofix` label on the PR.
    - Runs a narrow Codex prompt to produce a patch restricted to safe file patterns.
    - Pushes an `autofix/<pr>-<short>` branch with max 2 attempts.
  * Tag results:
    - If only formatting/import-order changed, add `autofix:clean`.
    - Otherwise add `needs-autofix-review`.
  * Post a concise summary comment with diffs touched and attempt count.

## Acceptance criteria
  * With `autofix` label present, lint/type/test nuisances are addressed automatically within two attempts.
  * No changes occur without the label gate.
  * Clean runs are labeled `autofix:clean`; others require human skim (`needs-autofix-review`).

## Implementation notes
  * Trigger on `check_suite`/`workflow_run` for your reusable Python CI, filtering to agent PRs.
  * Reuse existing PATs; do not merge or rebase, just push the autofix branch and let Gate validate.

Branch: codex/issue--autofix-loop
PR title prefix: [CI] Autofix loop for safe nits
Touch only: .github/workflows/autofix.yml, docs/ci/AUTOFIX.md

5) Auto‑merge agent PRs with automerge label after checks pass; document merge queue

Labels: agent:codex, automerge, workflows, ci, devops, priority: medium, risk:low

## Why
Agent PRs that pass all required checks and are explicitly labeled shouldn’t sit around waiting for a human to click a green button.

Scope
Agent-created PRs only; opt-in via `automerge` label.

  - Non-Goals
    - Changing repository protection rules or enabling merge queue automatically (document the steps instead).

## Tasks
  * Add an “Auto-merge agent PR” step to the Orchestrator that:
    - Waits for required checks to succeed and the `automerge` label to be present.
    - Verifies PR author is the automation user and target branch is the default protected branch.
    - Calls the merge API (squash or repo default).
  * Add `docs/ci/MERGE_QUEUE.md` describing optional repository-level merge queue setup and how to use it with agent PRs.

## Acceptance criteria
  * An agent PR labeled `automerge` merges itself once checks pass, otherwise it does nothing.
  * Non-agent PRs are unaffected.
  * If branch protection blocks merges (e.g., review required), the job logs an explicit reason and exits gracefully.

## Implementation notes
  * Reuse existing tokens (e.g., OWNER_PR_PAT) for the merge call.
  * Make the step no-op unless `automerge` is on the PR.

Branch: codex/issue--agent-automerge
PR title prefix: [CI] Auto‑merge for agent PRs (opt‑in)
Touch only: .github/workflows/agents-70-orchestrator.yml, docs/ci/MERGE_QUEUE.md
