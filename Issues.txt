1. Repair repo-health self-check permissions and drift snapshot

Labels: workflows, ci, devops, infra, priority: high, status: ready, risk:low

Why
The repository health check must run reliably to catch label drift, missing protections, and misconfig. It previously requested invalid permissions and could silently fail.

Tasks

 Update .github/workflows/repo-health-self-check.yml to use only supported permissions (e.g., contents: read, issues: write, pull-requests: read, checks: read).

 Implement a “verify only” path when no admin token is present; log warnings instead of failing.

 If BRANCH_PROTECTION_TOKEN is available, run enforcement then snapshot current settings to an artifact and a single pinned Health issue.

 Ensure the workflow updates one rolling issue instead of opening duplicates.

Acceptance Criteria

A manual run completes success with a summary section listing each health probe and its status.

Missing permissions no longer invalidate the workflow.

Only one rolling “Repo Health” issue is created or updated on failures.

Implementation Notes

Use a stable issue search key (e.g., label health:repo + title prefix [health] repository self-check).

Avoid admin scopes on the default token; gate any mutation behind if: env.HAS_ADMIN_TOKEN == 'true'.

2. Fix Actionlint config and make errors gate the build

Labels: workflows, ci, lint, priority: high, status: ready, risk:low

Why
Actionlint currently reports errors but does not block merges. If workflows are broken, CI should stop lying.

Tasks

 Replace deprecated Actionlint settings with fail-level: error.

 Resolve shellcheck/heredoc parse errors flagged in CI scripts and reusables.

 Add an allowlist for known non-fatal warnings to keep the signal clean.

Acceptance Criteria

Actionlint fails on any future error and passes with current workflows fixed.

CI run shows zero shellcheck parse errors in annotations.

Implementation Notes

Prefer <<-'EOF' heredocs or unindented end tokens to keep shellcheck happy.

Cache the Actionlint binary to reduce run time.

3. Wire coverage artifacts end-to-end (upload, fetch, summarize)

Labels: ci, workflows, tech:coverage, priority: high, status: ready, risk:low

Why
Post-CI summaries show empty coverage sections because artifact names or paths don’t match between producer and consumer.

Tasks

 In reusable-10-ci-python.yml, upload coverage artifacts as coverage-3.11 and coverage-3.12 (or the canonical names used by Gate).

 In pr-00-gate.yml, download those exact artifact names and store to a consistent path for Post-CI.

 In Post-CI, read coverage files and add a short diff table to the summary.

Acceptance Criteria

A PR with test changes shows non-zero coverage metrics in Post-CI.

Artifact names are consistent across reusable, Gate, and Post-CI.

Implementation Notes

Prefer coverage xml and a tiny Python step to extract overall coverage so JSON and XML both work.

4. Self-test reusables: keep one canonical workflow, remove duplicates

Labels: workflows, refactor, documentation, priority: medium, status: ready, risk:low

Why
Multiple self-test variants add noise and drift.

Tasks

 Keep a single .github/workflows/selftest-reusable-ci.yml that calls reusables via jobs.<name>.uses.

 Remove or archive older maint-4x-* selftest variants.

 Add docs under docs/ci/SELFTESTS.md explaining the expected matrix and outputs.

Acceptance Criteria

Actions list contains exactly one “Selftest: Reusables” workflow.

Nightly run completes successfully and publishes a small summary.

Implementation Notes

Use strategy.fail-fast: false and a tiny table of results in GITHUB_STEP_SUMMARY.

5. Agents guard: merge redundant guard rails into one

Labels: agents, workflows, devops, priority: medium, status: ready, risk:low

Why
Redundant guard workflows for agents create maintenance overhead.

Tasks

 Create a unified agents-guard.yml that triggers on PRs touching agents/** or labeled agent:*.

 Remove older guard variants and reference the unified one from docs.

 Validate it only checks required files and labels, then posts one concise result.

Acceptance Criteria

One guard workflow enforces agent hygiene on PRs and passes on unaffected PRs.

No duplicate agent guard runs on any PR.

Implementation Notes

Use paths and paths-ignore to scope checks.

Add a concurrency group per PR to avoid duplicate comments.

6. Agents orchestrator: dedupe keepalive and lock bootstrap label

Labels: agents, workflows, enhancement, priority: medium, status: ready, risk:low

Why
The orchestrator should not run redundant jobs, and bootstrap should respect explicit labels.

Tasks

 Ensure exactly one keepalive job exists in agents-70-orchestrator.yml.

 Gate bootstrap by bootstrap_issues_label defaulting to agent:codex.

 Confirm schedule and workflow_dispatch inputs still work.

Acceptance Criteria

Scheduled run shows one keepalive job and bootstrap only touches labeled issues.

Orchestrator run summary lists readiness, preflight, watchdog without duplication.

Implementation Notes

Add a “dry run” input to preview actions without writes.

7. PR Gate: scope Docker smoke to Docker changes

Labels: ci, workflows, enhancement, priority: medium, status: ready, risk:low

Why
Docker smoke on every non-doc PR wastes minutes. Running it only when needed preserves signal and speed.

Tasks

 Add a changed-files step that sets docker_changed when "Dockerfile", ".docker/**", "docker/**", or ".dockerignore" changed.

 Wrap the Docker smoke job with if: steps.detect.outputs.docker_changed == 'true'.

 Keep doc-only fast-pass logic.

Acceptance Criteria

PRs without Docker changes skip the Docker job.

PRs that touch Docker paths still run the smoke test.

Implementation Notes

Use dorny/paths-filter or a native git diff step.

8. Autofix mode: safe cosmetic fixes and outcome labels

Labels: autofix, ci, workflows, enhancement, priority: medium, status: ready, risk:low

Why
Autofix should be useful but predictable. Limit it to safe changes and clearly label outcomes.

Tasks

 In reusable-18-autofix.yml, run ruff --fix, import sorting, whitespace normalization.

 Apply labels autofix:applied when changes are committed, else autofix:clean.

 Post a short PR comment listing changed files.

Acceptance Criteria

A demo PR with autofix label shows a single commit of safe cosmetic changes and the outcome label.

No file outside code/tests is touched unless whitelisted.

Implementation Notes

Use git diff --name-only to build the comment.

9. Cosmetic tests fixer: narrow scope to tests/**

Labels: autofix, testing, workflows, priority: low, status: ready, risk:low

Why
Keeping test noise low speeds PR review. A tests-only autofix mode avoids risky edits elsewhere.

Tasks

 Add a label-gated mode autofix:tests that only targets tests/**.

 Apply import reordering, whitespace fixes, and simple ruff fixes.

 Post a brief summary comment.

Acceptance Criteria

A demo PR with autofix:tests only modifies files under tests/**.

Gate remains green after fixes.

Implementation Notes

Reuse steps from Issue 08, but restrict pathspecs.

10. Post-CI: single source of truth summary with coverage delta

Labels: workflows, ci, tech:coverage, enhancement, priority: medium, status: ready, risk:low

Why
Gate should be lean; Post-CI should aggregate and present the final story for humans.

Tasks

 Ensure Post-CI triggers only for Gate runs tied to PRs.

 Add a small coverage delta section comparing base vs head when artifacts are present.

 Guarantee only one PR comment exists; updates should edit in place.

Acceptance Criteria

Post-CI posts or updates a single comment per PR containing job table and coverage delta.

No duplicate comments on reruns.

Implementation Notes

Use the PR number and head SHA to compute the edit target.

Use a hidden HTML anchor in the comment body to find and update the prior comment.

11. Docs: CI/agents overview and required checks

Labels: documentation, workflows, infra, priority: low, status: ready, risk:low

Why
Future you will forget why this all works. A short map prevents archaeology.

Tasks

 Add docs/ci/WORKFLOW_SYSTEM.md explaining PR Gate, Post-CI, Repo Health, Actionlint, Agents Orchestrator, Agents Guard.

 Document required status checks for merge and optional informational checks.

 Link the doc from .github/PULL_REQUEST_TEMPLATE.md.

Acceptance Criteria

New PRs show a link to the doc in the template.

The doc lists each workflow, when it runs, and what blocks merges.

Implementation Notes

Include a tiny “How to re-run only X” section for triage.

12. Maintenance sweep: archive superseded workflows

Labels: workflows, refactor, priority: low, status: ready, risk:low

Why
Reducing file count reduces cognitive load and run noise.

Tasks

 Move superseded workflows to docs/archive/ARCHIVE_WORKFLOWS.md as bullet links with one-line rationale.

 Remove them from .github/workflows/.

 Verify Actions list is free of near-duplicate entries.

Acceptance Criteria

No duplicate entries for selftests or agent guards appear in Actions.

Archive doc exists and lists moved files.

Implementation Notes

Keep commit messages explicit: chore(workflows): archive <name> in favor of <replacement>.
