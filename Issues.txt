1) Fix selftest-reusable-ci: convert to jobs.<name>.uses and make nightly verification green

Labels: workflows, ci, ci-failure, testing, refactor, priority: high, status: ready, risk:low

Why
  - Summary The self‑test workflow calls a reusable workflow inside a step, which GitHub rejects. Convert to top‑level jobs.<name>.uses and keep the verification matrix intact so the self‑test actually self‑tests. Error seen: “reusable workflows should be referenced at the top-level jobs.*.uses key, not within steps.” 
GitHub

  - Scope

    - Edit .github/workflows/selftest-reusable-ci.yml to move the reusable workflow invocation to jobs.scenario.uses (matrix stays; inputs mapped to with:).

    - Ensure the aggregate job still emits the summary table and marks failures.

    - Keep schedule trigger; limit to nightly + manual.

Tasks

- Replace step‑level uses: with jobs.scenario.uses: ./.github/workflows/reusable-10-ci-python.yml

- Map matrix inputs via with:

- Keep strategy.fail-fast: false

- Aggregate job emits selftest-report artifact and summary

- Nightly run finishes success on phase-2-dev

Acceptance criteria

- A scheduled run on phase-2-dev completes success and uploads expected artifacts.

- No “Invalid workflow file” errors on the run page. 


2) Repair repo-health-self-check: remove invalid permission and implement safe branch-protection probe

Labels: workflows, ci, devops, infra, priority: high, status: ready, risk:low

Why
  - Summary
    The repo health self‑check fails validation due to permissions: administration: read, which isn’t allowed for GITHUB_TOKEN. Remove it and downgrade the branch‑protection probe to a best‑effort check that doesn’t require elevated perms. Error: “Unexpected value 'administration'.” 

  - Scope

    - Remove administration: from permissions.

    - Keep label existence checks and failure issue creation.

    - Replace branch‑protection check with a graceful probe that uses allowed endpoints and falls back to a warning when unauthorized.

Tasks

- permissions: only includes allowed keys (e.g., contents: read, issues: write)

- Branch‑protection step catches 403 and sets a warning output, not failure

- Workflow completes success unless other health checks fail

 - If failures exist, it opens/updates “[health] repository self-check failed” issue (as coded)

Acceptance criteria

- A run on phase-2-dev validates and executes without “Invalid workflow file.” 

Implementation notes
- If SERVICE_BOT_PAT is missing or labels are missing, the workflow files an issue/comment instead of failing validation.


3) Consolidate PR comment self‑tests; remove stale duplicates

Labels: workflows, ci, refactor, documentation, priority: medium, status: ready, risk:low

Why
  - Summary
    - There are multiple self‑test comment workflows:

      - .github/workflows/maint-43-selftest-pr-comment.yml

      - .github/workflows/pr-20-selftest-pr-comment.yml

      - .github/workflows/selftest-pr-comment.yml
    - They overlap in purpose and complicate maintenance. Consolidate into one approach or delegate to Post CI summary. 

  - Scope

    - Pick one path: either keep a single self‑test comment workflow or rely on “Maint 46 Post CI” for the unified summary.

    - Delete or archive redundant files and document the intended path in docs/ci/WORKFLOW_SYSTEM.md.

Tasks

- One canonical self‑test PR comment mechanism remains

- Duplicates removed or moved to ARCHIVE_WORKFLOWS.md

- Docs updated

Acceptance criteria

- Actions list no longer shows the duplicate self‑test entries. 


4) Stabilize reusable-10-ci-python: tighten matrix parsing and mypy pin check

Labels: ci, workflows, testing, enhancement, priority: medium, status: ready, risk:low

Why
  - Summary
    - reusable-10-ci-python.yml is the backbone for PR checks and Gate. Harden the matrix/version parsing and the mypy interpreter pin verification to avoid brittle failures, and ensure consistent artifacts for coverage and metrics. It’s being called by Gate today. 

  - Scope

    - Confirm matrix fromJson expression works for both single and multiple Python versions.

    - Ensure the “Verify mypy interpreter pin” step handles absent pyproject.toml gracefully and only runs when appropriate.

    - Normalize artifact names: coverage-<pyver>, ci-metrics, metrics-history, etc.

Tasks

- Matrix verified on 3.11 and 3.12

- Ruff, mypy, pytest-cov steps produce expected artifacts

- A sample run of reusable-10 succeeds from workflow_dispatch

Acceptance criteria

- Gate can consume artifacts from reusable-10 without manual patching. 


5) Gate: keep as single PR entry point; ensure doc‑only fast‑pass and artifact hand‑off are stable

Labels: ci, workflows, tech:coverage, priority: medium, status: ready, risk:low

Why
  - Summary
    - Gate is configured properly as the PR entry point with doc‑only detection and downstream jobs. Validate the doc‑only short‑circuit still posts the expected summary and that coverage artifacts are consistently downloaded for post‑processing. 

  - Scope

    - Verify doc‑only path posts a comment once, not repeatedly.

    - Confirm artifact download steps and summary table are correct for both 3.11 and 3.12.

    - No behavior change to required checks; just correctness and stability.

Tasks

- Doc‑only PRs show one comment and skip heavy checks

- Coverage artifacts are pulled reliably

- Gate summary shows job results table

Acceptance criteria

- At least one PR with doc‑only changes shows the “fast‑pass” comment and a green Gate. 


6) Post‑CI: finalize “Maint 46 Post CI” as the single consolidation pass

Labels: workflows, ci, tech:coverage, enhancement, priority: medium, status: ready, risk:low

Why
  - Summary
    - Use “Maint 46 Post CI” to collect run metadata and coverage, then publish a single summary. Keep Gate lean and let Post CI do the aggregation. It already targets Gate via workflow_run. 

  - Scope

    - Ensure it only triggers on PR‑type Gate runs and finds the right head SHA.

    - Confirm permissions are minimal (contents, pull-requests, checks as needed).

    - Add a short coverage section in the summary if present.

Tasks

- Successful run after Gate completes on a PR

- GITHUB_STEP_SUMMARY shows concise, useful info

- No duplicate comments per PR

Acceptance criteria

- A Gate run triggers Post CI which updates one consolidated summary. 


7) Enhance PR 02 Autofix: gated auto‑formatting with ruff; label outcomes

Labels: autofix, workflows, enhancement, ci, priority: medium, status: ready, risk:low

Why
  - Summary
    - Autofix is label‑gated and uses a reusable workflow; extend it to run ruff --fix for safe, cosmetic changes, then apply autofix:applied or autofix:clean labels to communicate outcome. Current workflow: .github/workflows/pr-02-autofix.yml gates on an opt‑in label and calls reusable-18-autofix.yml. 

  - Scope

    - Add ruff auto‑fix step inside the reusable or confirm it exists.

    - If changes committed, add or update autofix:applied; if no changes, add autofix:clean.

    - Respect concurrency and keep opt‑in label configurable via repo var.

Tasks

- Safe fixes only (formatting, imports, trivial lint)

- Labels applied correctly based on outcome

- PR description comment summarizing what changed

Acceptance criteria

- A demo PR with autofix label shows a commit with cosmetic fixes and autofix:applied label. 


8) Agents 70 Orchestrator: dedupe keepalive step and lock bootstrap filters

Labels: agents, workflows, devops, enhancement, priority: medium, status: ready, risk:low

Why
  - Summary
    - The orchestrator lists “Codex Keepalive Sweep” twice and has broad toggles. Remove duplication and ensure bootstrap only acts on a specific label (default agent:codex). Concurrency should remain per‑branch ref. 

  - Scope

    - Remove duplicate keepalive entry.

    - Confirm defaults: bootstrap_issues_label: agent:codex.

    - Validate concurrency group and schedule remain as is.

Tasks

- One keepalive job appears in job list

- Bootstrap filters strictly on the configured label

- Successful scheduled run without no‑op spam

Acceptance criteria

- Orchestrator run shows a single keepalive job, and bootstrap operates only on issues labeled agent:codex. 


9) Agents: ChatGPT Issue Sync harden scope and idempotency

Labels: agents, workflows, infra, devops, priority: medium, status: ready, risk:low

Why
  - Summary
    - Tighten “Agents 63 ChatGPT Issue Sync” so it only processes issues with agents or agent:codex labels and remains idempotent if retried. Also ensure it won’t reassign already‑assigned tickets. Listed in Actions as a separate workflow. 

  - Scope

    - Add label filter in the job’s query step.

    - Add concurrency group and short circuit if no changes.

    - Ensure secrets are not required for read‑only operations.

Tasks

- Label scoping in place

- Concurrency: agent-sync-${{ github.ref }}

- No side effects when nothing to sync

Acceptance criteria

- A dry run shows no changes without labeled issues; labeled issues sync once, not repeatedly. 


10) Reduce workflow sprawl: archive or remove duplicate “selftest‑reusable‑ci” variants

Labels: workflows, refactor, documentation, priority: low, status: ready, risk:low

Why
  - Summary
    - There are at least two selftest-reusable-ci tracks (maint‑44, maint‑48, plus the root one). Keep a single source of truth and update ARCHIVE_WORKFLOWS.md. 

  - Scope

    - Choose one canonical file for self‑test (see Issue #1).

    - Remove or archive others; document rationale.

Tasks

- One self‑test workflow remains

- Archive note added

Acceptance criteria

- Actions page no longer lists multiple selftest variants. 


11) Branch protection: document the required status contexts and how to enforce them

Labels: devops, infra, documentation, workflows, priority: medium, status: ready, risk:low

Why
  - Summary
    - Document the intended required checks for phase-2-dev, with “Gate” as the mandatory context, and how Maint 46 Post CI augments reporting. This complements the repo‑health probe, which cannot request administration permission. 

  - Scope

    - Update docs/ci/WORKFLOW_SYSTEM.md with:

    - What must be green before merge (Gate)

    - What is informational (Post CI summary)

    - How to set branch protection manually in repo settings

    - Link the doc from PR template.

Tasks

- Doc updated and committed

- PR template links to the doc

Acceptance criteria

- New PRs display the required check(s) and maintainers have a clear, single doc for the setup.


12) “Cosmetic tests fixer” as a controlled autofix mode

Labels: autofix, testing, enhancement, workflows, priority: low, status: ready, risk:low

Why
  - Summary
    - Add an optional autofix mode that only does safe test‑cosmetics: import sorting, ruff quick‑fixes, and whitespace normalization in tests/. Gate remains the enforcer; this is a convenience to lower PR churn.

  - Scope

    - Extend reusable-18-autofix.yml or add a sub‑mode triggered by label autofix:clean to target only tests/**.

    - Post a short PR comment listing files changed.

Tasks

- Label‑gated mode implemented

- Only tests/** is touched

- Comment summary posted

Acceptance criteria

- A demo PR with the label shows cosmetic test changes only, and Gate stays green.


13) Health 44: enforce Gate + Agents Guard as required checks without pruning

Labels: ci, devops, workflows, config, priority: high, risk:low, status: ready



Why - Policy states the default branch must require Gate and Agents Guard. Enforcement must match that policy and avoid pruning legitimate required contexts.
  - Summary
    - The enforcement job in .github/workflows/health-44-gate-branch-protection.yml currently only requires “Gate / gate” and prunes other required checks. This contradicts policy and can silently drop the Agents Guard requirement.

Tasks

  - Update Health 44’s enforcement step to pass all intended required contexts and disable cleanup:

    - context "Gate / gate"

    - context "Enforce agents workflow protections"

      - context "Health 45 Agents Guard / Enforce agents workflow protections"

      - no-clean

    - Ensure the job runs in dry-run on PRs and with --apply on schedule/workflow_dispatch.

    - Keep the job id/job name stable so the published status contexts remain constant for branch‑protection matching.

Acceptance criteria

- After a scheduled --apply, the default branch’s required checks show exactly the three contexts above and are not pruned on subsequent runs.

- The Health 44 job summary shows the “before/after” snapshot of required checks.

- A manual workflow_dispatch re‑run does not remove the Agents Guard requirements.

Implementation notes
  - Test plan

    - Run Health 44 on default branch in dry‑run and capture the JSON snapshot.

    - Run with --apply, confirm required checks include all three contexts.

    - Trigger again to verify idempotency.

    - Attempt to add a bogus required check and confirm Health 44 removes it while preserving the three required contexts.

  - Risks/mitigations

    - Mis‑typed context strings lead to stuck merges. Mitigate with dry‑run first and a guard “canary” PR.

  - Artifacts/Links

    - Related closed issue: #2683. 


14) Health 45 Agents Guard: fix PR comment clobber via explicit hidden marker

Labels: bug, ci, workflows, agents, priority: high, risk:low, status: ready

Why?
  - Summary
    - health-45-agents-guard.yml builds a PR comment using an empty marker, then searches for any comment that “includes(marker).” Empty string matches everything, so it can overwrite a human comment.

Tasks

- In the actions/github-script step, set a non‑empty marker constant:

  - const marker = "<!-- agents-guard-marker -->";

- Prepend the marker to the comment body.

- When updating, only target an existing comment that body.includes(marker).

- If none exists, create a new comment; otherwise update in place.

Acceptance criteria

- Guard run creates a single persistent comment containing the marker.

- Re‑runs update that specific comment only.

- A PR with existing human comments remains untouched.

Implementation notes
  - Test plan

    - Open a PR with two human comments. Run Guard twice; verify only one bot comment exists and gets updated in place.

    - Affected file

    - .github/workflows/health-45-agents-guard.yml


15) Gate: docs‑only comment uses empty marker; switch to explicit marker or summary‑only

Labels: bug, ci, workflows, priority: medium, risk:low, status: ready

Why?
  - Summary
    - The Gate workflow’s docs‑only branch posts a PR comment using const marker = '', which breaks idempotency and can attach to the wrong comment.

Tasks
  - Options

    - Preferred: drop the PR comment and keep messaging in the job summary only.

    - Or: keep the comment but use a unique marker, e.g. <!-- gate-docs-only -->, with the same “find by marker” update logic as Agents Guard.

Acceptance criteria

- On docs‑only PRs, either:
  - a) no PR comment is written and the step summary clearly shows the docs‑only path, or
  - b) exactly one persistent PR comment with the explicit marker is updated in place on re‑runs.

Implementation notes
  - Test plan

    - Create PR with an unrelated comment, trigger docs‑only path twice, confirm behavior matches the chosen option.

    - Affected file

    - .github/workflows/gate.yml (or whichever Gate file contains the docs‑only logic)


16) Docs alignment: WORKFLOW_SYSTEM.md vs AGENTS_POLICY.md

Labels: docs, documentation, workflows, priority: medium, risk:low, status: ready

Why?
  - Summary
    - WORKFLOW_SYSTEM.md says Gate is the only required check; AGENTS_POLICY.md says the default branch requires Gate and Agents Guard. Documentation must be consistent and match enforcement.

Tasks

- Pick the authoritative stance: keep Agents Guard required.

- Update docs/ci/WORKFLOW_SYSTEM.md to state the required checks explicitly and reference the Health 44 enforcement job.

- Cross‑link both docs and note the stable status context strings.

- Add a short “How to verify required checks” section that points to Health 44 snapshots.

Acceptance criteria

- Both docs list the same required checks and link to the enforcement workflow file.

- Merged PR updates any diagrams/topologies to show Agents Guard in the merge gate.


17) Repository ruleset: verify block on deletion/renames of protected agent workflows

Labels: config, devops, workflows, agents, priority: high, risk:low, status: ready

Why?
  - Summary
    - Policy claims a repository ruleset blocks deletion or unsafe edits to the three protected agent workflows (Agents 63 pair + 70 Orchestrator). This is configured outside the repo and needs validation.

Tasks

- Attempt to delete or rename each protected workflow from a test branch and push.

- Expected: push is rejected by the ruleset.

- If the push succeeds, configure a repository ruleset to block file deletions/renames and restrict edits to CODEOWNERS.

- Document the ruleset name and settings in docs/ci/AGENTS_POLICY.md and add a one‑line verification command/UI path.

Acceptance criteria

- Proof of failed push for delete/rename attempts (screenshot or link to failed action).

- Policy doc updated with the ruleset name and a quick verification step.


18) Agents 63 Codex Issue Bridge: consider cancel-in-progress: true for per‑issue concurrency

Labels: agents, ci, devops, workflows, enhancement, priority: low, risk:low, status: ready

Why?
  - Summary
    - agents-63-codex-issue-bridge.yml uses a concurrency group per issue with cancel-in-progress: false. If labels flap, runs queue up.

Tasks

- Inspect the last 7 days of runs for queue depth/backlog per issue.

- If more than one run is often queued for the same concurrency key, flip cancel-in-progress: true.

- Note the trade‑off in the workflow summary for maintainers.

Acceptance criteria

- Either: the flag is turned on and redundant runs are cancelled; or: evidence is attached showing no backlog and the issue is closed as “no change.”


19) Health 44: surface branch‑protection snapshots directly in job summary

Labels: ci, workflows, enhancement, priority: medium, risk:low, status: ready

Why?
  - Summary
    - Health 44 already produces JSON snapshots. Make drift visible without downloading artifacts by echoing a minimal table or JSON excerpt into the job summary.

Tasks

- After snapshot generation, add a step to render a compact list of required checks and branch rule toggles in the step summary.

- Keep full JSON as an artifact for audit.

Acceptance criteria

- The Actions UI shows current required checks and any diffs vs previous run in the summary.

- Artifact still contains the full JSON.




