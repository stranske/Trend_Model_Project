1) Add data contract checks and execution-lag guardrail at pipeline entry
Labels: agents, agent:codex, data, backend, enhancement, testing
GUID: TMP-2025-11-16-DATA-CONTRACT

Why:
Avoid silent pipeline corruption when columns/dtypes drift or when the latest data lags the requested as-of date.

Tasks:
- Define a `validate_prices_frame(df)` that checks required columns, dtypes, sorted Date index, no dupes, and monotonic dates.
- Add `enforce_required_columns(df, {"symbol": "string", "date": "datetime64[ns]", "close": "float64"})`.
- Implement `assert_execution_lag(df, as_of, max_lag_days)` to raise if `as_of - df.index.max() > max_lag_days`.
- Wire these checks at the first ingest point before any signal/portfolio code runs.
- Add unit tests for missing column, wrong dtype, unsorted index, duplicate dates, and lag breach.

Acceptance criteria:
- Running tests shows failures for malformed frames and passes for well-formed frames.
- Pipeline aborts with a clear error if as-of exceeds `max_lag_days`.
- No existing valid runs regress.

Implementation notes:
- Keep pure pandas; no new deps required here.
- Place validators in a new small module (e.g., `validation.py`) and import at pipeline entry.
- Use informative `ValueError` messages that cite the offending columns/dtypes.

------------------------------------------------------------

2) Gate portfolio universe by as-of membership (“UniverseGater”)
Labels: agents, agent:codex, data, engine, enhancement, testing
GUID: TMP-2025-11-16-UNIVERSE-GATER

Why:
Prevent look-ahead bias by ensuring constituents are eligible only if they’re members as-of the rebalance date.

Tasks:
- Create a `gate_universe(prices, membership, as_of)` that inner-joins on [date, symbol] and filters non-members.
- Support both daily and rebalance-date gating (boolean `rebalance_only`).
- Add tests with a tiny fixture where a symbol enters/exits and confirm holdings follow membership.

Acceptance criteria:
- For any rebalance date, symbols not in membership are excluded from positions.
- Tests prove correct behavior for enter/exit and for `rebalance_only=True/False`.

Implementation notes:
- Accept membership from a DataFrame or CSV path; do not tie to a single I/O path.
- Ensure the function is deterministic given inputs.

------------------------------------------------------------

3) Centralize rolling window math and remove accidental look-ahead
Labels: agents, agent:codex, engine, backend, enhancement, testing
GUID: TMP-2025-11-16-ROLLING-NOLOOKAHEAD

Why:
Scattered `.shift` and rolling logic is error-prone. One canonical helper avoids future-leak bugs.

Tasks:
- Implement `rolling_shifted(series, window, agg, min_periods=None)` which applies `series.shift(1)` before rolling.
- Support aggregations: mean, std, sum, max, min; add a hook to pass a callable.
- Replace ad-hoc rolling code with the helper across signals.
- Add tests verifying that today’s value never uses same-day input.

Acceptance criteria:
- All signal calculations that rely on history call the helper.
- Tests show identical results to the previous correct implementations and no look-ahead.

Implementation notes:
- Use vectorized pandas operations; keep it dependency-free.

------------------------------------------------------------

4) Canonical rebalance calendar utility
Labels: agents, agent:codex, engine, backend, enhancement, testing
GUID: TMP-2025-11-16-REBALANCE-CALENDAR

Why:
Rebalance timing inconsistencies create off-by-one fills and inconsistent comparison runs.

Tasks:
- Implement `get_rebalance_dates(prices.index, freq)` supporting month-end, week, and custom date lists.
- Ensure rebalance dates align to trading days in `prices.index` and skip missing dates.
- Provide `apply_rebalance_schedule(positions, dates)` helper.
- Add tests for month-end and weekly schedules with holidays/gaps.

Acceptance criteria:
- Any run using the same inputs and `freq` picks identical rebalance dates.
- Positions only change on specified dates.

Implementation notes:
- Use pandas offsets (`MonthEnd`, `Week`) then intersect with the index.

------------------------------------------------------------

5) Simple, configurable cost model (commissions + slippage)
Labels: agents, agent:codex, engine, enhancement, config, testing
GUID: TMP-2025-11-16-COST-MODEL

Why:
Zero-cost backtests exaggerate results. A small, explicit cost model increases realism.

Tasks:
- Add `CostModel(bps_per_trade, slippage_bps)` applied to turnover events.
- Integrate cost deduction at order fill or end-of-day position transition.
- Surface parameters via config (YAML/JSON) with sensible defaults.
- Add tests: zero-cost equals baseline; non-zero costs reduce returns by expected amount on a toy dataset.

Acceptance criteria:
- Cost settings are visible in outputs and reproducible.
- Turning costs on reproduces analytically expected drawdown in the test case.

Implementation notes:
- Keep it linear; no fancy market impact.
- Emit turnover and cost totals into the final results dict.

------------------------------------------------------------

6) Consolidate data I/O at the edge and keep core pure
Labels: agents, agent:codex, backend, data, enhancement
GUID: TMP-2025-11-16-IO-EDGE

Why:
Interleaving file reads with transforms makes testing and reuse harder.

Tasks:
- Introduce `load_prices`, `load_membership`, and `load_benchmarks` functions that return DataFrames with validated schemas.
- Refactor the pipeline so downstream steps accept DataFrames, not file paths.
- Add a single orchestration function that wires I/O to compute steps.

Acceptance criteria:
- Core compute functions have no file I/O side effects.
- Swapping in-memory fixtures for CSVs in tests is trivial.

Implementation notes:
- Keep paths and options in the config; orchestration reads config once.

------------------------------------------------------------

7) Streamlit upload preflight: schema, date parsing, shape limits
Labels: agents, agent:codex, docs, enhancement, data
GUID: TMP-2025-11-16-STREAMLIT-PREFLIGHT

Why:
Bad uploads produce cryptic errors. Quick checks and friendly messages save time.

Tasks:
- Add a `validate_uploaded_csv(file, required_columns, max_rows)` for Streamlit.
- Validate date parse, required columns, duplicate dates, and row cap with clear user errors.
- Show a short “what this file should look like” sample on failure.
- Log a concise server-side error with traceback for debugging.

Acceptance criteria:
- Invalid uploads show an actionable message and do not crash the app.
- Valid uploads proceed without additional prompts.

Implementation notes:
- Keep Streamlit error messages succinct; use `st.error` with bullet points.

------------------------------------------------------------

8) Config schema validation with minimal friction
Labels: agents, agent:codex, config, enhancement, testing
GUID: TMP-2025-11-16-CONFIG-SCHEMA

Why:
Typos in config keys or wrong types cascade into runtime explosions.

Tasks:
- Define a lightweight config schema for core knobs: data paths, universe file, frequency, costs.
- Validate on startup; include defaults and helpful error texts.
- Add tests covering missing required fields and wrong types.

Acceptance criteria:
- Invalid configs fail fast with a single, clear error.
- Valid configs round-trip through load/validate.

Implementation notes:
- Prefer stdlib/dataclasses + manual checks to avoid adding heavy deps.
- Keep schema in a single file used by CLI/app.

------------------------------------------------------------

9) Positions contract: single canonical structure between signals and portfolio
Labels: agents, agent:codex, engine, enhancement, testing
GUID: TMP-2025-11-16-POSITIONS-CONTRACT

Why:
Mismatched expectations about shapes/units of positions lead to mis-weights and odd fills.

Tasks:
- Define the positions contract: index is Date; columns are symbols; values are target weights in [-1, 1] or NaN for not held.
- Provide `normalize_positions(df)` to enforce bounds, fill NaN with 0, and mask non-eligible assets.
- Add tests for overweight, underweight, and NaN handling.

Acceptance criteria:
- Portfolio layer accepts only normalized positions; rejects invalid shapes with helpful errors.
- Tests show reproducible final weights for a simple two-asset toy case.

Implementation notes:
- Document the contract beside the function and reference it in errors.

------------------------------------------------------------

10) Run manifest + quick HTML report for reproducibility
Labels: agents, agent:codex, exports, enhancement, docs
GUID: TMP-2025-11-16-RUN-MANIFEST

Why:
You need a durable breadcrumb of “what ran, with what, and when,” plus a one-pager to eyeball results.

Tasks:
- Emit a small JSON “manifest” per run: config hash, code commit (if available), data date range, instrument count, basic metrics.
- Generate a minimalist HTML report with key charts/metrics and links to artifacts.
- Save both alongside outputs in a timestamped directory.

Acceptance criteria:
- Each run leaves a manifest and HTML that can be opened standalone.
- Manifests include enough metadata to rerun the job.

Implementation notes:
- Keep HTML extremely simple; avoid heavy templating. Inline CSS is fine.

------------------------------------------------------------

11) Critical invariant tests: data, universe, rebalance, no-lookahead, costs
Labels: agents, agent:codex, testing, engine, data
GUID: TMP-2025-11-16-INVARIANT-TESTS

Why:
A small battery of invariants catches 90% of regressions.

Tasks:
- Test that missing/extra columns raise validation errors.
- Test that non-members are excluded at rebalance.
- Test that rolling helper never uses future data.
- Test that costs reduce returns by the analytical amount on a toy turnover sequence.
- Test that rebalance dates occur only on the calendar utility’s dates.

Acceptance criteria:
- Five named tests pass; failures point to the exact invariant that broke.

Implementation notes:
- Keep fixtures tiny and inline to ensure legibility.

------------------------------------------------------------

12) Performance quick win: avoid duplicate groupby/apply and cache intermediate features
Labels: agents, agent:codex, engine, enhancement
GUID: TMP-2025-11-16-PERF-CACHE

Why:
Recomputing identical features inflates runtime. Small caching plus vectorization trims cycles.

Tasks:
- Identify top 2–3 repeated computations in signals and wrap them with a simple memo (`lru_cache` or dict keyed by params).
- Replace slow `groupby.apply` with vectorized ops where feasible.
- Add a one-line timing logger around key stages to verify improvement.

Acceptance criteria:
- On a medium sample dataset, end-to-end runtime improves meaningfully without altering results.
- Timing logs show cached stages shrinking materially on successive runs.

Implementation notes:
- Keep caching in-process and ephemeral; no disk persistence required.

------------------------------------------------------------

13) Packaging hygiene: exclude `Old/` and `retired/` from imports and builds
Labels: agents, agent:codex, backend, config
GUID: TMP-2025-11-16-PKG-EXCLUDES

Why:
Legacy directories bleeding into imports is a haunted-house problem.

Tasks:
- Ensure `pyproject.toml` or equivalent excludes `Old/` and `retired/` from the package.
- Add a sanity test that importing the package does not expose modules from those paths.

Acceptance criteria:
- Editable install shows no imports resolved from excluded folders.
- CI import sanity check passes.

Implementation notes:
- If needed, add `MANIFEST.in` excludes for sdist.

------------------------------------------------------------

14) Minimal CI: install, import, and run invariant tests
Labels: agents, agent:codex, ci, devops, testing
GUID: TMP-2025-11-16-CI-SMOKE

Why:
A tiny CI sweep prevents “it runs on my laptop” surprises.

Tasks:
- Add a workflow that sets up Python, installs the project, and runs the invariant tests from issue 11.
- Run an import sanity check for the package.
- Cache dependencies between runs to keep it fast.

Acceptance criteria:
- Workflow is green on default branch and PRs.
- Failures surface with actionable logs.

Implementation notes:
- Keep matrix minimal (one Python version).
- Don’t enforce coverage thresholds; keep it lightweight.
