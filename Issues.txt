1. Add a Canonical Doc Describing the Keepalive Goals and Plumbing

Labels: agents, agents:keepalive, ci, automation, docs

Why
Agents get confused about the purpose of the keepalive and lose focus on the task goals. The canonical document provides enhanced memory for the agents working on the task.

Scope

- Guidelines and Goals for the Keepalive.

Nonâ€‘Goals

- Providing goals or instructions for anything besides the keepalive.

Tasks

- Add the document in the implementation notes to docs and label it for agents in a way that reminds them to consult it any time work is done on the keepalive.

Acceptance criteria

- The document has been uploaded to docs and included in any other documentation in the repo where it belongs

Implementation notes

Title: Keepalive â€” Goals & Plumbing (canonical reference)

Purpose
Drive an iterative, handsâ€‘off loop where an agent continues working on a PR in small, verifiable increments until all acceptance criteria are metâ€”while guaranteeing safety rails and predictable behavior.

Activation contract (first fire for a PR)
Keepalive must not post or dispatch for the first time on a PR unless all are true:

PR label present: agents:keepalive

Human initiation present: at least one human issue_comment.created on the PR that @mentions an agent (e.g., @codex, @claude), where the agent name is taken dynamically from the PRâ€™s agent:* label(s). No hardâ€‘coding of agent names.

Gate completed: the Gate workflow for the current head SHA has conclusion = success (or an explicit allowâ€‘list of acceptable conclusions).

Repeat contract (round N â†’ N+1)
Before keepalive posts the next instruction comment or dispatches another agent run:

The three preconditions above are still true, and

The runâ€‘cap for this PR is not exceeded, and

The branchâ€‘sync gate (below) says the agentâ€™s previous â€œworkâ€ is now actually reflected on the PR branch.

Run cap
Limit concurrent agent runs per PR:

Config via label: if the PR has a label like agents:max-parallel:K, use K (integer, 1â€“5).

Default: 2 if no label is present.

Enforced as: â€œnumber of inâ€‘progress Orchestrator/Worker runs for this PRâ€ < cap. If at cap, keepalive does not post a new instruction or dispatch; it exits quietly (or writes a step summary only).

Pause / stop control

Removing agents:keepalive must stop any new agent runs & prevent keepalive comments.

Optionally respect a stronger â€œhard pauseâ€ label agents:pause that prevents all keepalive activity, including any fallbacks.

Noâ€‘noise rule
If preconditions arenâ€™t met (label missing, no human @agent yet, Gate not green, cap reached), keepalive must not post new comments. It may write a runâ€‘summary for operators, but no PR noise.

Instruction comment contract
When keepalive is allowed to post:

Create a new instruction comment (never edit a status comment).

Author: post as stranske using ACTIONS_BOT_PAT (preferred); fallback to SERVICE_BOT_PAT (posts as the automation bot).

Body must start with these hidden markers + trace id, then the visible instruction:

<!-- keepalive-round: {N} -->
<!-- codex-keepalive-marker -->
<!-- keepalive-trace: {TRACE} -->
@<agent> Continue with the remaining tasks. Reâ€‘post Scope/Tasks/Acceptance and check off only when acceptance criteria are satisfied.

<Scope/Tasks/Acceptance block>


After posting, the system adds ğŸ‘€ to the comment and expects PRâ€‘meta to add ğŸš€ (ack) within a short TTL.

Detection & dispatch

PRâ€‘meta listens to issue_comment.created and accepts authors: stranske or the automation bot.

Requires the hidden markers; dedupes via ğŸš€; then dispatches both:

workflow_dispatch â†’ Agentsâ€‘70 Orchestrator (with options_json containing {round, trace, pr}).

repository_dispatch (codex-pr-comment-command) for the connector, with {issue, base, head, comment_id, comment_url, agent}.

PRâ€‘meta writes a small summary table per event (ok | reason | author | pr | round | trace).

Branchâ€‘sync gate
Before posting the next instruction for a round, require that the PR head moved (work landed). If not, attempt automation and only then proceed:

If head SHA unchanged after the agent reports â€œdone,â€ scan the agentâ€™s last reply for an â€œUpdate Branchâ€ / â€œCreate PRâ€ URL (known patterns per connector), call it automatically, and poll the PR for a new commit (short TTL).

If still unchanged, try a secondâ€‘chance path (e.g., the â€œCreate PRâ€ route if â€œUpdate Branchâ€ is no longer allowed), then poll again.

If still unchanged, pause keepalive and add a label agents:sync-required (no instruction post, no dispatch). A short, singleâ€‘line PR comment with the {trace} may be allowed only when a debug label (e.g., agents:debug) is present.

Orchestrator invariants

No selfâ€‘cancellation: cancel-in-progress: false; concurrency keyed by {pr}-{trace}.

Explicit bails: on any early exit (precondition missing, run cap reached, Gate not green, branchâ€‘sync unresolved), write a oneâ€‘line reason to the runâ€‘summary and (optionally, when debug label exists) a terse PR comment:

**Keepalive {round}** \{trace}` skipped: <reason-code>`

Assignees: ignore bot/app accounts; if no humans remain, skip gracefully; do not fail the round.

Removing and then re-adding agents:keepalive will restart the keepalive functionality as long as all criteria have been met

Success condition
Stop when all acceptance criteria are checked complete; optionally remove agents:keepalive and add agents:done.
