1. Keepalive Worker: fix skip guard (execute on new instruction even if head SHA hasn’t moved)

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
On typical test PRs (e.g., #3529), the worker posts “worker skipped – head <sha7>” immediately after a fresh keepalive instruction comment. That means the worker’s early‑exit checks are bailing purely on “head unchanged,” even when a new instruction exists and should start a round. This prevents code‑producing runs.

Scope
- Change the worker’s pre‑execute gate so it skips only if both are true:

- No newer instruction (by comment_id/created_at) than the last processed instruction, and

- Head SHA unchanged since the last processed instruction.

If a newer instruction exists, do not skip merely because head is unchanged; proceed to execute the round (dispatch agent) and then run the branch‑sync gate.

Non‑Goals

No changes to instruction formatting or status/summary content

No changes to run‑cap or PR‑meta reaction lock

No changes to branch‑sync logic beyond invocation order

Tasks

- Track last processed state

  - Persist (e.g., to job outputs or a lightweight artifact/PR label) the tuple { last_processed_comment_id, last_processed_head_sha } at the end of each successful round.

- Find the latest instruction

  - In the worker pre‑gate, locate the most recent keepalive instruction comment for the PR (must be issue_comment.created, created‑not‑edited, contains the three hidden markers + trace). Extract { comment_id, created_at }.

- Evaluate skip condition

  - Fetch current head_sha.

  - Skip only if comment_id <= last_processed_comment_id and head_sha == last_processed_head_sha.

  - Otherwise, proceed: dispatch to the agent and run branch‑sync.

- Summarize outcome (no PR noise)

  - Always write one line to $GITHUB_STEP_SUMMARY:
    WORKER: action=<skip|execute> reason=<no-new-instruction-and-head-unchanged|new-instruction|head-changed> pr=#<n> head=<sha7> instr=<comment_id> trace=<trace>

Acceptance criteria

- With a fresh instruction present and head unchanged, the worker executes (does not skip), dispatching the agent and then branch‑syncing.

- When no newer instruction exists and head is unchanged, the worker skips with reason=no-new-instruction-and-head-unchanged.

- The summary line appears on every run reflecting the decision and inputs.

- Subsequent rounds complete without the immediate “worker skipped – head …” pattern seen previously.

Implementation notes

Use the same instruction detector that PR‑meta uses (created, hidden markers, trace) to avoid false positives from status/summary comments.

If state is persisted via labels, choose a private control label (e.g., agents:last-instruction:<id>), or write to a tiny artifact keyed by PR number; avoid PR noise.

2. Keepalive Dispatch Payload: send only the instruction body (exclude status/summary)

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
On typical test PRs (e.g., #3529), the instruction comment currently includes a long status/summary bundle (Head SHA, “Latest Runs”, “Workflow / Job Result Logs”, coverage) below the Scope/Tasks/Acceptance block. When the full comment body is forwarded to the agent/connector, that additional material can dilute or confuse the prompt. We want the connector to receive only the instruction text (Scope/Tasks/Acceptance + required markers/mention), not the status bundle.

Scope

- In the PR‑meta/orchestrator dispatch step(s), construct the payload so it contains only the instruction body (the part authored for the agent), and exclude the status/summary content.

- Keep existing dispatch flags (quiet: true, reply: 'none') as is.

Non‑Goals

No changes to how/where the status/summary is posted (it can remain in a separate comment or PR body)

No changes to reaction locks, run‑cap, or branch‑sync behavior

Tasks

- Identify instruction segment

  - From the composed comment, extract the instruction segment beginning with the hidden markers + @<agent> header and ending after the Acceptance criteria section (and optional short Execution block with PR/base/head).

  - Explicitly exclude any sections titled “Head SHA”, “Latest Runs”, “Required Status Checks”, “Workflow / Job Result Logs”, “Coverage”, etc.

- Wire dispatch with clean body

 - For both repository_dispatch and any workflow_dispatch used to start the round, pass the instruction segment as the body content (or as a distinct instruction_text field), along with comment_id, comment_url, agent, base, head, and trace.

- Guard rails

  - If the instruction segment cannot be parsed (e.g., missing markers), do not dispatch; write a single summary line and exit 0.

- Summarize dispatch (no PR noise)

  - Write one line to $GITHUB_STEP_SUMMARY:
    DISPATCH: ok=<true|false> reason=<ok|no-instruction-segment> pr=#<n> comment=<id> agent=<alias> bytes=<len>

Acceptance criteria

- For a test PR, the connector receives only the instruction portion (Scope/Tasks/Acceptance [+ optional short Execution]), not the status bundle.

- When the instruction is missing or malformed, dispatch is skipped with reason=no-instruction-segment (summary only; no PR noise).

- When valid, dispatch succeeds and subsequent agent runs start producing code changes (subject to branch‑sync).

Implementation notes

Keep your current hidden‑marker protocol intact; use those markers to anchor extraction (<!-- codex-keepalive-marker -->, round, trace).

If your instruction composer already generates an instruction block separately from the status bundle, prefer passing that pre‑rendered block directly rather than re‑parsing the combined comment.

Do not alter moderation of connector comments; this issue only controls what is dispatched, not who posts publicly.
