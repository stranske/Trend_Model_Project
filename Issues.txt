1) Worker: remove hardcoded main; always use dynamic base/head and enforce HEAD freshness

Title: Worker: purge ref: main; use dynamic base/head and HEAD freshness preflight
Labels: agent:codex, agents, ci, devops, automation

Body:

Summary
Eliminate the remaining checkout of `main` in the Worker and ensure all fetch/checkout operations use the runtime inputs (base/head). Add a HEAD freshness preflight so steps never run on a stale worktree.

Testing
- Force a PR with base != main; run Worker; verify no reference to `main` occurs in logs.
- Make the branch stale; verify Worker fails fast (default) or uses configured fallback (if enabled).
- CI green after each step; no duplicate runs on main.

CI readiness
- No new required checks.
- Gate validates code after each Worker step.

Automated Status Summary
Scope
- agents-72 Worker checkout/fetch logic only; optional freshness preflight.

Tasks
- [ ] Replace any `ref: main`/implicit default in Worker with inputs: `ref: ${{ inputs.branch }}`; fetch base with `${{ inputs.base }}`.
- [ ] Add freshness preflight: compare `HEAD` to `origin/${{ inputs.branch }}`; fail if stale (unless fallback enabled).
- [ ] (Optional) Add `inputs.use_step_branch` fallback to create and merge a step branch when stale.

Acceptance criteria
- [ ] Worker never checks out or fetches `main` unless it is the computed default branch.
- [ ] Stale branches do not proceed without explicit fallback.
- [ ] No spurious runs on main.

Topic GUID: 5c7f3a0f-8a1e-4a9b-b1c4-6a6d0b2f2d91

Why
A leftover `ref: main` causes duplicate work against main and undermines deterministic task iteration.

Scope
Worker checkout/fetch steps and a minimal freshness gate.

Non-Goals
No changes to step sizing or Codex prompts.

Tasks
- [ ] Ensure all `actions/checkout` and git fetch steps use `${{ inputs.branch }}` and `${{ inputs.base }}`.
- [ ] Add freshness preflight and short, actionable failure output.
- [ ] Document the behavior in the Worker summary.

Acceptance criteria
- [ ] No logs show `ref: main` unless `main` is the actual default base.
- [ ] Freshness check prevents stale edits; optional fallback merges cleanly.

Implementation notes
Files: `.github/workflows/agents-72-codex-belt-worker.yml`
Keep concurrency grouping as is; only checkout/fetch and preflight change.

Branch: codex/issue--worker-dynamic-base-head
PR title prefix: [Agents] Worker: dynamic base/head + freshness preflight
Touch only: .github/workflows/agents-72-codex-belt-worker.yml

Copy/paste to PR comment (kickoff)
@{agent} use the scope, acceptance criteria, and task list so the keepalive workflow continues nudging until everything is complete. Work through the tasks, checking them off only after each acceptance criterion is satisfied, but check during each comment implementation and check off tasks and acceptance criteria that have been satisfied and repost the current version of the initial scope, task list and acceptance criteria each time that any have been newly completed.

2) Bridge: enforce default invite‑only and canonical base/head derivation (no PR creation by default)

Title: Bridge: default to invite‑only; derive base from repo default; standardize head codex/issue-<n>
Labels: agents, automation, devops, ci, docs, agent:codex

Body:

Summary
Stop accidental duplicate PRs. Bridge must default to invite-only (no PR creation), compute base from the repository default branch each run, and emit head `codex/issue-<n>` for the belt.

Testing
- Run Bridge on labeled Issue: it posts copy/paste + base/head; creates no PR.
- Toggle debug `mode=create`: it creates exactly one PR from `codex/issue-<n>` into the computed default base.
- Re-run Bridge: still no PR in invite mode.

CI readiness
- No required-check changes.
- Compatible with existing Orchestrator/Worker flows.

Automated Status Summary
Scope
- Bridge wrapper and reusable bridge; invitation mode and base/head computation only.

Tasks
- [ ] Set Bridge input default `mode: invite` (no PR creation).
- [ ] Derive base via `repos.get().default_branch` on every run.
- [ ] Emit canonical head `codex/issue-<n>` as outputs for downstream steps.
- [ ] Ensure copy/paste block includes base/head in the summary for operator visibility.

Acceptance criteria
- [ ] Invite-only behavior is default.
- [ ] base == repository default branch; head == `codex/issue-<n>` every run.
- [ ] No duplicate PRs when Bridge and belt both run.

Topic GUID: d2c8f868-3a17-4a1b-b6b0-9d809b1f3cde

Why
When Bridge can create PRs by default or uses ad-hoc head names, it races the belt and opens duplicates; hardcoding `main` yields wrong base.

Scope
Bridge inputs and base/head computation.

Non-Goals
Copy/paste instruction text is unchanged (already finalized).

Tasks
- [ ] Default to `mode=invite`.
- [ ] Resolve base from `default_branch`.
- [ ] Standardize head `codex/issue-<n>` and expose outputs.

Acceptance criteria
- [ ] No PR in invite mode; exactly one in create mode.
- [ ] Computed base/head visible in Bridge summary/comment.

Implementation notes
Files: `.github/workflows/agents-63-codex-issue-bridge.yml`, `.github/workflows/reusable-agents-issue-bridge.yml`

Branch: codex/issue--bridge-invite-enforced
PR title prefix: [Bridge] Invite-only default + canonical base/head
Touch only: .github/workflows/agents-63-codex-issue-bridge.yml, .github/workflows/reusable-agents-issue-bridge.yml

Copy/paste to PR comment (kickoff)
@{agent} use the scope, acceptance criteria, and task list so the keepalive workflow continues nudging until everything is complete. Work through the tasks, checking them off only after each acceptance criterion is satisfied, but check during each comment implementation and check off tasks and acceptance criteria that have been satisfied and repost the current version of the initial scope, task list and acceptance criteria each time that any have been newly completed.

3) Keepalive: enforce single path and scope to codex/issue-* with marker upsert

Title: Keepalive: single nudge path only; restrict to codex/issue-*; upsert by marker
Labels: agents, agents:keepalive, automation, devops, ci, agent:codex

Body:

Summary
Ensure only one keepalive path is active and it only nudges Codex PRs (`codex/issue-*`). Upsert the keepalive comment with a HTML marker to avoid duplication.

Testing
- Trigger Gate on a non-agent branch: no keepalive comment or nudge occurs.
- Trigger Gate on `codex/issue-<n>`: keepalive updates a single comment in place.
- Run twice quickly: single comment remains; state refreshes.

CI readiness
- No required-check changes; this is orchestration glue.

Automated Status Summary
Scope
- Active keepalive workflow (Gate listener or Orchestrator sweep), not both.

Tasks
- [ ] Disable the unused keepalive path (Gate-driven or Orchestrator sweep).
- [ ] Restrict nudge to branches matching `codex/issue-*`.
- [ ] Upsert keepalive comment using `<!-- codex-keepalive-marker -->`.

Acceptance criteria
- [ ] Exactly one keepalive mechanism is live.
- [ ] No keepalive activity on non-agent branches.
- [ ] No duplicate keepalive comments.

Topic GUID: 1a7a47c3-7a39-42c6-9b69-9c0b5a25f5f4

Why
Multiple nudgers cause duplicate comments and double dispatch; lack of branch scoping nudges the wrong PRs.

Scope
Keepalive listener logic and its comment behavior.

Non-Goals
No changes to belt step sizing or CI content.

Tasks
- [ ] Pick one keepalive path; disable the other.
- [ ] Add branch filter and marker-based comment upsert.

Acceptance criteria
- [ ] Single source of truth for nudges; clean comments.

Implementation notes
Files: `.github/workflows/agents-70-orchestrator.yml` and/or `.github/workflows/agents-75-keepalive-on-gate.yml` (whichever is active), `scripts/keepalive-runner.js`

Branch: codex/issue--keepalive-scope-single
PR title prefix: [Agents] Keepalive: scoped single path + marker upsert
Touch only: active keepalive workflow(s) and scripts/keepalive-runner.js

Copy/paste to PR comment (kickoff)
@{agent} use the scope, acceptance criteria, and task list so the keepalive workflow continues nudging until everything is complete. Work through the tasks, checking them off only after each acceptance criterion is satisfied, but check during each comment implementation and check off tasks and acceptance criteria that have been satisfied and repost the current version of the initial scope, task list and acceptance criteria each time that any have been newly completed.

4) Issue Sync: forbid auto‑applying agent labels; require exactly one manual agent:*

Title: Issue Sync: no auto agent selection; validate exactly one manual agent:* label
Labels: agents, automation, devops, ci, docs

Body:

Summary
Make the Issue Sync and Bridge refuse to proceed unless exactly one `agent:*` label is present on the Issue, selected manually. Do not auto-apply `agent:codex` (or any other). Copy/paste blocks must derive `@{agent}` from that single label.

Testing
- Issue with 0 agent labels: Sync/Bridge post a single “select exactly one agent:*” message and stop.
- Issue with 2+ agent labels: same refusal.
- Exactly one agent label: copy/paste shows correct @{agent} and listener triggers correctly.

CI readiness
- No required-check changes.

Automated Status Summary
Scope
- Issue Sync wrapper and Bridge label handling/validation.

Tasks
- [ ] Remove any auto-labeling of `agent:*` from Issue Sync.
- [ ] Validate exactly one `agent:*` label in Bridge before generating copy/paste.
- [ ] Document the policy in `docs/ci/ISSUE_SYNC.md`.

Acceptance criteria
- [ ] Manual selection only; validation enforced.
- [ ] Copy/paste mentions the correct `@{agent}` every time.

Topic GUID: 0d9eaa84-a9c2-4f56-a8d8-93fa5f2e36bc

Why
Auto-selecting agents creates mismatches and can launch the wrong automation.

Scope
Sync/Bridge label logic and docs.

Non-Goals
Changes to agent prompts.

Tasks
- [ ] Strip auto-labeling from Sync; enforce validation in Bridge.
- [ ] Add a short doc of the labeling rule.

Acceptance criteria
- [ ] Sync/Bridge refuse to proceed without exactly one label.
- [ ] `@{agent}` is always derived from the selected label.

Implementation notes
Files: `.github/workflows/agents-63-chatgpt-issue-sync.yml`, `.github/workflows/reusable-agents-issue-bridge.yml`, `docs/ci/ISSUE_SYNC.md`

Branch: codex/issue--issue-sync-manual-agent
PR title prefix: [Bridge] Manual agent selection enforced
Touch only: .github/workflows/agents-63-chatgpt-issue-sync.yml, .github/workflows/reusable-agents-issue-bridge.yml, docs/ci/ISSUE_SYNC.md

Copy/paste to PR comment (kickoff)
@{agent} use the scope, acceptance criteria, and task list so the keepalive workflow continues nudging until everything is complete. Work through the tasks, checking them off only after each acceptance criterion is satisfied, but check during each comment implementation and check off tasks and acceptance criteria that have been satisfied and repost the current version of the initial scope, task list and acceptance criteria each time that any have been newly completed.

5) Ledger hygiene: treat base as informational and migrate stale main to default

Title: Ledger hygiene: migrate base from main to repo default and ignore ledger base at runtime
Labels: agents, automation, ci, devops, docs, agent:codex

Body:

Summary
Prevent the ledger’s `base` field from reintroducing `main` drift. Migrate old ledgers to the current repo default and ensure Worker uses runtime base, not the ledger field, for checkout/fetch.

Testing
- Ledger with base: main in a repo whose default != main: Worker uses computed default, not ledger base.
- Migration job updates ledger base to current default.
- CI check fails if new ledgers write `base: main` when default != main.

CI readiness
- Add a tiny validation script to Gate; no required-check changes.

Automated Status Summary
Scope
- Ledger writers/readers in Worker; a small migration/validator.

Tasks
- [ ] Worker: ignore ledger.base for checkout; always compute base at runtime.
- [ ] Add a migration script to update `.agents/issue-*/ledger.yml` base to the current default.
- [ ] Add a CI validator to flag ledgers that set base != current default.

Acceptance criteria
- [ ] Worker never trusts ledger base for git operations.
- [ ] Existing ledgers no longer reference `main` unless it is the default.
- [ ] CI flags out-of-date ledger base values.

Topic GUID: 6bc9c04e-13ba-4497-97bf-1d8a977f4bf3

Why
Even after fixing the Worker, a stale `base: main` in ledgers can mislead future tooling or humans.

Scope
Worker ledger read path, small migration and CI validator.

Non-Goals
Changing the ledger schema beyond `base` semantics.

Tasks
- [ ] Guard Worker against using ledger.base for git.
- [ ] Add `scripts/ledger_migrate_base.py` and a CI step.
- [ ] Document the rule in the ledger spec.

Acceptance criteria
- [ ] No runtime git operation depends on ledger.base.
- [ ] Ledgers reflect the actual default branch.

Implementation notes
Files: `.github/workflows/agents-72-codex-belt-worker.yml`, `scripts/ledger_migrate_base.py`, `docs/ci/LEDGER.md`

Branch: codex/issue--ledger-base-hygiene
PR title prefix: [Agents] Ledger base hygiene
Touch only: .github/workflows/agents-72-codex-belt-worker.yml, scripts/ledger_migrate_base.py, docs/ci/LEDGER.md

Copy/paste to PR comment (kickoff)
@{agent} use the scope, acceptance criteria, and task list so the keepalive workflow continues nudging until everything is complete. Work through the tasks, checking them off only after each acceptance criterion is satisfied, but check during each comment implementation and check off tasks and acceptance criteria that have been satisfied and repost the current version of the initial scope, task list and acceptance criteria each time that any have been newly completed.
