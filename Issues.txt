1. Keepalive activation reâ€‘hydration & gate hardening (fix regression): Gate workflow_run trigger, persisted firstâ€‘activation (agents:activated), strict Gate=success, perâ€‘PR runâ€‘cap; no noise when blocked

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
After we moved the keepalive preâ€‘gates (label + human @agent + Gate finished + under runâ€‘cap) in front of posting/dispatch, firstâ€‘run activation could be suppressed when the human @agent comment arrived before Gate finished. Because there was no â€œGate finished â†’ reâ€‘evaluateâ€ trigger (or persisted firstâ€‘activation intent), nothing reâ€‘armed the pipeline, and the keepalive appeared dead.
We must:

reâ€‘activate automatically on Gate completion,

remember that a PR has been firstâ€‘activated (agents:activated) so later rounds donâ€™t require a fresh human @agent, and

harden the gate to Gate = success (conclusion) with a perâ€‘PR runâ€‘capâ€”while producing no PR noise when blocked.

Scope
Implement the following controlâ€‘plane behaviors:

Firstâ€‘activation persists: On the first valid human @agent, add label agents:activated. Thereafter, do not require a new human @agent for subsequent rounds on that PR.

Gate completion wakes keepalive: Add a workflow_run trigger on the Gate workflow (types: [completed]). When Gate finishes with conclusion='success', reâ€‘evaluate preâ€‘gates and, if satisfied, start the first keepalive round (or next round if already activated).

Strict Gate policy: The gate check must require status='completed' AND conclusion='success' for the PRâ€™s current head SHA of the working branch.

Perâ€‘PR runâ€‘cap: Limit concurrent runs per PR to a cap:

default 2,

override by label agents:max-runs:X where X âˆˆ [1..5].
Count only this PRâ€™s Orchestrator/Worker runs with status âˆˆ {queued, in_progress}.

Label controls respected:

Require agents:keepalive for first and subsequent rounds; removing it stops any new instruction/dispatch until restored.

(Optional existing controls like agents:pause continue to pause everything.)

Noâ€‘noise rule: When any preâ€‘gate fails (label missing, Gate not success, cap reached, firstâ€‘run without human @agent), do not post comments. Write only a concise reason in the run summary.

Instruction poster unchanged (except for gating placement): Once gates pass, create a new instruction comment (never edit), post as stranske (ACTIONS_BOT_PAT; fallback SERVICE_BOT_PAT), with required hidden markers + TRACE and @<agent> derived from the PRâ€™s agent:* label.

Nonâ€‘Goals

Changing acceptanceâ€‘criteria content or Gateâ€™s internal tests

Rewriting branchâ€‘sync automation (already handled by the separate postâ€‘work module)

Replacing current ack/dedupe behavior (ğŸš€ reaction) or status/checklist updater

Tasks

- Shared gate helper (.github/scripts/keepalive_gate.js)

  - Add/confirm functions:

  - evaluateKeepaliveGate({ prNumber, headSha, requireHumanActivation }) â†’ returns { ok, reason, cap, active, primaryAgent, hasKeepaliveLabel, hasActivatedLabel }.

  - Human requirement logic: requireHumanActivation is true only when agents:activated is absent (first activation). Otherwise itâ€™s waived.

  - Gate success: Resolve the Gate workflow run for the current head SHA. Require status='completed' && conclusion='success'. If missing: reason='gate-run-missing'.

  - Runâ€‘cap (perâ€‘PR): Derive cap from agents:max-runs:X label (default 2). Count only this PRâ€™s Orchestrator/Worker runs (queued + in_progress). Return active and cap.

  - Agent aliasing: Build allowed aliases from PR labels agent:* (strip the prefix). The human activation detector must match @<alias> (caseâ€‘insensitive) authored by a human (user.type==='User') in issue_comment.created.

- PRâ€‘meta (.github/workflows/agents-pr-meta.yml)

  - On issue_comment.created (PRs only):

    - Call gate first with requireHumanActivation: true. If ok=false â†’ stop (no comment/dispatch), write oneâ€‘line summary:
      GATE: ok=false reason=<reason> pr=#<n> agent=<alias> cap=<cap> active=<active>

    - If ok=true and agents:activated absent â†’ add label agents:activated.

    - Proceed with your existing detection (hidden markers + ğŸš€ dedupe) and dispatch:

    - workflow_dispatch â†’ Agentsâ€‘70 Orchestrator (include options_json with { keepalive_trace, round, pr }).

    - repository_dispatch (codex-pr-comment-command) for the connector with { issue, base, head, comment_id, comment_url, agent } using ACTIONS_BOT_PAT.

  - Add a new job keepalive_from_gate:

    - on: workflow_run for workflow Gate, types: [completed].

    - if: github.event.workflow_run.conclusion == 'success'.

    - Resolve the linked PR (from workflow_run.pull_requests[0]) and call the same gate with requireHumanActivation: true.

    - If ok=true: add agents:activated if missing; then dispatch Orchestrator and connector exactly as above.

    - Always write the oneâ€‘line summary with gate outputs.

- Orchestrator (.github/workflows/agents-70-orchestrator.yml)

  - Before posting the next instruction: call the same gate with requireHumanActivation: false.

    - If ok=false: do not post an instruction or dispatch; write the same oneâ€‘line summary; exit 0.

    - If ok=true: proceed to create a new instruction comment (createâ€‘notâ€‘edit), post as stranske with ACTIONS_BOT_PAT (fallback SERVICE_BOT_PAT), include required markers + TRACE and @<agent> from labels, then continue with ack/fallback as already implemented.

- Visibility (both workflows)

  - Add the singleâ€‘line gate summary to $GITHUB_STEP_SUMMARY for every evaluation:
    GATE: ok=<bool> reason=<code> pr=#<n> agent=<alias> cap=<cap> active=<active> head=<sha:7>

  - Do not post these as PR comments unless a debug label (e.g., agents:debug) is present.

Acceptance criteria

- First activation race fixed: If a human @<agent> comment occurs before Gate finishes, no instruction is posted immediately. When Gate completes successfully, the workflow_run job reâ€‘evaluates gates, adds agents:activated (if missing), and starts the first keepalive round (instruction comment created as stranske, markers + TRACE present, ğŸš€ ack observed).

- Human @agent is firstâ€‘run only: After agents:activated is present, subsequent keepalive rounds do not require a new human comment. The gate summary shows ok=true with reason=ok even if no newer human @agent exists.

- Strict Gate: Keepalive does not post/dispatch unless Gate conclusion='success' for the current head SHA. If Gate is missing/cancelled/failing, the gate summary shows the appropriate reason and no PR comment is created.

- Perâ€‘PR runâ€‘cap works: With no agents:max-runs:X label, cap 2 is applied; with agents:max-runs:3, cap 3 is applied. The gate summary shows cap and active. Runs from other PRs do not count against this PR.

- Label controls respected: Removing agents:keepalive prevents any new instruction or dispatch. Restoring it reâ€‘enables keepalive (subject to other gates).

- No noise when blocked: When any gate fails, no instruction comment is posted and no connector dispatch is sent; the only output is the oneâ€‘line gate summary in the runâ€™s Summary.

- Instruction comment contract unchanged: When allowed, the poster creates a new comment (not edit), authored as stranske (ACTIONS_BOT_PAT; fallback SERVICE_BOT_PAT), with the three hidden markers and a unique TRACE, and tags the current agent from agent:* labels.

Implementation notes

Secrets: Use existing ACTIONS_BOT_PAT (preferred, posts as stranske) and SERVICE_BOT_PAT (fallback). Do not add new PATs.

Gate identification: Match the Gate workflow by id/name exactly; fetch runs by head SHA of the PRâ€™s head ref. Require status='completed' && conclusion='success'.

Runâ€‘cap (perâ€‘PR): When listing runs, filter by workflow name/id and ensure they belong to this PR (pass PR number via options_json and filter by that, or by head ref naming convention). Count only queued + in_progress.

Agent aliasing: Build allowed aliases from labels agent:* (e.g., agent:codex â†’ codex); then require a human comment body containing @<alias>.

Persisted activation: Add/remove agents:activated with the bot PAT; treat its presence as â€œfirstâ€‘activation satisfiedâ€ for this PR. Removing it (manually) makes the next start require a human @agent again.

Summaries: Always emit the gate line to $GITHUB_STEP_SUMMARY so operators can confirm why a round did or didnâ€™t fire without PR noise.
