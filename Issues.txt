1) Agents: Orchestrator can’t dispatch belt jobs (missing actions: write)

Labels: agents, automation, workflows, priority: high, risk: medium

Why
Scheduled Orchestrator runs fail to call Dispatcher/Worker because the caller lacks actions: write. No dispatch, no keepalive. Also ensure the workflow file lives on the default branch so the cron actually fires.

Scope
Grant minimal permissions, confirm schedule runs from default, and prove keepalive can reach Dispatcher/Worker.

Task List

 In agents-70-orchestrator.yml, add:

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write


 Ensure the workflow file exists on the repository’s default branch.

 Smoke test: run a workflow_dispatch of Orchestrator and verify it successfully invokes Dispatcher and Worker via workflow_call.

 Add a summary line: “Dispatch succeeded for N PRs; M skipped; K failures.”

Acceptance Criteria

A scheduled Orchestrator tick successfully calls Dispatcher/Worker without permission errors.

Run summary shows count of dispatched PRs with links.

No change to existing labels or agent prompts.

Out of Scope
Changing belt logic, Codex prompts, or acceptance-criteria formats.

2) Agents: Conveyor YAML parse error (duplicate id) blocks promotions

Labels: agents, automation, workflows, priority: high, risk: low

Why
The conveyor workflow has the same id used twice for a step, invalidating the entire workflow. Promotions never execute.

Scope
Fix the duplicate id and keep one authoritative “mode” step.

Task List

 In agents-73-codex-belt-conveyor.yml, ensure only one step defines id: mode.

 Actionlint pass on .github/workflows/**.yml.

 Dry run on a test PR: conveyor evaluates “mode,” logs dry-run vs live.

Acceptance Criteria

Workflow loads (no “duplicate id” error).

Conveyor run summary shows the resolved mode and target PR number(s).

No functional changes beyond making the file valid.

Out of Scope
Changing merge rules or branch-protection requirements.

3) Issue Bridge: deterministic keepalive opt-in (options_json or label)

Labels: agents, automation, workflows, priority: medium, risk: low

Why
Right now the keepalive decision depends on how poetic someone felt typing @codex. We need a machine-checkable switch so the bridge sets enable_keepalive without guessing.

Scope
Teach the Issue Bridge to set keepalive via either a sentinel phrase or a dedicated label, and pass it through to Orchestrator.

Task List

 In agents-63-codex-issue-bridge.yml (or its called script), detect one of:

 Comment containing a sentinel like [keepalive], or

 Presence of a agents:keepalive label on the Issue/PR.

 When opt-in is true, pass:

with:
  options_json: '{"keepalive":{"enabled": true}}'


when dispatching Orchestrator.

 When opt-in is false, explicitly pass enabled: false to avoid drift.

 Update the PR body header to state the current mode: “Keepalive: ON/OFF”.

Acceptance Criteria

Version A: @codex without sentinel or label runs once; no later keepalive ticks affect the PR.

Version B: sentinel or label present triggers recurring keepalive cycles until AC complete.

PR body shows the mode string and stays consistent with reality.

Out of Scope
Re-writing prompts or the belt’s internal step ordering.

4) CI: unify coverage publisher and signals under one reusable job; Gate is authoritative

Labels: ci, workflows, priority: medium, risk: low, testing

Why
Coverage and status bounces between Gate and Post-CI produce drift and duplicate work. Gate should coordinate a single reusable CI job that publishes coverage once; Post-CI only reads and summarizes.

Scope
Fold ruff, type checks, pytest+coverage into reusable-10-ci-python.yml; Gate orchestrates; Post-CI reads.

Task List

 Ensure reusable-10-ci-python.yml:

 Runs ruff (lint/format check), type checks, and pytest with coverage on py311/py312.

 Uploads a single artifact at a stable path (e.g., artifacts/coverage/coverage.xml plus coverage.json).

 In pr-00-gate.yml, call only the reusable job(s), keep docs-only fast-pass and Docker-only smoke.

 In Post-CI, remove any coverage repackaging or re-publishing; consume the one artifact and summarize.

 Actionlint and job summaries updated accordingly.

Acceptance Criteria

Exactly one coverage artifact producer per PR.

Gate status “Gate / gate” is the only required status in branch protection.

Post-CI comment shows lint, types, tests, coverage using the single artifact.

Out of Scope
Adding more Python versions or exotic test shards.

5) Autofix: single opt-in path from Post-CI; normalize label name

Labels: autofix, workflows, ci, priority: medium, risk: low

Why
Two different entry points make double commits and finger-pointing. Keep one path: Post-CI invokes the autofix reusable when a PR has the appropriate label. Also stop arguing with yourself about the label string.

Scope
Consolidate to Post-CI as sole invoker and pick a single label, e.g., autofix:clean.

Task List

 Remove the separate PR-scoped Autofix workflow or strip its logic so it’s inert.

 In maint-46-post-ci.yml, call the autofix reusable only when PR has autofix:clean.

 Normalize code to a single label value; remove fallbacks and environment defaults that disagree.

 Post a one-shot “Autofix applied” comment with the file list and a link to the rerun Gate checks.

Acceptance Criteria

Only one workflow can perform autofix on a PR, guarded by autofix:clean.

No duplicate “fix” commits for the same event.

Gate reruns after autofix and status surfaces in the Post-CI summary.

Out of Scope
Adding new fix-it rules beyond formatting and trivial lint.

6) Repo health: verify branch protection requires “Gate / gate”

Labels: ci, health:repo, workflows, priority: medium, risk: low

Why
If someone renames or un-checks required statuses, the guardrails vanish quietly. We need a weekly assertion that branch protection still requires the single Gate status.

Scope
Read branch-protection via API, fail loudly if “Gate / gate” is not required.

Task List

 In the repo-health workflow, add a step that fetches branch protection for the default branch and verifies required status checks include exactly “Gate / gate”.

 On drift, fail the job and post an actionable summary with current vs expected checks.

 Add a short, “what to fix” pointer in the summary.

Acceptance Criteria

Weekly health run shows current branch-protection settings and passes when “Gate / gate” is required.

On mismatch, job fails with explicit diff of required checks.

Out of Scope
Changing the name of the Gate job or adding secondary required checks.

7) Docs: codify the target workflow layout and the keepalive switch

Labels: documentation, docs, workflows, priority: low, risk: low

Why
Future you will forget which toggle wakes the robots. Document the topology and the two Codex modes in one place.

Scope
Write a single page and link to workflow files.

Task List

 Add docs/ci/WORKFLOWS.md with:

 PR checks topology (Gate, reusable CI, Docker smoke, Post-CI).

 Agents control plane: Orchestrator scheduled, belt callable only.

 Keepalive switch: sentinel phrase [keepalive] or agents:keepalive label, and how the bridge passes options_json.

 Branch-protection requirement and the health check.

 Link to each workflow YAML for quick navigation.

Acceptance Criteria

One markdown page explains how to run Version A (manual) and Version B (keepalive), including labels used and expected run order.

Contributors can follow it and not summon chaos by accident.

Out of Scope
A novel on why YAML is not a real programming language.
