1. Agents keepalive: always create a new instruction comment with required hidden markers and TRACE

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
PRâ€‘meta only listens to issue_comment.created. When the keepalive updater edits an existing status/checklist comment, no event is emitted, so the detector never runs and the loop stalls. Separately, detection requires hidden markers; when theyâ€™re missing, keepalive is ignored. We must make it impossible to post anything other than a brandâ€‘new instruction comment that includes the required markers on each round.

Scope

For every keepalive round, create a new instruction comment (do not edit any prior bot comment).

Always include hidden markers at the top of the comment body:

<!-- keepalive-round: {N} -->

<!-- codex-keepalive-marker -->

<!-- keepalive-trace: {TRACE} -->

Visible content must begin with @codex followed by the current scope / tasks / acceptance criteria the agent should act on.

Nonâ€‘Goals

Changing Gate semantics, acceptance criteria, labels, or agent selection

Modifying the separate status/checklist updater (it may continue to edit the status block)

Tasks

- In the keepalive poster (Codex Keepalive Sweep):

  - Generate a unique KEEPALIVE_TRACE (e.g., epochâ€‘second + short random suffix).

  - Compute the next round number; do not infer it from an edited comment.

  - Use peter-evans/create-issue-comment@v3 (or Octokit issues.createComment) to create a new comment with body:

    <!-- keepalive-round: {N} -->
    <!-- codex-keepalive-marker -->
    <!-- keepalive-trace: {TRACE} -->
    @codex Continue with the remaining tasks; reâ€‘post the Scope/Tasks/Acceptance block and check off only when acceptance criteria are satisfied.

    <Scope/Tasks/Acceptanceâ€¦>

  - Authenticate with the bot PAT that posts as stranskeâ€‘automationâ€‘bot.

  - Write Round = N and TRACE = â€¦ into the step summary for correlation.

Acceptance criteria

- Each keepalive cycle adds exactly one new bot comment (no edits) whose body starts with the three hidden markers and an @codex instruction.

- An issue_comment.created run appears in Actions showing author = stranskeâ€‘automationâ€‘bot.

- The posted comment contains the current Scope/Tasks/Acceptance block.

- The posterâ€™s step summary shows Round and TRACE values.

Implementation notes

Likely touchpoint: the job or helper that posts â€œKeepalive Round Nâ€ (inside Agents 70 Orchestrator / â€œCodex Keepalive Sweepâ€).

Keep the existing status/checklist updater unchanged; this issue governs only the instruction comment.

2. Keepalive pipeline: PRâ€‘meta detection + dispatch with dedupe; Orchestrator carries TRACE, avoids cancel, and posts skip reasons

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
After #3246 and #3251, the detector script is present and PRâ€‘meta checks out the repo. We need to lock in the invariants so once a proper instruction comment is created, the system either dispatches the next round or emits a clear, machineâ€‘readable reason (no silent stalls), and multiple triggers donâ€™t cause duplicates.

Scope

PRâ€‘meta (on issue_comment.created for PRs):

Author allowâ€‘list includes stranske-automation-bot and designated maintainers (current list is fine).

Require both hidden markers (codex-keepalive-marker and keepalive-round: N).

Extract N, TRACE, PR #, base and head.

Dedupe by adding ğŸš€ reaction to the comment; skip if already present.

If valid, set outputs and:

Dispatch Agents 70 Orchestrator with options_json carrying { keepalive_trace, round, pr }.

Dispatch repository_dispatch codex-pr-comment-command with { issue, base, head, agent:'codex', comment_id, comment_url }.

Write a Keepalive detection summary table (ok | reason | round | trace | pr).

Orchestrator (Agents 70):

Accept options_json; parse TRACE, ROUND, PR.

Set concurrency.cancel-in-progress = false and key the group to keep different traces from canceling each other.

Before any early exit (Gate not green, labels missing, branch mismatch, no human assignees after filtering bots, etc.), post a oneâ€‘line PR comment:
**Keepalive {round}** \{trace}` skipped: <reason-code>` and write the same to the job summary.

Proceed to belt/worker when keepalive is enabled, even if a PR already exists.

Nonâ€‘Goals

Changing Gate logic, acceptance criteria content, or connector semantics

Accepting issue_comment.edited as a trigger (creation only)

Tasks

- PRâ€‘meta (.github/workflows/agents-pr-meta.yml):

  - Confirm actions/checkout@v4 precedes the detection script (already present; keep it).

  - Ensure the detector enforces markers + allowâ€‘list, sets outputs, and adds ğŸš€ reaction for dedupe.

  - Ensure createWorkflowDispatch to Agents 70 Orchestrator includes options_json with keepalive_trace, round, pr.

  - Ensure repos.createDispatchEvent emits codex-pr-comment-command with the comment metadata (id/url) and resolved base/head, using ACTIONS_BOT_PAT.

  - Keep the summary table emission.

- Orchestrator (.github/workflows/agents-70-orchestrator.yml):

  - Parse options_json and export TRACE, ROUND, PR to env.

  - Set concurrency to avoid canceling distinct keepalive runs.

  - Implement explicit guard checks and always post the oneâ€‘line â€œskipped: reasonâ€‘codeâ€ comment + step summary on early exit.

  - Filter assignees to exclude bot/app logins; skip assignment gracefully if no eligible humans remain.

  - Run worker when keepalive is enabled.

Acceptance criteria

- On a test PR with agents:keepalive and agent:codex:

  - A proper instruction comment (from Issue 1) yields a PRâ€‘meta run with ok: true, reason: keepalive-detected, and populated round, trace, pr.

  - Exactly one Orchestrator run starts via workflow_dispatch carrying that TRACE; earlier keepalive runs arenâ€™t canceled.

  - listen_commands emits a single codex-pr-comment-command with the correct comment_id/comment_url and resolved base/head.

  - If any guard fails, the PR shows **Keepalive {round}** \{trace}` skipped: <reason-code>`; the same appears in the run summary.

  - Two consecutive keepalive rounds produce two distinct traces, two orchestrator runs, and no duplicates; neither run is silently canceled.

Implementation notes

Keep the current author allowâ€‘list (stranske-automation-bot, chatgpt-codex-connector, maintainers).

ACTIONS_BOT_PAT must have repo + workflow scope (already set).

The detectorâ€™s hidden marker string is currently <!-- codex-keepalive-marker -->; donâ€™t rename without updating both the poster and detector.
