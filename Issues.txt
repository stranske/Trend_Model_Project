1. Keepalive controlâ€‘plane: enforce label + human @agent + Gate concluded + runâ€‘cap (default 2; labelâ€‘driven), respect label removal; never post when preconditions fail

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
Keepalive has started firing but does not strictly obey the protocol. We must guarantee it never posts or dispatches unless all preconditions are met, limits concurrent runs (default 2; optionally labelâ€‘driven), stops when the keepalive label is removed, derives @agent dynamically from labels (no hardâ€‘coding), and creates no comments when blocked. These guards must be enforced before any new instruction comment or dispatch.

Scope

- Enforce all of the following preconditions before the first keepalive run on a PR and before each subsequent round:

  - PR has the keepalive label (e.g., agents:keepalive).

  - A human comment exists on the PR with an @agent mention where <agent> matches an agent:* label on the PR (no hardâ€‘coding of agent names).

  - Gate has concluded on the current head SHA (state = completed).

  - Runâ€‘cap not exceeded for this PR (default 2; override by label agents:max-runs:X).

- Label removal pauses: if agents:keepalive is removed, block any new keepalive posts/dispatches until restored.

- Noâ€‘noise rule: when any precondition fails or runâ€‘cap is reached, do not post PR comments; only write a succinct reason in the job summary.

- Instruction comments, when allowed, must be created (not edited) and posted as stranske using ACTIONS_BOT_PAT (fallback to SERVICE_BOT_PAT), and must start with the required hidden markers and TRACE (see Implementation notes).

Nonâ€‘Goals

- Changing Gate logic beyond â€œconcludedâ€; (optional stricter policy may be added later by label)

- Changing acceptanceâ€‘criteria content or belt/worker behavior

- Editing the separate â€œstatus/checklistâ€ comment (it may continue to be edited; this issue governs instruction comments only)

Tasks

- Shared preâ€‘gate helper (new or expand existing JS used via actions/github-script):

  - Inputs: PR number, head SHA, labels, recent comments.

  - Checks:

    - hasKeepaliveLabel: PR has agents:keepalive.

    - hasHumanActivation: any nonâ€‘bot issue_comment.created contains @<alias> where <alias> âˆˆ { all PR labels with prefix agent: stripped }.

    - gateConcluded: Gate check on head SHA has status=completed.

    - underRunCap: count inâ€‘progress/queued Orchestrator runs for this PR < cap where cap = label agents:max-runs:X or 2 by default.

  - Output booleans and a single reason string when blocked.

- Agents PR meta manager (issue_comment.created path):

  - Before detection/dispatch, call preâ€‘gate helper. If blocked â†’ exit (no comment/dispatch), write reason to $GITHUB_STEP_SUMMARY.

  - For first activation on a PR, require hasHumanActivation == true. For later rounds, hasHumanActivation is not reâ€‘required (label + gate + cap still required).

- Agents 70 Orchestrator (before posting the next instruction):

  - Call the same preâ€‘gate helper with the current PR/head. If blocked â†’ do not post an instruction comment or dispatch; write reason to $GITHUB_STEP_SUMMARY.

- Instruction poster (still within Orchestrator keepalive sweep):

  - Post as stranske using ACTIONS_BOT_PAT; if unavailable, fallback to SERVICE_BOT_PAT.

  - Create a new instruction comment (never edit); body must begin with:

    <!-- keepalive-round: {N} -->
    <!-- codex-keepalive-marker -->
    <!-- keepalive-trace: {TRACE} -->
    @<agent> â€¦instructionsâ€¦

    then include the Scope / Tasks / Acceptance block.

    - Record Round, Trace, Author, CommentId into $GITHUB_STEP_SUMMARY.

    - (Ack/fallback behavior is handled by existing logic and is not changed in this issue.)

Acceptance criteria

- With no agents:keepalive label: keepalive posts/dispatches are suppressed; the run summary shows reason=keepalive-label-missing; no PR comment is created.

- With label but no human @agent on the PR: firstâ€‘run activation is suppressed; summary shows reason=no-human-activation; no comment. (Subsequent rounds do not require a new human activation.)

- With Gate not concluded on head SHA: keepalive is suppressed; summary shows reason=gate-not-concluded; no comment.

- With runâ€‘cap reached (e.g., 2 active runs and agents:max-runs absent): further rounds are suppressed; summary shows reason=run-cap-reached; no comment.

- When all preconditions are satisfied: an instruction comment is created (not edited) and authored by stranske (via ACTIONS_BOT_PAT, else bot), starting with the three hidden markers + TRACE and @<agent> (alias from PR labels).

- Removing agents:keepalive during a PR prevents any new instructions/dispatches until the label returns.

Implementation notes

Files to touch (typical in this repo):

.github/workflows/agents-pr-meta.yml â€” call preâ€‘gate before detection/dispatch; accept stranske/bot authors.

.github/workflows/agents-70-orchestrator.yml â€” call preâ€‘gate before posting next instruction; ensure poster uses ACTIONS_BOT_PATâ†’SERVICE_BOT_PAT.

.github/scripts/keepalive_gate.js (new helper) â€” implement the shared checks.

Secrets: use existing ACTIONS_BOT_PAT (preferred) and SERVICE_BOT_PAT.

Counting runs: query Actions API for Orchestrator (workflow_id/name) filtered by PR and status âˆˆ {queued,in_progress}.

Agent aliasing: build the allowed set from PR labels agent:*; match @<alias> against that set (caseâ€‘insensitive).

Do not log secrets or connector URLs.

2. Keepalive branchâ€‘sync automation: if agent â€œdoneâ€ but no commit, autoâ€‘trigger updateâ€‘branch; else createâ€‘pr + autoâ€‘merge; retry/pause without human clicks

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
When a human initiates work, the agent may complete work in its own sandbox. The PR shows â€œdone,â€ but if the agent hasnâ€™t pushed to the PR branch yet, the head SHA doesnâ€™t change and subsequent rounds repeat old work. Manually clicking â€œUpdate Branchâ€ (or â€œCreate PRâ€ then merge) on the agentâ€™s external URL fixes itâ€”but that blocks full automation. We need a headless sequence that: (1) detects this condition, (2) tries updateâ€‘branch, (3) if needed, triggers createâ€‘pr then autoâ€‘merges it, and (4) only then allows the next keepalive round.

Scope

- Trigger after an agent round completes (connector â€œdoneâ€ reply or worker end) and before posting the next instruction:

  - Detect â€œno commit landedâ€: head SHA unchanged since the last instruction / round.

  - If branch unchanged and connector supports it, dispatch action: update-branch to the connector (repoâ€‘dispatch) and poll for a new commit within TTL (e.g., 2â€“5m).

  - If branch changed during the agent run (or updateâ€‘branch not possible), dispatch action: create-pr to the connector, then autoâ€‘merge the resulting PR back into the working branch and delete the temp branch; poll again for the head SHA to change.

  - If still unchanged, pause with label agents:sync-required and do not post the next instruction; write a oneâ€‘line escalation with {trace} only when agents:debug label is present (otherwise summaryâ€‘only).

- All actions must be logged (step summary) with the current {trace} and concise outcomes.

Nonâ€‘Goals

- Building private API integrations to external services beyond supported repository_dispatch or recognized comment commands

- Modifying connector behavior other than via repoâ€‘dispatch or posting a recognized command comment

Tasks

- Detector (Orchestrator or PRâ€‘meta postâ€‘work phase):

  - Capture previous head SHA at instruction time; after â€œdone,â€ poll PR head SHA for TTL_short (e.g., 60â€“120s). If unchanged â†’ continue.

- Updateâ€‘branch attempt:

  - Emit repository_dispatch used by your connector (e.g., codex-pr-comment-command) with payload { action: 'update-branch', issue, base, head, comment_id, comment_url, agent }.

  - Poll head SHA for TTL_long (e.g., 2â€“5m with backoff). If changed â†’ success; record in summary with {trace}.

- Createâ€‘pr + autoâ€‘merge:

  - Emit repoâ€‘dispatch { action: 'create-pr', â€¦ }.

  - Poll for a new PR from the connectorâ€™s branch (search by title/label/source); when found, autoâ€‘merge (squash/merge method configurable), then delete the temp branch.

  - Poll head SHA again; on success, record outcome with {trace}.

- Escalation (still no commit):

  - Add label agents:sync-required; do not post the next keepalive instruction.

  - If agents:debug is present, post one line:
    **Keepalive {round}** \{trace}` escalation: agent â€œdoneâ€ but branch unchanged after updateâ€‘branch/createâ€‘pr attempts.`

  - Always write outcome to $GITHUB_STEP_SUMMARY.

Acceptance criteria

- When agent says â€œdoneâ€ but the PR head SHA is unchanged, the system attempts updateâ€‘branch; if it succeeds, a new commit appears and the next instruction is allowed.

- If updateâ€‘branch isnâ€™t possible or fails (e.g., head changed midâ€‘run), the system triggers createâ€‘pr, merges it back to the working branch, and the PR head SHA changes accordingly.

- If neither succeeds within TTL_long, the system applies agents:sync-required, suppresses the next instruction, and logs the escalation (PR oneâ€‘liner only in debug mode).

- No human clicks are required for any of the above.

- Two consecutive rounds that require sync integrate successfully without repeating the same work.

Implementation notes

Files: typically .github/workflows/agents-70-orchestrator.yml (postâ€‘work phase) and the connector dispatch logic you already use (e.g., codex-pr-comment-command).

Secrets: use ACTIONS_BOT_PAT for repoâ€‘dispatch; do not log payloads.

Connector command compatibility: if repoâ€‘dispatch isnâ€™t honored, post the equivalent comment command the connector recognizes (e.g., /update-branch, /create-pr), then follow the same polling/merge logic.

Whitelist & redact any external URLs the connector returns; never echo them in logs.

3.Add a Canonical Doc Describing the Keepalive Goals and Plumbing

Labels: agents, agents:keepalive, ci, automation, docs

Why
Agents get confused about the purpose of the keepalive and loose focus on the task goals. The canonical document provides enhancemed memory for the agents working on the task.

Scope

- Guidelines and Goals for the Keepalive 

Nonâ€‘Goals

- Providing goals or instructions for anything besisde the keepalive.

Tasks

- Add the document in the implementation notes to docs and label it for agents in a way that reminds them to consult it any time work is done on the keepalive.

Acceptance criteria

- The document has been uploaded to docs and included in any other documentation in the repo where it belongs

Implementation notes

Title: Keepalive â€” Goals & Plumbing (canonical reference)

Purpose
Drive an iterative, handsâ€‘off loop where an agent continues working on a PR in small, verifiable increments until all acceptance criteria are metâ€”while guaranteeing safety rails and predictable behavior.

Activation contract (first fire for a PR)
Keepalive must not post or dispatch for the first time on a PR unless all are true:

PR label present: agents:keepalive

Human initiation present: at least one human issue_comment.created on the PR that @mentions an agent (e.g., @codex, @claude), where the agent name is taken dynamically from the PRâ€™s agent:* label(s). No hardâ€‘coding of agent names.

Gate completed: the Gate workflow for the current head SHA has conclusion = success (or an explicit allowâ€‘list of acceptable conclusions).

Repeat contract (round N â†’ N+1)
Before keepalive posts the next instruction comment or dispatches another agent run:

The three preconditions above are still true, and

The runâ€‘cap for this PR is not exceeded, and

The branchâ€‘sync gate (below) says the agentâ€™s previous â€œworkâ€ is now actually reflected on the PR branch.

Run cap
Limit concurrent agent runs per PR:

Config via label: if the PR has a label like agents:max-parallel:K, use K (integer, 1â€“5).

Default: 2 if no label is present.

Enforced as: â€œnumber of inâ€‘progress Orchestrator/Worker runs for this PRâ€ < cap. If at cap, keepalive does not post a new instruction or dispatch; it exits quietly (or writes a step summary only).

Pause / stop control

Removing agents:keepalive must stop any new agent runs & prevent keepalive comments.

Optionally respect a stronger â€œhard pauseâ€ label agents:pause that prevents all keepalive activity, including any fallbacks.

Noâ€‘noise rule
If preconditions arenâ€™t met (label missing, no human @agent yet, Gate not green, cap reached), keepalive must not post new comments. It may write a runâ€‘summary for operators, but no PR noise.

Instruction comment contract
When keepalive is allowed to post:

Create a new instruction comment (never edit a status comment).

Author: post as stranske using ACTIONS_BOT_PAT (preferred); fallback to SERVICE_BOT_PAT (posts as the automation bot).

Body must start with these hidden markers + trace id, then the visible instruction:

<!-- keepalive-round: {N} -->
<!-- codex-keepalive-marker -->
<!-- keepalive-trace: {TRACE} -->
@<agent> Continue with the remaining tasks. Reâ€‘post Scope/Tasks/Acceptance and check off only when acceptance criteria are satisfied.

<Scope/Tasks/Acceptance block>


After posting, the system adds ğŸ‘€ to the comment and expects PRâ€‘meta to add ğŸš€ (ack) within a short TTL.

Detection & dispatch

PRâ€‘meta listens to issue_comment.created and accepts authors: stranske or the automation bot.

Requires the hidden markers; dedupes via ğŸš€; then dispatches both:

workflow_dispatch â†’ Agentsâ€‘70 Orchestrator (with options_json containing {round, trace, pr}).

repository_dispatch (codex-pr-comment-command) for the connector, with {issue, base, head, comment_id, comment_url, agent}.

PRâ€‘meta writes a small summary table per event (ok | reason | author | pr | round | trace).

Branchâ€‘sync gate
Before posting the next instruction for a round, require that the PR head moved (work landed). If not, attempt automation and only then proceed:

If head SHA unchanged after the agent reports â€œdone,â€ scan the agentâ€™s last reply for an â€œUpdate Branchâ€ / â€œCreate PRâ€ URL (known patterns per connector), call it automatically, and poll the PR for a new commit (short TTL).

If still unchanged, try a secondâ€‘chance path (e.g., the â€œCreate PRâ€ route if â€œUpdate Branchâ€ is no longer allowed), then poll again.

If still unchanged, pause keepalive and add a label agents:sync-required (no instruction post, no dispatch). A short, singleâ€‘line PR comment with the {trace} may be allowed only when a debug label (e.g., agents:debug) is present.

Orchestrator invariants

No selfâ€‘cancellation: cancel-in-progress: false; concurrency keyed by {pr}-{trace}.

Explicit bails: on any early exit (precondition missing, run cap reached, Gate not green, branchâ€‘sync unresolved), write a oneâ€‘line reason to the runâ€‘summary and (optionally, when debug label exists) a terse PR comment:

**Keepalive {round}** \{trace}` skipped: <reason-code>`

Assignees: ignore bot/app accounts; if no humans remain, skip gracefully; do not fail the round.

Removing and then re-adding agents:keepalive will restart the keepalive functionality as long as all criteria have been met

Success condition
Stop when all acceptance criteria are checked complete; optionally remove agents:keepalive and add agents:done.
