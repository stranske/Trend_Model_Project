1) Future-proof timezone dtype checks in sample window builder
Labels: agent:codex, bug, backend
Why
`pipeline._build_sample_windows` still calls the deprecated `pd.api.types.is_datetime64tz_dtype`, which pandas plans to drop; timezone-aware datasets will raise before window construction once the API is removed.
Scope
- `pipeline._build_sample_windows` dtype guard and adjacent sample-window tests that exercise timezone-aware inputs.
Tasks
- Replace the dtype check with a supported alternative (e.g., `isinstance(dtype, pd.DatetimeTZDtype)` or `DatetimeTZDtype.is_dtype`) while keeping behaviour identical for tz-aware and naive indexes.
- Add regression coverage for tz-aware datasets that verifies window construction works without deprecation warnings on current pandas.
- Confirm downstream consumers of the window metadata remain unchanged by the updated dtype handling.
Acceptance criteria
- Sample window construction succeeds for timezone-aware and naive inputs on current pandas without emitting dtype deprecation warnings.
- Tests cover tz-aware inputs and pass without altering downstream window metadata semantics.
Implementation notes
- Focus on `_build_sample_windows` and its dtype guard; avoid unrelated pipeline changes.

2) Remove deprecated `mode.use_inf_as_na` usage in cadence validation
Labels: agent:codex, bug, data
Why
Market data cadence validation relies on pandas' deprecated `mode.use_inf_as_na` context manager; once removed, cadence checks will raise before emitting diagnostics, and inf handling will regress.
Scope
- Cadence validation path in `io/market_data.py` and its associated cadence/inf handling tests.
Tasks
- Normalize infinite values prior to cadence calculation (e.g., replace `np.inf` and `-np.inf` with `NaN`) and drop reliance on the deprecated mode flag.
- Ensure cadence validation still reports the same diagnostics for valid and invalid inputs after the inf-normalization change.
- Add tests covering inputs with `inf`/`-inf` values to confirm the new path handles them without using `mode.use_inf_as_na`.
Acceptance criteria
- Cadence validation runs without using deprecated pandas options and preserves current diagnostic outputs for valid/invalid data.
- Tests demonstrate stable behaviour when `inf` values appear in market data.
Implementation notes
- Limit edits to the cadence validation block in `io/market_data.py`; no broader refactors are needed.

3) Differentiate missing data in universe fingerprinting
Labels: agent:codex, enhancement, data
Why
`compute_universe_fingerprint` treats missing or unreadable membership/data files as empty byte streams, making fingerprints identical for "no files" and "empty files" and masking corrupt inputs.
Scope
- `analysis/results.compute_universe_fingerprint` plus tests that cover valid, empty, and missing membership/data inputs.
Tasks
- Emit a warning or explicit marker in the hash payload when expected membership/data files are absent or unreadable.
- Preserve deterministic fingerprints for valid inputs while differentiating missing-file scenarios.
- Add tests covering valid files, empty files, and missing/unreadable files to assert distinct fingerprint outputs and warning behaviour.
Acceptance criteria
- Fingerprints distinguish between valid-empty inputs and missing/unreadable files, with warnings surfaced for the latter.
- Tests cover the new cases and confirm deterministic hashes for valid inputs.
Implementation notes
- Focus on `analysis/results.compute_universe_fingerprint`; avoid changing caller interfaces beyond the new diagnostics.

4) Update month-end handling to pandas "ME" aliases
Labels: agent:codex, cleanup, backend
Why
Month-end logic still uses legacy "M" aliases (e.g., `pd.date_range(..., freq="M")`, `pd.Period(text, freq="M")`), which trigger deprecation warnings and risk breaking on future pandas releases.
Scope
- Month-end frequency usage in sample-window construction and related date-range helpers and tests that assert month-end boundaries.
Tasks
- Replace month-end frequency strings with the recommended "ME" aliases in sample-window construction and related helpers.
- Update any date-range tests or fixtures that rely on the old alias to keep expectations aligned.
- Validate that generated window boundaries and period parsing remain unchanged after the alias update.
Acceptance criteria
- Month-end logic runs without deprecation warnings on current pandas while preserving existing window boundaries.
- Tests referencing month-end frequencies are updated and passing with the new aliases.
Implementation notes
- Concentrate changes in `_build_sample_windows` and associated date-range helpers; avoid behavioural shifts beyond the alias swap.

5) Surface weight fallback diagnostics when weighting fails
Labels: agent:codex, enhancement, backend
Why
`_compute_weights_and_stats` converts weighting errors into equal-weight fallbacks with only a warning, hiding configuration or numerical issues from callers and downstream logs.
Scope
- `_compute_weights_and_stats` and callers that propagate fallback weighting results, along with tests that assert diagnostics on fallback paths.
Tasks
- Return structured diagnostics when fallbacks occur (e.g., include the failure reason and fallback type) so downstream consumers can detect the bypass.
- Optionally propagate the diagnostic through existing payload/metadata structures without breaking current callers.
- Add tests that trigger weighting failures to assert both the fallback behaviour and the presence of detailed diagnostics.
Acceptance criteria
- Weighting failures produce observable diagnostics alongside the fallback weights, and existing callers continue to function.
- Tests cover failure-to-fallback paths and validate the surfaced diagnostics.
Implementation notes
- Target `_compute_weights_and_stats` and its call sites; do not alter the underlying weighting algorithms beyond surfacing diagnostics.
