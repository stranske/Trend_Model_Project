1) Add codex-pr-comment-command handler for branch sync
Labels: agent:codex, automation, bug
Why
Keepalive emits `codex-pr-comment-command` repository_dispatch events for "Update Branch"/"Create PR" remediation, but no workflow listens for that event type, so the commands are dropped and head advancement never happens on unattended rounds.
Tasks
- Add a small `.github/workflows` listener for `repository_dispatch` (event_type `codex-pr-comment-command`) that calls `pulls.updateBranch` with polling and, when needed, dispatches `agents-keepalive-branch-sync.yml` using the payload context instead of silently exiting.
- Ensure the handler logs or summarizes each remediation attempt (update-branch success/failure, branch-sync dispatch URL) so PR-meta can observe what happened.
- Update any keepalive tests/fixtures that assert the dispatch path to cover the new handler (e.g., `tests/fixtures/keepalive_post_work` harness expectations).
Acceptance criteria
- A repository_dispatch with `event_type: codex-pr-comment-command` triggers the automated update-branch/create-pr remediation without manual clicks and records a summary line.
- When update-branch polling fails, the same handler launches `agents-keepalive-branch-sync.yml` with the request context and surfaces the dispatched run URL.
- Keepalive post-work tests cover both the direct update-branch path and the branch-sync fallback.
Implementation notes
- Touch the keepalive post-work plumbing in `scripts/keepalive-runner.js` and add a dedicated workflow file alongside `agents-keepalive-branch-sync.yml` to process the repository_dispatch payload.

2) Pass head repository into branch-sync fallback for forks
Labels: agent:codex, automation, bug
Why
The branch-sync helper accepts a `head_repository` input so it can fetch fork heads, but keepalive never forwards the PR head repo into the fallback dispatch, causing branch-sync to default to the base repo and fail to fetch forked heads.
Tasks
- Export the PR head repository from `keepalive-prep` (or equivalent) and thread it into the keepalive post-work environment so branch-sync dispatches include `head_repository` alongside base/head refs and trace data.
- Update the branch-sync workflow invocation to honour the head repo input and bail early with a clear summary when the head repo is missing for a forked PR.
- Add tests/fixtures that exercise forked-PR branch-sync dispatches to confirm head repo propagation and checkout succeed.
Acceptance criteria
- Keepalive branch-sync dispatches include head repository metadata for forked PRs and successfully fetch the fork head during remediation.
- When head repo data is absent on a fork, the workflow emits a clear skip/failure summary instead of silently continuing with the base repo.
- Test coverage exercises the forked-PR path and asserts that the branch-sync helper clones or checks out the fork head using the forwarded repository info.
Implementation notes
- Focus on keepalive prep/post-work steps in `scripts/keepalive-runner.js` and the inputs consumed by `.github/workflows/agents-keepalive-branch-sync.yml`; avoid altering unrelated orchestrator flows.

3) Prevent look-ahead bias in trend signal computation
Labels: agent:codex, bug, modeling
Why
Trend signals are currently built from the full dataset and later reindexed to the in-sample or out-of-sample slices, so future
rows can leak into historical signals and downstream weights.
Tasks
- Scope every signal calculation to the active analysis window before any reindexing so no future observations influence the period being scored.
- Add guardrails/tests that fail fast when signal helpers receive dates outside the requested slice.
- Audit each rebalance/reindex step to ensure signals and weights stay aligned to data available at the rebalance date.
Acceptance criteria
- Signal computation uses only window-scoped data, eliminating look-ahead bias in both in-sample and out-of-sample runs.
- Tests cover both windows and assert failures when future data is present.
- Rebalance outputs align strictly to window boundaries without forward-looking inputs.
Implementation notes
- Focus on the signal generation pipeline and the rebalance/reindex hooks that currently operate on the full dataset; keep metric definitions unchanged.

4) Validate index/benchmark membership before selection
Labels: agent:codex, enhancement, selection
Why
_select_universe indexes window data with the requested indices list without verifying membership, surfacing raw KeyErrors for misspelled or missing benchmarks instead of actionable feedback.
Tasks
- Add validation that intersects requested indices with available columns and reports absent entries before selection proceeds.
- Emit feedback on which indices were accepted and which were ignored so misconfigurations are obvious.
- Cover validation paths with tests for fully valid, partially missing, and fully missing index lists.
Acceptance criteria
- Universe selection fails gracefully with clear diagnostics when requested indices are absent from the window data.
- Valid indices are selected without altering current behaviour; missing entries are reported deterministically.
- Tests exercise mixed-validity scenarios and assert the reported messages.
Implementation notes
- Changes live around _select_universe and the helpers that build the in-sample benchmark set; avoid altering downstream weighting logic.

5) Require robust coverage for risk-free fallback detection
Labels: agent:codex, bug, selection
Why
The risk-free fallback chooses the lowest-volatility numeric column with any non-null value, so sparse series can be selected and later propagate NaNs when aligned to the analysis windows.
Tasks
- Enforce minimum coverage within the requested window before considering a column eligible for fallback selection (e.g., threshold on non-null share or span).
- Align fallback volatility checks to the same window slice used downstream rather than the full dataset.
- Add tests that include sparse columns and confirm only sufficiently covered, window-aligned series are selected (or a clear diagnostic is emitted).
Acceptance criteria
- Fallback risk-free selection ignores sparse or short series and uses window-scoped data for volatility comparison.
- Omitted risk-free column scenarios produce deterministic, well-documented outcomes with no unexpected NaNs from missing coverage.
- Tests cover explicit risk-free columns, eligible fallback selections, and rejection of sparse series with corresponding diagnostics.
Implementation notes
- Target _resolve_risk_free_column (and related fallback helpers) to apply coverage thresholds and window scoping without changing metric formulas.
