1) Issue Bridge: invite‑only mode, use codex/issue-<n> head, and resolve base from repo default

Labels: agent:codex, agents, automation, devops, ci

## Why
Bridge sometimes creates its own PR/branch while the belt also opens one. Different head names and hard-coded base produce duplicate PRs and “work on main.”

## Scope
Bridge wrappers and the reusable bridge only. Do not edit Orchestrator/Worker here.

## Non-Goals
No content changes to agent prompts.

## Tasks
- Default Bridge PR mode to **invite** (no PR creation in Bridge); the belt owns PR creation.
- Compute the base branch via `repos.get().default_branch` each run; never assume `main`.
- Emit canonical head `codex/issue-<n>` as output for downstream steps.
- Do not create ephemeral `agents/*` heads.
- Update the summary in the issue comment to reflect chosen base/head.

## Acceptance criteria
- Running the Bridge never creates a PR by default (invite mode).
- The head branch is always `codex/issue-<n>`.
- The base always equals the repository default branch at dispatch time.

## Implementation notes
- Files: `.github/workflows/agents-63-codex-issue-bridge.yml`, `.github/workflows/reusable-agents-issue-bridge.yml`
- Add a tiny `actions/github-script` step to get `default_branch` and set outputs: `{ base, head }`.
- Keep an optional `mode=create` input for manual testing, but default stays `invite`.

Branch: codex/issue--bridge-invite-canonical
PR title prefix: [Bridge] Invite-only + canonical head
Touch only: .github/workflows/agents-63-codex-issue-bridge.yml, .github/workflows/reusable-agents-issue-bridge.yml

2) Worker: per‑branch concurrency; marker‑based activation comment upsert

Labels: agent:codex, agents, ci, devops, automation

## Why
Global concurrency lets two Workers mutate the same PR simultaneously. Separate runs also spam duplicate “start” comments.

## Scope
Agents 72 Worker (and 73 Conveyor concurrency mirror).

## Non-Goals
No logic changes to how steps are executed.

## Tasks
- Set Worker concurrency to `codex-belt-${{ inputs.branch }}` with `cancel-in-progress: true`.
- Do the same for Conveyor.
- Post a single activation comment with HTML marker `<!-- codex-activation-marker -->`. If present, update it; if absent, create it.

## Acceptance criteria
- Two Worker runs for the same head never overlap; one cancels/queues the other.
- Activation text appears once per PR and is updated in place on re-runs.

## Implementation notes
- Files: `.github/workflows/agents-72-codex-belt-worker.yml`, `.github/workflows/agents-73-codex-belt-conveyor.yml`
- Use `actions/github-script@v7` to list comments, find the marker, and upsert.

Branch: codex/issue--worker-concurrency-upsert
PR title prefix: [Agents] Per-branch concurrency + comment upsert
Touch only: .github/workflows/agents-72-codex-belt-worker.yml, .github/workflows/agents-73-codex-belt-conveyor.yml

3) Keepalive: single source of truth, branch‑scoped triggers, marker upsert

Labels: agent:codex, agents, agents:keepalive, automation, devops, ci

## Why
Multiple keepalive mechanisms race each other (Orchestrator sweep, Gate listener, any legacy keepalive). That causes duplicate comments and duplicate dispatch.

## Scope
Orchestrator keepalive sweep and the Gate listener workflow only.

## Non-Goals
No changes to belt step sizing.

## Tasks
- Choose ONE keepalive mechanism:
  - Preferred: keep Orchestrator sweep; disable Gate listener, OR
  - If Gate listener is kept, restrict to `head_branch` like `codex/issue-*` and disable Orchestrator sweep.
- Add `<!-- codex-keepalive-marker -->` upserted comment to avoid duplicates.
- Respect `agents:paused` label to short-circuit both paths.

## Acceptance criteria
- Exactly one keepalive path remains active.
- No duplicate keepalive comments appear on PRs.
- Keepalive never fires on non-agent branches.

## Implementation notes
- Files: `.github/workflows/agents-70-orchestrator.yml`, `.github/workflows/agents-75-keepalive-on-gate.yml` (or similarly named)
- Gate listener (if used): `on: workflow_run` with `conclusion == success` and branch filter `contains(head_branch, 'codex/issue-')`.

Branch: codex/issue--keepalive-consolidation
PR title prefix: [Agents] Keepalive consolidation + branch scoping
Touch only: .github/workflows/agents-70-orchestrator.yml, .github/workflows/agents-75-keepalive-on-gate.yml

4) Orchestrator: dedupe PR creation by skipping Worker when PR exists

Labels: agent:codex, agents, automation, devops, ci

## Why
When Bridge ever created a PR (or a prior Worker run did), Orchestrator can still dispatch a new Worker that creates a second PR.

## Scope
Agents 70 Orchestrator dispatch logic only.

## Non-Goals
No changes to issue selection rules.

## Tasks
- Before dispatch, query open PRs for `head = owner:codex/issue-<n>`.
- If found, skip Worker dispatch and log “PR already exists.”
- Emit the PR URL in summary for clarity.

## Acceptance criteria
- With an existing PR for `codex/issue-<n>`, Orchestrator never dispatches a run that opens another PR.
- Summary shows “skipped: PR exists.”

## Implementation notes
- File: `.github/workflows/agents-70-orchestrator.yml`
- Use `pulls.list` with `head: ${owner}:codex/issue-<n>`.

Branch: codex/issue--orchestrator-pr-dedupe
PR title prefix: [Agents] Orchestrator skip when PR exists
Touch only: .github/workflows/agents-70-orchestrator.yml

5) Worker preflight: enforce branch freshness; optional step‑branch fallback

Labels: agent:codex, agents, devops, ci

## Why
If the Worker edits on a stale checkout, it repeats or ignores work. We need a fast freshness check and a safe fallback.

## Scope
Agents 72 Worker.

## Non-Goals
Complex rebase conflict resolution.

## Tasks
- Add preflight: `git fetch`, verify local HEAD matches `origin/<branch>`.
- If stale and `inputs.use_step_branch == true`, create `codex/issue-<n>/step/<short>`, push, open/refresh PR from step branch to the issue head.
- If stale and fallback disabled, fail fast with clear summary.

## Acceptance criteria
- Worker never proceeds on a stale branch without either failing fast or using step-branch fallback.
- Gate validates each step before the next begins.

## Implementation notes
- File: `.github/workflows/agents-72-codex-belt-worker.yml`
- Keep fallback off by default; flip-on per issue if needed.

Branch: codex/issue--worker-head-freshness
PR title prefix: [Agents] Worker freshness + step-branch (optional)
Touch only: .github/workflows/agents-72-codex-belt-worker.yml

6) Add branch‑local progress ledger and wire Worker read/write

Labels: agent:codex, agents, automation, ci, devops

## Why
Agents forget completed steps unless progress is persisted. A minimal on-branch ledger prevents repeats/skips.

## Scope
Define a small YAML ledger and have Worker advance exactly one task per run.

## Non-Goals
External state stores or dashboards.

## Tasks
- Define `.agents/issue-<n>-ledger.yml` schema:
  - `version`, `issue`, `base`, `branch`, `tasks: [{id,title,status,commit,notes}]`
- Worker read: pick next `todo`, mark `doing`.
- Worker write: mark `done` with commit SHA; append `notes` on failure.
- Add `scripts/ledger_validate.py` and a CI check to validate schema.

## Acceptance criteria
- Each Worker run advances a single task from `todo` to `done`.
- No completed task is repeated in later runs.
- CI fails if the ledger schema is invalid.

## Implementation notes
- Files: `.github/workflows/agents-72-codex-belt-worker.yml`, `scripts/ledger_validate.py`, `.agents/*`
- Summarize the ledger delta in the job summary.

Branch: codex/issue--agent-ledger
PR title prefix: [Agents] Branch-local ledger + worker integration
Touch only: .github/workflows/agents-72-codex-belt-worker.yml, scripts/ledger_validate.py, .agents/*

7) Retire legacy keepalive path(s) and any remaining maint-46-post-ci.yml

Labels: agent:codex, agents, devops, ci, docs

## Why
Old keepalive and post-CI artifacts can still fire or confuse contributors, causing duplicate comments or summaries.

## Scope
Delete or archive workflows superseded by Orchestrator/Gate.

## Non-Goals
No functional replacements; consolidation already exists.

## Tasks
- Remove any legacy keepalive workflow files not selected in the active keepalive path.
- Remove/disable `maint-46-post-ci.yml` if present and fully absorbed by Gate summary.
- Add a short doc blurb under `docs/ci/` explaining the current, single keepalive path and Gate summary.

## Acceptance criteria
- Only the chosen keepalive workflow remains.
- No post-CI workflow remains outside Gate’s built-in summary.
- Docs reflect the simplified topology.

## Implementation notes
- Files: `.github/workflows/*keepalive*.yml`, `.github/workflows/maint-46-post-ci.yml`, `docs/ci/WORKFLOW_SYSTEM.md`

Branch: codex/issue--retire-legacy-keepalive-postci
PR title prefix: [CI] Retire legacy keepalive/post-CI
Touch only: .github/workflows/*keepalive*.yml, .github/workflows/maint-46-post-ci.yml, docs/ci/WORKFLOW_SYSTEM.md

8) Auto‑merge labeled agent PRs after required checks pass

Labels: agent:codex, automerge, ci, devops, automation

## Why
Agent PRs that are green and explicitly opted-in shouldn’t wait for manual clicks.

## Scope
Agents 70 Orchestrator (or a small dedicated workflow) to call the merge API for labeled PRs.

## Non-Goals
Changing branch protection rules; do not bypass required checks.

## Tasks
- Detect agent PRs with `automerge` label and all required checks green.
- Verify PR author is the automation identity; verify base equals default branch.
- Merge via API (squash or repo default); otherwise log a clear “blocked by protection” note.

## Acceptance criteria
- Labeled agent PRs self-merge automatically when green.
- Non-labeled PRs are untouched.
- When merge is blocked by protection, logs show the reason.

## Implementation notes
- File: `.github/workflows/agents-70-orchestrator.yml` (or a tiny `agents-78-automerge.yml`)
- Reuse existing token; no new scopes.

Branch: codex/issue--agent-auto-merge
PR title prefix: [CI] Auto-merge for labeled agent PRs
Touch only: .github/workflows/agents-70-orchestrator.yml
