1. Agents keepalive poster: always create a new instruction comment (hidden markers + TRACE) and post as stranske via ACTIONS_BOT_PAT (fallback to SERVICE_BOT_PAT) with PRâ€‘meta ack & safe fallback

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
PRâ€‘meta triggers only on issue_comment.created. Editing an existing status/checklist comment never creates that event, so detection/dispatch doesnâ€™t run. Detection also requires hidden markers. Finally, to maximize agent compliance, the instruction comment should be authored by stranske (using ACTIONS_BOT_PAT), with a safe fallback to SERVICE_BOT_PAT. We also need a short ack step so the poster can confirm PRâ€‘meta saw the comment and, if not, emit a fallback dispatch to avoid silent stalls.

Scope

- For each keepalive round, create a new instruction comment (do not edit any prior comment).

- The instruction comment must start with all of:

  <!-- keepalive-round: {N} -->
  <!-- codex-keepalive-marker -->
  <!-- keepalive-trace: {TRACE} -->
  followed by @codex and the Scope/Tasks/Acceptance block to act on.

- Post as stranske using ACTIONS_BOT_PAT; if absent/unavailable, fallback to SERVICE_BOT_PAT.

- After posting, add ğŸ‘€ to the comment and poll for PRâ€‘metaâ€™s ğŸš€ reaction for ~60s; if not seen, emit the same repository dispatch your PRâ€‘meta would send (safe fallback), and write a oneâ€‘line reason with {round} + {trace}.

Nonâ€‘Goals

Changing Gate semantics, labels, or acceptance criteria

Modifying the separate â€œAutomated Status Summary / Checklistâ€ updater (it can continue to edit status)

Tasks

- Add/confirm a small helper (e.g., .github/scripts/keepalive_contract.js) that exports:

  - makeTrace() â†’ unique short trace id,

  - renderInstruction({ round, trace, body }) â†’ returns the required markers + @codex + supplied Scope/Tasks/Acceptance body.

- In .github/workflows/agents-70-orchestrator.yml (Codex Keepalive Sweep or its helper):

  - Compute round (next integer) and trace = makeTrace().

  - Select token: token = secrets.ACTIONS_BOT_PAT ?? secrets.SERVICE_BOT_PAT and set author = stranske | stranske-automation-bot.

  - Create the instruction comment via issues.createComment (or peter-evans/create-issue-comment@v3) with body = renderInstruction(...).

  - Record comment_id, round, trace, author to $GITHUB_STEP_SUMMARY.

  - Ack step: add ğŸ‘€ reaction to comment_id; poll for ğŸš€ for ~60s.

  - Fallback (only if ğŸš€ not seen): emit repository_dispatch codex-pr-comment-command with { issue, base, head, agent:'codex', comment_id, comment_url } using ACTIONS_BOT_PAT; post a oneâ€‘line PR comment:
  **Keepalive {round}** \{trace}` fallback: PRâ€‘meta ack not observed in TTL â€“ emitted connector dispatch.`

Acceptance criteria

- Each keepalive cycle creates exactly one new instruction comment (no edits), whose body begins with the three hidden markers and an @codex instruction.

- The instruction comment author is stranske when ACTIONS_BOT_PAT is present; otherwise stranskeâ€‘automationâ€‘bot.

- An Agents PR meta manager run appears for issue_comment.created tied to that comment; if ack is missed, a fallback repository_dispatch is emitted and a oneâ€‘line fallback comment appears on the PR.

- The keepalive poster step summary includes Round, Trace, Author, and CommentId.

Implementation notes

Use existing secrets: ACTIONS_BOT_PAT (preferred) and SERVICE_BOT_PAT. Do not introduce new PATs.

Guard usage to origin repo PRs (skip forks); mask secrets; donâ€™t log response bodies.

Keep status/checklist updater unchanged; this issue governs only the instruction comment.

2. Keepalive pipeline hardening: PRâ€‘meta detection + dispatch (dedupe, stranske/bot authors); orchestrator carries TRACE, avoids cancel, and posts explicit â€œskipped: reasonâ€

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
After the poster creates a proper instruction comment, the system must either dispatch the next round or produce a clear, machineâ€‘readable reason in the PR. We must dedupe by comment, accept stranske and stranskeâ€‘automationâ€‘bot as valid authors, pass a TRACE through orchestrator, avoid canceling runs midâ€‘loop, and skip assignee enforcement for bot/app logins.

Scope

PRâ€‘meta (issue_comment.created on PRs):

  - Allowed authors: stranske, stranske-automation-bot (connector can stay allowed if needed).

  - Require hidden markers (<!-- codex-keepalive-marker --> and <!-- keepalive-round: N -->); parse {round} and optional {trace} (<!-- keepalive-trace: â€¦ -->).

  - Dedupe by adding ğŸš€ to the instruction comment; skip if already present.

  - If valid and not duplicate:

    - Dispatch Agentsâ€‘70 Orchestrator via actions.createWorkflowDispatch with options_json: {"keepalive_trace":"{trace}","round":"{N}","pr":<PR>} using ACTIONS_BOT_PAT.

    - Emit repository_dispatch codex-pr-comment-command with { issue, base, head, agent:'codex', comment_id, comment_url } using ACTIONS_BOT_PAT.

  - Always write a summary table (ok | reason | author | pr | round | trace).

Orchestrator (agents-70-orchestrator.yml):

  - Parse options_json; export TRACE, ROUND, PR to env.

  - Set concurrency.cancel-in-progress = false and key by PR-TRACE (or TRACE) so successive rounds donâ€™t cancel each other.

  - Before any early exit (Gate not green, labels missing, branch mismatch, etc.), post a oneâ€‘line PR comment:
  **Keepalive {round}** \{trace}` skipped: <reason-code>and mirror it in$GITHUB_STEP_SUMMARY`.

  - Assignee enforcement: filter out bots/apps; use PR number in issues.addAssignees; if none remain after filtering, skip gracefully (do not fail).

Nonâ€‘Goals

Triggering on issue_comment.edited (creation only)

Changing acceptance criteria or Gate logic

Tasks

- PRâ€‘m- eta (.github/workflows/agents-pr-meta.yml):

  - Ensure actions/checkout@v4 precedes requiring the detector script.

  - Accept stranske and stranskeâ€‘automationâ€‘bot as authors; enforce hidden markers; set outputs.

  - Add ğŸš€ dedupe, orchestrator workflow_dispatch, and repository_dispatch (connector) with comment_id/comment_url + resolved base/head.

  - Emit the summary table on every run.

- Orchestrator (.github/workflows/agents-70-orchestrator.yml):

  - Parse options_json; set TRACE, ROUND, PR.

  - Set concurrency as above; add explicit bail checks that post oneâ€‘line â€œskipped: reasonâ€ and write summary.

  - Filter assignees to humans; skip if none remain.

Acceptance criteria

- A proper instruction comment created by stranske (via ACTIONS_BOT_PAT) or the bot yields a PRâ€‘meta run with ok: true, reason: keepalive-detected, and populated round, trace, pr, author.

- Exactly one orchestrator run starts via workflow_dispatch with the same TRACE; none are canceled by other keepalive runs.

- Exactly one repository_dispatch (codex-pr-comment-command) is emitted for that comment.

- If any guard fails, the PR shows a oneâ€‘line skipped comment with {round} and {trace}, and the same reason appears in the run summary.

- Two consecutive rounds produce two distinct traces, two orchestrator runs, and no duplicates.

Implementation notes

Use existing secrets only: ACTIONS_BOT_PAT (preferred) and SERVICE_BOT_PAT.

Keep triggers limited to originâ€‘repo PRs (skip forks) to protect secrets.

Keep the hidden marker string exactly <!-- codex-keepalive-marker -->.
