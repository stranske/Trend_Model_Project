1. Keepalive branchâ€‘sync (Optionâ€¯1 + Optionâ€¯3): commentâ€‘command â€œUpdate Branchâ€ first, then GHâ€‘side Codex Action PR fallback; block next round until sync lands

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement

Why
Keepalive fires, but when an agent finishes work in its external sandbox the PR head SHA often doesnâ€™t change immediately. If we post the next instruction before the branch reflects the agentâ€™s work, later rounds repeat old work. We need a fully automated branchâ€‘sync gate that:

First asks the agent (via a PR comment command, posted as stranske) to update the PR branch;

Then (if still unsynced) uses GitHubâ€‘side automation to land the changes by running Codex in Actions to produce a sync PR and autoâ€‘merge it;

Only after the PR head moves do we allow the next keepalive round.
This eliminates the human clicks on the external site (â€œUpdate Branchâ€ / â€œCreate PRâ€) and prevents duplicate/looping rounds.

Scope

Add a branchâ€‘sync gate to the keepalive flow, executed after an agent round reports â€œdoneâ€ and before posting the next instruction.

Optionâ€¯1 (commentâ€‘command path, preferred first): Post a PR comment command as stranske (using ACTIONS_BOT_PAT) to instruct the agent to update the PR branch. Poll the PR head SHA until it changes (short TTL).

Optionâ€¯3 (GitHubâ€‘side fallback): If the branch still hasnâ€™t moved, run Codex inside Actions to generate/apply a sync patch to a temporary branch, open a PR, and autoâ€‘merge it back into the working branch; poll until the PR head changes.

If both paths fail within a bounded TTL, add label agents:sync-required and suppress the next keepalive instruction (summary only; no PR noise unless debug label present).

Nonâ€‘Goals

Changing existing keepalive preâ€‘gates (label, human @agent, Gate concluded, runâ€‘cap) â€” enforced elsewhere.

Introducing new secrets or external services.

Depending on custom repository_dispatch handlers in the agent platform (weâ€™re using comment commands and GitHubâ€‘side actions only).

Tasks

- Shared inputs & guards (reuse existing keepalive context)

  - Capture: PR_NUMBER, PR_BASE, PR_HEAD, PR_HEAD_SHA_PREV, KEEPALIVE_ROUND, KEEPALIVE_TRACE, current labels, and the current agent alias from agent:* labels.

  - Precondition: Only run branchâ€‘sync gate when last agent action reported â€œdoneâ€ and PR_HEAD_SHA has not changed since the previous instruction.

- Emit the commentâ€‘command (Optionâ€¯1) â€” posted as stranske

  - Token select: TOKEN = ACTIONS_BOT_PAT (preferred) else SERVICE_BOT_PAT.

  - Create a PR comment (new, not edit) with exact body:
    /update-branch trace:${KEEPALIVE_TRACE}
    (Optional, only when /update-branch is rejected because head moved:) also support
    /create-pr trace:${KEEPALIVE_TRACE}

  - Add ğŸ‘€ reaction to the command comment (visual ack).

  - Poll pulls.get for head.sha change every 5s up to TTL_short (e.g., 60â€“120s).

  - If changed â†’ record success (mode=comment-update-branch) and proceed (post next instruction).

  - If not changed â†’ continue to Task 3.

- GitHubâ€‘side fallback (Optionâ€¯3) â€” Codex Action â†’ PR â†’ autoâ€‘merge

  - Create a temp branch sync/codex-${KEEPALIVE_TRACE} from the current PR head.

  - Run an AI-assisted code generation action in GitHub Actions (e.g., your existing Codex worker, or a supported alternative such as github/copilot-actions if available) with a narrowly scoped prompt to sync the temp branch to the desired state (e.g., apply pending patch or minimal noâ€‘op change to force merge) without altering functional code. Note: The openai/codex-action is deprecated and should not be used.

  - Use peter-evans/create-pull-request to open a PR from sync/codex-${KEEPALIVE_TRACE} â†’ PR_HEAD (same repo), title e.g., chore(sync): branch-sync ${KEEPALIVE_TRACE}.

  - Autoâ€‘merge that PR (fastâ€‘forward/squash per repo policy) using PAT; delete the temp branch.

  - Poll pulls.get for head.sha change up to TTL_long (e.g., 2â€“5â€¯min).

  - If changed â†’ record success (mode=action-sync-pr) and proceed.

  - If still unchanged â†’ add label agents:sync-required; do not post next instruction; write oneâ€‘line summary only when agents:debug label present.

- Observability & idempotency

  - Write a concise step summary on each attempt: round, trace, mode, result, merged_sha (if any), and elapsed time.

  - Treat trace as the idempotency key; do not reâ€‘execute sync for the same {PR, round, trace} tuple.

  - No PR comments are posted when gates fail or we pause (unless agents:debug label is present).

Acceptance criteria

- Diverged base, no human clicks: After an agent â€œdone,â€ if the PR head is unchanged, the system posts /update-branch trace:<TRACE> as stranske and the PR head SHA changes within TTL_short; the next keepalive instruction is allowed. Step summary records mode=comment-update-branch and the merged SHA.

- Head moved since agent work: If /update-branch canâ€™t land changes, the fallback creates a sync PR and autoâ€‘merges it; the PR head SHA changes within TTL_long; the next keepalive instruction is allowed. Step summary records mode=action-sync-pr and merged SHA.

- Unresolvable within TTL_long: Label agents:sync-required is applied; no next instruction is posted; run summary explains reason=sync-timeout with {trace}.

- At no point does the system post new keepalive instructions when unsynced; no duplicate sync attempts occur for the same {PR, round, trace}.

Implementation notes

Posting identity: always try ACTIONS_BOT_PAT first so instruction/command comments appear as stranske; fallback to SERVICE_BOT_PAT.

Comment commands: keep the command bodies exact (/update-branch trace:<TRACE> and /create-pr trace:<TRACE>). If /create-pr is unsupported, you may skip it â€” the fallback PR from Codex Action covers this path.

Safe prompts for Codex Action: scope the fallback to â€œsync onlyâ€ (no functional edits). Example: â€œOpen a PR to merge temp branch into current PR head without semantic changes; only minimal/noâ€‘op changes if needed to enable fastâ€‘forward.â€

Polling: use 5s intervals; total TTL_short â‰ˆ 60â€“120s; total TTL_long â‰ˆ 2â€“5â€¯min (configurable).

Security: never log tokens or external URLs; restrict actions to originâ€‘repo PRs (skip forks).

Noâ€‘noise policy: only post the oneâ€‘line escalation when agents:debug is present; otherwise summaries go to $GITHUB_STEP_SUMMARY only.

Labels used: agents:keepalive, agent:codex (or current agent), optional agents:debug, and agents:sync-required (new if not present).

Where to wire: implement in the postâ€‘work / preâ€‘nextâ€‘round phase of Agentsâ€‘70 Orchestrator keepalive sweep; do not change the separate status/checklist updater.
