1. Keepalive PR‚Äëmeta: refuse GITHUB_TOKEN, prove Orchestrator dispatch, enforce cap at dispatch edge, Gate activation fallback, and mandatory DISPATCH/GATE summaries

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
Meta often ‚Äúsucceeds‚Äù while Orchestrator never starts. We must (a) use a real PAT for dispatch, (b) prove that an Orchestrator run was created, (c) enforce run‚Äëcap at the dispatch edge, (d) never silently skip Gate replay when the script didn‚Äôt provide activation_comment, and (e) always emit one‚Äëline decisions to the job summary.

Scope
- Make sure that you have consulted GoalsAndPlumbing.md and Keepalive_Reliability_Plan.md and Observability_Contract.md as you make updates to ensure that updates fit with the design of this project

- Edit .github/workflows/agents-pr-meta.yml only. No orchestrator changes in this issue.

Non‚ÄëGoals

No change to acceptance text, run‚Äëcap default value, connector payload, or moderation.

No branch‚Äësync changes (that‚Äôs Issue 3).

Tasks

- Token policy & proof

  - If github.token (GITHUB_TOKEN) would be used for dispatch, fail with reason=forbidden-token.

  - Require a PAT (ACTION_BOT_PAT or SERVICE_BOT_PAT) and call GET /user to print TOKEN_IDENTITY:.

  - After workflow_dispatch, poll GET /actions/workflows/<id>/runs?event=workflow_dispatch and assert a new run exists with your correlation (PR number / trace). If not found within N short polls, fail with reason=dispatch-unconfirmed.

- Cap at dispatch edge

  - Compute active = count(orchestrator runs in {queued,in_progress} for this PR); cap = label('agents:max-runs') || 2 (clamp 1..5).

  - If active ‚â• cap ‚Üí do not dispatch; set reason=cap-reached.

- Gate activation fallback

  - If steps.gate.outputs.activation_comment == '', list PR comments and choose the most recent human @agent comment (exclude keepalive comments by checking hidden markers). If none ‚Üí reason=no-activation-found.

- Reaction lock

  - Add üöÄ to the activation comment id before dispatch; if present (409) ‚Üí reason=lock-held.

- Mandatory summaries (Summary tab only)

  - Always write one line:
    DISPATCH: ok=<true|false> path=<comment|gate> reason=<ok|missing-label|no-human-activation|gate-pending|gate-failed|cap-reached|no-linked-pr|no-activation-found|lock-held|forbidden-token|dispatch-unconfirmed|instruction-empty> pr=#<n> activation=<id|none> agent=<alias> head=<sha7> cap=<active>/<cap> trace=<trace|->

  - Where Gate information is available, also write:
    GATE: ok=<bool> reason=<code> pr=#<n> head=<sha7>

Acceptance criteria

- A test PR with a prior human @agent and Gate=success shows DISPATCH path=gate ok=true and an Orchestrator run appears; or it shows an explicit skip reason (e.g., cap-reached).

- Using GITHUB_TOKEN for dispatch fails with reason=forbidden-token; using a PAT prints TOKEN_IDENTITY: and DISPATCH_CONFIRMED:.

- When the gate script doesn‚Äôt supply activation_comment, the fallback is used (or no-activation-found is printed).

- The DISPATCH: line always appears with cap=<active>/<cap>.

Implementation notes

Use actions/github-script@v7 for REST calls.

Keep all PR‚Äëmeta posting muted (no PR comments).

2. Keepalive Orchestrator: workflow_run fallback (Gate), PR‚Äëhead checkout, secrets preflight ‚Üí WRITE_TOKEN, author invariant, INSTRUCTION/WORKER/SYNC summaries, and worker_max_parallel = cap

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
Cross‚Äëworkflow dispatch can fail; Orchestrator must also start on Gate completion. Once running, it must prove token/author are correct, emit one‚Äëline summaries, and execute up to the configured cap.

Scope

- Make sure that you have consulted GoalsAndPlumbing.md and Keepalive_Reliability_Plan.md and Observability_Contract.md as you make updates to ensure that updates fit with the design of this project

- Edit .github/workflows/agents-70-orchestrator.yml and any helper scripts used by it.

Non‚ÄëGoals

No PR‚Äëmeta edits in this issue.

No branch‚Äësync algorithm change (that‚Äôs Issue 3), only the SYNC: summary line.

Tasks

- Trigger & checkout

  - Add:
    on:
      workflow_run:
      workflows: ["Gate", "Dummy (fast-pass) gate"]   # include all Gate variants you use
      types: [completed]

  - On this path, checkout PR head: 
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.pull_requests[0].head.sha }}

- Secrets preflight

  - Early job sets WRITE_TOKEN = ACTION_BOT_PAT || SERVICE_BOT_PAT; fail fast if neither exists. Print:
    PREPOST: token=<ACTION_BOT_PAT|SERVICE_BOT_PAT>

- Author invariant

  - If the pipeline requires the instruction to be authored by stranske and WRITE_TOKEN ‚â† ACTION_BOT_PAT, do not post; print:
    INSTRUCTION: ok=false reason=wrong-author token=<...> head=<sha7> trace=<trace>

  and fail the job.

- One‚Äëline summaries (always)

  - After instruction post + ACK:
    INSTRUCTION: ok=<true|false> author=<stranske|stranske-automation-bot> comment=<id|none> ack=<ok|fail> head=<sha7> trace=<trace>

- Worker decision:
  WORKER: action=<execute|skip> reason=<new-instruction|no-new-instruction-and-head-unchanged|cap-reached|blocked> pr=#<n> head=<sha7> instr=<id|none> trace=<trace>

- Branch‚Äësync placeholder (final outcome printed in Issue 3):
  SYNC: action=<update-branch|create-pr|escalate|skip> head_changed=<true|false> trace=<trace>


- Worker fan‚Äëout

  - Set worker_max_parallel = min(cap_from_options_or_label, 5); default 2. Ensure this matches PR‚Äëmeta cap.

Acceptance criteria

- After Gate completion, an Orchestrator run appears with event=workflow_run and checks out the PR head SHA.

- The run prints PREPOST: token=‚Ä¶; if only SERVICE_BOT_PAT is available and author invariant requires stranske, the job fails with reason=wrong-author.

- On a normal path, the run prints INSTRUCTION ok=true author=stranske, then WORKER action=execute, and a SYNC line.

- With cap=2, two workers can run concurrently; a third attempt is blocked upstream by PR‚Äëmeta.

Implementation notes

Keep PR noise minimal‚Äîsummaries only.

If you must keep the dispatch path, leave it in place; this fallback guarantees a token‚Äëfree path.

3. Keepalive Branch‚ÄëSync: implement update-branch ‚Üí create-pr+auto-merge ‚Üí escalate (+ link); emit SYNC: summary with head change result

Labels: agents, agents:keepalive, agent:codex, ci, automation, enhancement, bug

Why
External agents often complete work in a sandbox. If we don‚Äôt update the PR head, later keepalive rounds repeat work. We need a reliable, two‚Äëpath sync and a clear escalation when automation can‚Äôt land the code.

Scope

- Make sure that you have consulted GoalsAndPlumbing.md and Keepalive_Reliability_Plan.md and Observability_Contract.md as you make updates to ensure that updates fit with the design of this project

- Edit orchestrator post‚Äëwork steps and helpers only.

Non‚ÄëGoals

No changes to PR‚Äëmeta or detection logic.

No changes to acceptance content.

Tasks

- Dry‚Äërun status (optional but helpful)

  - Compute sync status: in_sync | needs_update | conflict. Print:
    SYNC: status=<...> mode=dry-run head=<sha7> base=<branch>

- Path A ‚Äî Update Branch

  - If clean and no newer commits, call the GitHub ‚ÄúUpdate branch‚Äù API (or merge base fast‚Äëforward); then re‚Äëpoll HEAD. If changed ‚Üí head_changed=true.

- Path B ‚Äî Create PR + Auto‚Äëmerge

  - If Path A not possible, create a short‚Äëlived internal PR from the agent‚Äôs sandbox ref; auto‚Äëenable merge and complete it. Re‚Äëpoll HEAD.

- Escalation

  - If neither path works, add agents:sync-required label and post a short PR comment:
    ‚ÄúKeepalive: manual action needed ‚Äî click Update Branch or open Create PR at: <action URL>‚Äù

  - Include the exact button URL provided by the agent/connector.

- Mandatory SYNC: summary

  - Print a final line:
    SYNC: action=<update-branch|create-pr|escalate> head_changed=<true|false> link=<url|-> trace=<trace>

Acceptance criteria

- After a successful agent round that produces code, the orchestrator either:

  - updates the PR head (SYNC action=update-branch head_changed=true), or

  - creates and merges a helper PR (SYNC action=create-pr head_changed=true), or

  - escalates with a clear PR comment and link (SYNC action=escalate head_changed=false link=<url>).

- The SYNC: line always appears in the job summary.

Implementation notes

Keep the escalation comment compact; moderation rules should allow it.

Prefer updating the PR head in place (Path A) when safe; use the helper PR only when necessary.
