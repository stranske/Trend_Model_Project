version: 1
issue: 4498
base: phase-3
branch: codex/issue-4498
tasks:
  - id: task-01
    title: 'Create `src/trend_analysis/llm/result_feedback.py` with a public helper
      such as:'
    status: done
    started_at: '2026-01-22T02:35:22Z'
    finished_at: '2026-01-22T02:35:30Z'
    commit: e63d872629248b3614a5d5ab90d83013cd4588ad
    notes: []
  - id: task-02
    title: '`build_deterministic_feedback(details: Mapping[str, Any], entries: list[MetricEntry])
      -> str`'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-03
    title: "Output format: Markdown list under a header (e.g., \"Deterministic diagnostics:\"\
      ) with 3\u20138 bullets max."
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-04
    title: 'Implement deterministic flags (examples; keep minimal and high-signal):'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-05
    title: High turnover flag (use `risk_diagnostics.turnover_value` OR `turnover.mean`
      / `turnover.latest` if available)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-06
    title: High concentration flag (max absolute weight from `fund_weights` or `ew_weights`)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-07
    title: Large drawdown flag (prefer `out_user_stats.max_drawdown` / `out_ew_stats.max_drawdown`
      when present)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-08
    title: Missing/empty key result sections flag (e.g., missing `out_user_stats`,
      missing `out_sample_scaled`, missing `period_results` in multi-period mode)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-09
    title: Ensure every bullet includes at least one numeric value with an explicit
      citation in `[from <source>]` format.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-10
    title: 'Add thresholds with sane defaults and environment overrides (keep small):'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-11
    title: '`TREND_EXPLAIN_TURNOVER_WARN` (default e.g. 0.75)'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-12
    title: '`TREND_EXPLAIN_MAX_WEIGHT_WARN` (default e.g. 0.20)'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-13
    title: '`TREND_EXPLAIN_MAX_DD_WARN` (default e.g. -0.20)'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-14
    title: 'Inject diagnostics into Streamlit Explain Results prompt context:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-15
    title: In `streamlit_app/components/explain_results.py::generate_result_explanation`,
      append the diagnostics block to `analysis_output` (or add as a distinct section
      passed to the chain) before the LLM call.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-16
    title: 'Inject diagnostics into CLI Explain Results prompt context:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-17
    title: In `src/trend/cli.py` explain command flow, append the same diagnostics
      block to the rendered `analysis_output` prior to `ResultSummaryChain.run(...)`.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-18
    title: 'Add unit tests (no live LLM required):'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-19
    title: 'New tests under `tests/` using synthetic `details` payloads to confirm:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-20
    title: The feedback block is deterministic (stable output for same input)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-21
    title: Expected flags trigger given threshold-crossing values
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-22
    title: Each bullet includes at least one `[from ...]` citation
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-23
    title: No forward-looking phrases are introduced
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-24
    title: Add a small integration-style test ensuring both Streamlit and CLI code
      paths call the helper (import/callsite assertion is acceptable).
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-25
    title: 'Create `src/trend_analysis/llm/result_feedback.py` with a public helper
      such as:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-26
    title: '`build_deterministic_feedback(details: Mapping[str, Any], entries: list[MetricEntry])
      -> str`'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-27
    title: "Output format: Markdown list under a header (e.g., \"Deterministic diagnostics:\"\
      ) with 3\u20138 bullets max."
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-28
    title: 'Implement deterministic flags (examples; keep minimal and high-signal):'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-29
    title: High turnover flag (use `risk_diagnostics.turnover_value` OR `turnover.mean`
      / `turnover.latest` if available)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-30
    title: High concentration flag (max absolute weight from `fund_weights` or `ew_weights`)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-31
    title: Large drawdown flag (prefer `out_user_stats.max_drawdown` / `out_ew_stats.max_drawdown`
      when present)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-32
    title: Missing/empty key result sections flag (e.g., missing `out_user_stats`,
      missing `out_sample_scaled`, missing `period_results` in multi-period mode)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-33
    title: Ensure every bullet includes at least one numeric value with an explicit
      citation in `[from <source>]` format.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-34
    title: 'Add thresholds with sane defaults and environment overrides (keep small):'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-35
    title: '`TREND_EXPLAIN_TURNOVER_WARN` (default e.g. 0.75)'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-36
    title: '`TREND_EXPLAIN_MAX_WEIGHT_WARN` (default e.g. 0.20)'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-37
    title: '`TREND_EXPLAIN_MAX_DD_WARN` (default e.g. -0.20)'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-38
    title: 'Inject diagnostics into Streamlit Explain Results prompt context:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-39
    title: In `streamlit_app/components/explain_results.py::generate_result_explanation`,
      append the diagnostics block to `analysis_output` (or add as a distinct section
      passed to the chain) before the LLM call.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-40
    title: 'Inject diagnostics into CLI Explain Results prompt context:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-41
    title: In `src/trend/cli.py` explain command flow, append the same diagnostics
      block to the rendered `analysis_output` prior to `ResultSummaryChain.run(...)`.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-42
    title: 'Add unit tests (no live LLM required):'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-43
    title: 'New tests under `tests/` using synthetic `details` payloads to confirm:'
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-44
    title: The feedback block is deterministic (stable output for same input)
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-45
    title: Expected flags trigger given threshold-crossing values
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-46
    title: Each bullet includes at least one `[from ...]` citation
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-47
    title: No forward-looking phrases are introduced
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-48
    title: Add a small integration-style test ensuring both Streamlit and CLI code
      paths call the helper (import/callsite assertion is acceptable).
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-49
    title: Streamlit Explain Results prompt context contains the deterministic diagnostics
      block on completed runs.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-50
    title: CLI `trend explain` prompt context contains the same deterministic diagnostics
      block.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-51
    title: Diagnostics block contains only deterministic content derived from metrics
      (no model inference).
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-52
    title: Each diagnostic bullet contains at least one numeric metric with a valid
      `[from <source>]` citation.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-53
    title: Tests cover at least turnover + concentration + drawdown triggers and pass
      in CI.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-54
    title: Streamlit Explain Results prompt context contains the deterministic diagnostics
      block on completed runs.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-55
    title: CLI `trend explain` prompt context contains the same deterministic diagnostics
      block.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-56
    title: Diagnostics block contains only deterministic content derived from metrics
      (no model inference).
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-57
    title: Each diagnostic bullet contains at least one numeric metric with a valid
      `[from <source>]` citation.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
  - id: task-58
    title: Tests cover at least turnover + concentration + drawdown triggers and pass
      in CI.
    status: todo
    started_at: null
    finished_at: null
    commit: ''
    notes: []
