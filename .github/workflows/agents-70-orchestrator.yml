name: Agents 70 Orchestrator

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      enable_readiness:
        description: 'Run readiness probe (true/false)'
        required: false
        default: 'false'
      readiness_agents:
        description: 'Agents to probe (copilot,codex)'
        required: false
        default: 'copilot,codex'
      require_all:
        description: 'Fail readiness if any requested agent missing (true/false)'
        required: false
        default: 'false'
      enable_preflight:
        description: 'Run Codex preflight diagnostics (true/false)'
        required: false
        default: 'false'
      codex_user:
        description: 'Override Codex connector login'
        required: false
        default: ''
      enable_verify_issue:
        description: 'Verify a specific issue has an agent assignee (true/false)'
        required: false
        default: 'false'
      verify_issue_number:
        description: 'Issue number for verification (blank to skip)'
        required: false
        default: ''
      enable_watchdog:
        description: 'Run watchdog sanity checks (true/false)'
        required: false
        default: 'true'
      draft_pr:
        description: 'Open bootstrap PRs as draft (true/false)'
        required: false
        default: 'false'
      options_json:
        description: 'Additional toggles as JSON (diagnostic_mode, readiness_custom_logins, codex_command_phrase, ... )'
        required: false
        default: '{}'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: agents-orchestrator-${{ github.ref }}
  cancel-in-progress: true

jobs:
  orchestrate:
    name: Dispatch Agents Toolkit
    uses: ./.github/workflows/reusable-70-agents.yml
    # Job timeouts live inside reusable-70-agents.yml because workflow-call
    # dispatchers cannot set timeout-minutes directly. See reusable workflow for
    # the 30 minute ceiling that guards the downstream fan-out.
    # options_json schema (strings, defaults shown):
    # {
    #   "diagnostic_mode": "off" | "dry-run" | "full",
    #   "readiness_custom_logins": "login-a,login-b",
    #   "codex_command_phrase": "@codex start"
    # }
    with:
      enable_readiness: ${{ inputs.enable_readiness || 'false' }}
      readiness_agents: ${{ inputs.readiness_agents || 'copilot,codex' }}
      readiness_custom_logins: ${{ fromJson(inputs.options_json || '{}').readiness_custom_logins || '' }}
      require_all: ${{ inputs.require_all || 'false' }}
      enable_preflight: ${{ inputs.enable_preflight || 'false' }}
      codex_user: ${{ inputs.codex_user || '' }}
      codex_command_phrase: ${{ fromJson(inputs.options_json || '{}').codex_command_phrase || '' }}
      enable_diagnostic: ${{ (fromJson(inputs.options_json || '{}').diagnostic_mode || 'off') != 'off' && 'true' || 'false' }}
      diagnostic_attempt_branch: ${{ (fromJson(inputs.options_json || '{}').diagnostic_mode || 'off') == 'full' && 'true' || 'false' }}
      diagnostic_dry_run: ${{ (fromJson(inputs.options_json || '{}').diagnostic_mode || 'off') == 'full' && 'false' || 'true' }}
      enable_verify_issue: ${{ inputs.enable_verify_issue || ((inputs.verify_issue_number || '') != '' && 'true' || 'false') }}
      verify_issue_number: ${{ inputs.verify_issue_number || '' }}
      enable_watchdog: ${{ inputs.enable_watchdog || 'true' }}
      enable_keepalive: ${{ (fromJson(inputs.options_json || '{}').enable_keepalive == false || fromJson(inputs.options_json || '{}').enable_keepalive == 'false' || (fromJson(inputs.options_json || '{}').keepalive && (fromJson(inputs.options_json || '{}').keepalive.enabled == false || fromJson(inputs.options_json || '{}').keepalive.enabled == 'false'))) && 'false' || 'true' }}
      enable_bootstrap: ${{ (fromJson(inputs.options_json || '{}').enable_bootstrap == true || fromJson(inputs.options_json || '{}').enable_bootstrap == 'true' || (fromJson(inputs.options_json || '{}').bootstrap && (fromJson(inputs.options_json || '{}').bootstrap.enable == true || fromJson(inputs.options_json || '{}').bootstrap.enable == 'true'))) && 'true' || 'false' }}
      bootstrap_issues_label: ${{ fromJson(inputs.options_json || '{}').bootstrap_issues_label || (fromJson(inputs.options_json || '{}').bootstrap && fromJson(inputs.options_json || '{}').bootstrap.label) || 'agent:codex' }}
      draft_pr: ${{ inputs.draft_pr || 'false' }}
      options_json: ${{ inputs.options_json || '{}' }}
