name: Selftest 84 Reusable CI

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Why are you running this example?'
        required: false
        default: 'manual test'
      python-versions:
        description: >-
          JSON array of Python versions forwarded to `selftest-81-reusable-ci.yml` when
          exercising the reusable CI matrix.
        required: false
        default: '["3.11"]'
      summary_title:
        description: 'Optional heading used in the workflow summary.'
        required: false
        default: 'Selftest 84 Reusable CI Summary'

jobs:
  run-selftest:
    name: Run Reusable CI Self-Test
    uses: ./.github/workflows/selftest-81-reusable-ci.yml
    with:
      python-versions: ${{ inputs.python-versions }}
    secrets: inherit

  summarise:
    name: Summarise Results
    needs: run-selftest
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Append summary to workflow log
        env:
          SUMMARY_TITLE: ${{ inputs.summary_title }}
          WORKFLOW_RESULT: ${{ needs.run-selftest.result }}
          VERIFICATION_TABLE: ${{ needs.run-selftest.outputs.verification_table }}
          FAILURE_COUNT: ${{ needs.run-selftest.outputs.failures }}
        run: |
          table="${VERIFICATION_TABLE}"
          if [ -z "${table}" ]; then
            table='*Verification table not available.*'
          fi

          failures="${FAILURE_COUNT}"
          if [ -z "${failures}" ]; then
            failures='unknown'
          fi

          {
            echo "## ${SUMMARY_TITLE}"
            echo "Workflow status: ${WORKFLOW_RESULT}"
            echo ""
            printf '%s\n' "${table}"
            echo ""
            echo "Failures reported: ${failures}"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Surface failures in logs
        if: ${{ needs.run-selftest.outputs.failures != '' && needs.run-selftest.outputs.failures != '0' }}
        run: |
          echo "Selftest 84 reported ${{ needs.run-selftest.outputs.failures }} mismatch(es)." >&2
          exit 1
