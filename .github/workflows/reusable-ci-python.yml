name: Reusable Python CI

# Clean rebuilt reusable workflow. All previously duplicated / corrupted sections removed.
# Inputs are feature flags controlling optional artifacts and gates.

on:
  workflow_call:
    inputs:
      python-versions:
        description: JSON list Python versions
        required: false
        default: '["3.11"]'
        type: string
      coverage-min:
        description: Minimum coverage percent
        required: false
        default: '70'
        type: string
      run-mypy:
        description: Run mypy job
        required: false
        default: true
        type: boolean
      enable-metrics:
        description: Enable metrics extraction (ci-metrics.json)
        required: false
        default: false
        type: boolean
      slow-test-top:
        description: Count of slow tests to report
        required: false
        default: '15'
        type: string
      slow-test-min-seconds:
        description: Min seconds for slow test list
        required: false
        default: '1'
        type: string
      enable-classification:
        description: Enable failure classification
        required: false
        default: false
        type: boolean
      enable-history:
        description: Enable metrics history append
        required: false
        default: false
        type: boolean
      history-artifact-name:
        description: Artifact name for metrics history
        required: false
        default: metrics-history.ndjson
        type: string
      enable-coverage-delta:
        description: Enable coverage delta evaluation
        required: false
        default: false
        type: boolean
      baseline-coverage:
        description: Baseline coverage percent
        required: false
        default: '0'
        type: string
      coverage-alert-drop:
        description: Coverage drop alert threshold (pct pts)
        required: false
        default: '1'
        type: string
      fail-on-coverage-drop:
        description: Fail if drop >= threshold
        required: false
        default: 'false'
        type: string
      coverage-drop-label:
        description: Label to add on drop (future)
        required: false
        default: coverage-drop
        type: string
      enable-soft-gate:
        description: Enable soft coverage gate (aggregate + issue update)
        required: false
        default: false
        type: boolean
      coverage-hard-fail:
        description: Still fail build on coverage shortfall (true/false)
        required: false
        default: true
        type: boolean
      coverage-artifact-retention-days:
        description: Retention days for coverage artifacts
        required: false
        default: '10'
        type: string
      low-coverage-threshold:
        description: Percent threshold for low coverage spotlight table
        required: false
        default: '50'
        type: string

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}
        include:
          - python-version: "3.11"
            scenario: base
          - python-version: "3.11"
            scenario: metrics
            enable-metrics: true
          - python-version: "3.11"
            scenario: metrics-history
            enable-metrics: true
            enable-history: true
          - python-version: "3.11"
            scenario: classification
            enable-classification: true
          - python-version: "3.11"
            scenario: cov-delta
            enable-coverage-delta: true
            baseline-coverage: ${{ inputs.baseline-coverage }}
            enable-soft-gate: true
    continue-on-error: false
    env:
      # Matrix values take precedence when defined
      ENABLE_METRICS_FLAG: ${{ matrix.enable-metrics || inputs.enable-metrics }}
      ENABLE_HISTORY_FLAG: ${{ matrix.enable-history || inputs.enable-history }}
      ENABLE_CLASSIFICATION_FLAG: ${{ matrix.enable-classification || inputs.enable-classification }}
      ENABLE_COV_DELTA_FLAG: ${{ matrix.enable-coverage-delta || inputs.enable-coverage-delta }}
      ENABLE_SOFT_GATE_FLAG: ${{ matrix.enable-soft-gate || inputs.enable-soft-gate }}
      COVERAGE_HARD_FAIL_FLAG: ${{ inputs.coverage-hard-fail }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install pytest pytest-cov jq
      - name: Run tests with coverage
        run: |
          pytest --junitxml=pytest-junit.xml \
            --cov=src --cov-branch \
            --cov-report=xml:coverage.xml \
            --cov-report=json:coverage.json \
            --cov-report=term-missing
      - name: Prepare coverage artifacts
        run: |
          mv coverage.json coverage-${{ matrix.python-version }}.json
          test -f coverage-${{ matrix.python-version }}.json
          test -f coverage.xml
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-prefix }}coverage-${{ matrix.python-version }}
          retention-days: ${{ inputs.coverage-artifact-retention-days }}
          path: |
            coverage.xml
            coverage-${{ matrix.python-version }}.json
            pytest-junit.xml
      - name: Extract test metrics
        if: ${{ env.ENABLE_METRICS_FLAG == 'true' }}
        run: python scripts/ci_metrics.py
        env:
          JUNIT_PATH: pytest-junit.xml
          OUTPUT_PATH: ci-metrics.json
          TOP_N: ${{ inputs.slow-test-top }}
          MIN_SECONDS: ${{ inputs.slow-test-min-seconds }}
      - name: Upload metrics artifact
        if: ${{ env.ENABLE_METRICS_FLAG == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-prefix }}ci-metrics
          path: ci-metrics.json
      - name: Enforce coverage minimum (hard gate)
        if: ${{ env.COVERAGE_HARD_FAIL_FLAG == 'true' }}
        run: |
          RAW=$(grep -Eo 'line-rate="[0-9.]+"' coverage.xml | head -1 | sed -E 's/.*"([0-9.]+)"/\1/')
          PCT=$(python -c "print(float('$RAW')*100.0)")
          echo "Coverage: ${PCT}% (min ${{ inputs.coverage-min }}%)"
          python -c "import sys; cur=float('$PCT'); m=float('${{ inputs.coverage-min }}'); sys.exit(0 if cur>=m else 1)" || { echo 'Coverage below minimum' >&2; exit 1; }
      - name: Coverage delta
        if: ${{ env.ENABLE_COV_DELTA_FLAG == 'true' }}
        run: python scripts/ci_coverage_delta.py
        env:
          BASELINE_COVERAGE: ${{ inputs.baseline-coverage }}
          ALERT_DROP: ${{ inputs.coverage-alert-drop }}
          FAIL_ON_DROP: ${{ inputs.fail-on-coverage-drop }}
      - name: Upload coverage delta
        if: ${{ env.ENABLE_COV_DELTA_FLAG == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-prefix }}coverage-delta
          path: coverage-delta.json
      - name: History & classification
        if: ${{ env.ENABLE_HISTORY_FLAG == 'true' || env.ENABLE_CLASSIFICATION_FLAG == 'true' }}
        run: python scripts/ci_history.py
        env:
          JUNIT_PATH: pytest-junit.xml
          METRICS_PATH: ci-metrics.json
          HISTORY_PATH: ${{ inputs.history-artifact-name }}
          CLASSIFICATION_OUT: classification.json
      - name: Upload history artifact
        if: ${{ env.ENABLE_HISTORY_FLAG == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-prefix }}metrics-history
          path: ${{ inputs.history-artifact-name }}
      - name: Upload classification artifact
        if: ${{ env.ENABLE_CLASSIFICATION_FLAG == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-prefix }}classification
          path: classification.json
      - name: CI summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          for f in ci-metrics.json classification.json ${{ inputs.history-artifact-name }} coverage-delta.json; do
            if [ -f "$f" ]; then echo "- $(basename $f): present" >> $GITHUB_STEP_SUMMARY; fi
          done
      - name: Assert feature outputs
        run: python scripts/ci_feature_assert.py
        env:
          EXPECT_METRICS: ${{ env.ENABLE_METRICS_FLAG }}
          EXPECT_HISTORY: ${{ env.ENABLE_HISTORY_FLAG }}
          EXPECT_CLASSIFICATION: ${{ env.ENABLE_CLASSIFICATION_FLAG }}
          EXPECT_COV_DELTA: ${{ env.ENABLE_COV_DELTA_FLAG }}
          HISTORY_ARTIFACT_NAME: ${{ inputs.history-artifact-name }}

  mypy:
    if: ${{ inputs.run-mypy == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install mypy
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install mypy
      - name: Run mypy
        run: mypy src || (echo 'mypy failed' && exit 1)

  coverage_soft_gate:
    if: ${{ inputs.enable-soft-gate == 'true' }}
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      actions: read
    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifact-prefix }}coverage-*
          merge-multiple: true
      - name: Coverage summary
        shell: python
        env:
          LOW_COVERAGE_THRESHOLD: ${{ inputs.low-coverage-threshold }}
        run: |
          import glob, json, os
          thr=float(os.environ.get('LOW_COVERAGE_THRESHOLD','50'))
          files=sorted(glob.glob('coverage-*.json'))
          if not files:
            open('coverage_summary.md','w').write('**No coverage json files found**\n')
          else:
            totals=[]; hotspots=[]
            for f in files:
              try: data=json.load(open(f))
              except Exception: continue
              t=data.get('totals') or {}
              pct=t.get('percent_covered') or t.get('percent_covered_display') or 0
              try: pct=float(pct)
              except Exception: pct=0.0
              totals.append(pct)
              for path, meta in (data.get('files') or {}).items():
                s=meta.get('summary') or {}
                fp=s.get('percent_covered') or s.get('percent_covered_display') or 0
                try: fp=float(fp)
                except Exception: fp=0.0
                hotspots.append((fp,path))
            hotspots.sort(key=lambda x: x[0])
            avg=sum(totals)/len(totals) if totals else 0.0
            worst=min(totals) if totals else 0.0
            lines=[f"**Coverage (avg across jobs): {avg:.2f}% | worst job: {worst:.2f}%**","","| File | % covered |","|---|---:|"]
            for fp,f in hotspots[:15]: lines.append(f"| `{f}` | {fp:.1f}% |")
            low=[(p,f) for p,f in hotspots if p < thr]
            if low:
              lines+=['',f"#### Low Coverage (<{thr:.0f}% )","| File | % covered |","|---|---:|"]
              for p,f in low[:15]: lines.append(f"| `{f}` | {p:.1f}% |")
            open('coverage_summary.md','w').write('\n'.join(lines)+'\n')
      - name: Upload coverage summary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-prefix }}coverage-summary
          retention-days: ${{ inputs.coverage-artifact-retention-days }}
          path: coverage_summary.md

  logs_summary:
    if: ${{ always() }}
    needs: [tests]
    runs-on: ubuntu-latest
    permissions:
      actions: read
    steps:
      - name: Enumerate jobs
        id: jobs
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const run_id = context.runId;
            const { data } = await github.rest.actions.listJobsForWorkflowRun({ owner, repo, run_id, per_page: 100 });
            const rows = data.jobs.map(j => `| ${j.name} | ${j.conclusion || j.status} | [logs](${j.html_url}) |`);
            const md = ["### Logs for this run","| Job | Result | Logs |","|---|---|---|",...rows].join("\n");
            core.setOutput('table', md);
      - name: Append logs table
        run: |
          echo "${{ steps.jobs.outputs.table }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

# End of workflow

