name: CI

# Temporary compatibility wrapper (Issue #1345): preserves legacy "CI" check name
# while branch protection still expects it. Delegates to unified reusable-ci-python.yml.
# Remove after updating protection rules to reference granular jobs directly.

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ phase-2-dev ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  main:
    uses: ./.github/workflows/reusable-ci-python.yml
    with:
      python-versions: ${{ vars.CI_PY_VERSIONS || '["3.11"]' }}
      coverage-min: ${{ vars.COV_MIN || '70' }}
      run-mypy: true
      enable-metrics: false
      enable-history: false
      enable-classification: false
      enable-coverage-delta: false
      enable-soft-gate: true
      coverage-hard-fail: false
  workflow-automation:
    name: workflow / automation-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install -e '.[dev]'
      - name: Run workflow automation tests
        run: |
          PYTHONPATH=./src pytest \
            tests/test_automation_workflows.py \
            tests/test_workflow_autofix_guard.py \
            tests/test_workflow_autofix_remote.py \
            -q
  gate:
    name: gate / all-required-green
    runs-on: ubuntu-latest
    needs: [main, workflow-automation]
    steps:
      - run: echo "Reusable CI completed successfully." 
