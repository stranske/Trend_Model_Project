name: Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref_name }}-gate
  cancel-in-progress: true

jobs:
  changes:
    name: detect changed files
    runs-on: ubuntu-latest
    outputs:
      doc_only: ${{ steps.diff.outputs.doc_only }}
      run_core: ${{ steps.diff.outputs.run_core }}
      reason: ${{ steps.diff.outputs.reason }}
    steps:
      - name: Detect changes via API
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;

            if (eventName !== 'pull_request') {
              core.setOutput('doc_only', 'false');
              core.setOutput('run_core', 'true');
              core.setOutput('reason', 'non_pr_event');
              return;
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const classify = filename => {
              const normalised = filename.toLowerCase();
              return (
                normalised.endsWith('.md') ||
                normalised.startsWith('docs/') ||
                normalised.startsWith('assets/')
              );
            };

            const changedFiles = files.map(file => file.filename);
            const hasChanges = changedFiles.length > 0;
            const nonDocFiles = changedFiles.filter(filename => !classify(filename));

            const docOnly = hasChanges ? nonDocFiles.length === 0 : true;

            let reason = 'code_changes';
            if (!hasChanges) {
              reason = 'no_changes';
            } else if (docOnly) {
              reason = 'docs_only';
            }

            core.setOutput('doc_only', docOnly ? 'true' : 'false');
            core.setOutput('run_core', docOnly ? 'false' : 'true');
            core.setOutput('reason', reason);

  core-tests-311:
    name: core tests (3.11)
    needs: changes
    if: needs.changes.outputs.doc_only != 'true' && needs.changes.outputs.run_core == 'true'
    uses: ./.github/workflows/reusable-10-ci-python.yml
    with:
      python-version: '3.11'
      marker: "not quarantine and not slow"

  core-tests-312:
    name: core tests (3.12)
    needs: changes
    if: needs.changes.outputs.doc_only != 'true' && needs.changes.outputs.run_core == 'true'
    uses: ./.github/workflows/reusable-10-ci-python.yml
    with:
      python-version: '3.12'
      marker: "not quarantine and not slow"

  docker-smoke:
    name: docker smoke
    needs: changes
    if: needs.changes.outputs.doc_only != 'true' && needs.changes.outputs.run_core == 'true'
    uses: ./.github/workflows/reusable-12-ci-docker.yml

  gate:
    name: gate
    needs:
      - changes
      - core-tests-311
      - core-tests-312
      - docker-smoke
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
    steps:
      - name: Handle docs-only change
        if: needs.changes.outputs.doc_only == 'true'
        id: docs_only
        uses: actions/github-script@v7
        env:
          REASON: ${{ needs.changes.outputs.reason || 'docs_only' }}
        with:
          script: |
            const reason = process.env.REASON || 'docs_only';
            const marker = '<!-- gate-docs-only -->';
            const baseMessage = 'Gate fast-pass: docs-only change detected; heavy checks skipped.';
            const message =
              reason && reason !== 'docs_only'
                ? `${baseMessage} Reason: ${reason}.`
                : baseMessage;

            await core.summary.addHeading('Gate status', 3).addRaw(message).write();

            if (context.eventName === 'pull_request' && reason === 'docs_only') {
              const existingComments = await github.paginate(github.rest.issues.listComments, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                per_page: 100,
              });

              const alreadyCommented = existingComments.some(comment =>
                typeof comment.body === 'string' && comment.body.includes(marker)
              );

              if (!alreadyCommented) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `${marker}\n${message}`,
                });
              }
            }

            core.setOutput('state', 'success');
            core.setOutput('description', message);

      - name: Download coverage (3.11)
        if: ${{ needs.changes.outputs.doc_only != 'true' && needs.core-tests-311.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: coverage-3.11
          path: coverage/core-tests-311

      - name: Download coverage (3.12)
        if: ${{ needs.changes.outputs.doc_only != 'true' && needs.core-tests-312.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: coverage-3.12
          path: coverage/core-tests-312

      - name: Summarize results
        if: needs.changes.outputs.doc_only != 'true'
        id: summarize
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ### Gate status
          | Job | Result |
          | --- | ------ |
          | core-tests-311 | ${{ needs.core-tests-311.result }} |
          | core-tests-312 | ${{ needs.core-tests-312.result }} |
          | docker-smoke | ${{ needs.docker-smoke.result }} |
          EOF

          STATE="success"
          DESCRIPTION="All Gate checks succeeded."

          if [ "${{ needs.changes.outputs.run_core }}" != "true" ]; then
            REASON="${{ needs.changes.outputs.reason }}"
            if [ -z "$REASON" ]; then
              REASON="docs_only"
            fi
            {
              echo
              echo "Docs-only change detected; heavy checks skipped ($REASON)."
            } >> "$GITHUB_STEP_SUMMARY"
            DESCRIPTION="Docs-only change; heavy checks skipped ($REASON)."
          else
            if [ "${{ needs.core-tests-311.result }}" != "success" ]; then
              STATE="failure"
              DESCRIPTION="core-tests-311 result: ${{ needs.core-tests-311.result }}."
            elif [ "${{ needs.core-tests-312.result }}" != "success" ]; then
              STATE="failure"
              DESCRIPTION="core-tests-312 result: ${{ needs.core-tests-312.result }}."
            elif [ "${{ needs.docker-smoke.result }}" != "success" ]; then
              STATE="failure"
              DESCRIPTION="docker-smoke result: ${{ needs.docker-smoke.result }}."
            fi
          fi

          echo "state=$STATE" >> "$GITHUB_OUTPUT"
          echo "description=$DESCRIPTION" >> "$GITHUB_OUTPUT"

      - name: Report Gate commit status
        if: ${{ always() }}
        uses: actions/github-script@v7
        env:
          STATE: ${{ steps.summarize.outputs.state || steps.docs_only.outputs.state || 'pending' }}
          DESCRIPTION: ${{ steps.summarize.outputs.description || steps.docs_only.outputs.description || 'Gate status pending' }}
          TARGET_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request?.head?.sha ?? context.sha;
            const rawState = process.env.STATE || 'pending';
            const allowed = new Set(['error', 'failure', 'pending', 'success']);
            const state = allowed.has(rawState) ? rawState : 'pending';
            const rawDescription = process.env.DESCRIPTION || 'Gate status update';
            const description = rawDescription.length > 140 ? `${rawDescription.slice(0, 137)}...` : rawDescription;
            const targetUrl = process.env.TARGET_URL;

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state,
              context: 'Gate / gate',
              description,
              target_url: targetUrl,
            });

      - name: Enforce Gate success
        if: ${{ (steps.summarize.outputs.state || steps.docs_only.outputs.state) == 'failure' }}
        run: |
          echo "Gate reported failure: ${{ steps.summarize.outputs.description || steps.docs_only.outputs.description }}" >&2
          exit 1
