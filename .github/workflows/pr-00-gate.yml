name: Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref_name }}-gate
  cancel-in-progress: true

jobs:
  detect:
    name: detect changed files
    runs-on: ubuntu-latest
    outputs:
      doc_only: ${{ steps.diff.outputs.doc_only }}
      run_core: ${{ steps.diff.outputs.run_core }}
      reason: ${{ steps.diff.outputs.reason }}
      docker_changed: ${{ steps.diff.outputs.docker_changed }}
    steps:
      - name: Detect changes via API
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;

            if (eventName !== 'pull_request') {
              core.setOutput('doc_only', 'false');
              core.setOutput('run_core', 'true');
              core.setOutput('reason', 'non_pr_event');
              core.setOutput('docker_changed', 'true');
              return;
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const classify = filename => {
              const normalised = filename.toLowerCase();

              const docExtensions = [
                '.md',
                '.mdx',
                '.markdown',
                '.rst',
                '.txt',
                '.qmd',
                '.adoc',
              ];
              if (docExtensions.some(ext => normalised.endsWith(ext))) {
                return true;
              }

              const docBasenames = new Set([
                'readme',
                'changelog',
                'contributing',
                'code_of_conduct',
                'code-of-conduct',
                'security',
                'guidelines',
                'mkdocs',
                'docfx',
                'antora-playbook',
              ]);
              const basename = normalised.split('/').pop();
              if (basename) {
                const nameWithoutExt = basename.includes('.')
                  ? basename.slice(0, basename.lastIndexOf('.'))
                  : basename;
                if (docBasenames.has(nameWithoutExt)) {
                  return true;
                }
              }

              const docPrefixes = [
                'docs/',
                'docs\\',
                'docs_',
                'doc/',
                'doc\\',
                'assets/docs/',
                'assets/docs\\',
                'documentation/',
                'documentation\\',
                'guides/',
                'handbook/',
                'manual/',
              ];
              if (docPrefixes.some(prefix => normalised.startsWith(prefix))) {
                return true;
              }

              const docSegments = [
                '/docs/',
                '/doc/',
                '/documentation/',
                '/manual/',
                '/design-docs/',
                '/handbook/',
                '/guide/',
                '/guides/',
                '/adr/',
                '/rfcs/',
                '/specs/',
                '/notes/',
                '\\docs\\',
                '\\doc\\',
                '\\documentation\\',
                '\\manual\\',
                '\\design-docs\\',
                '\\handbook\\',
                '\\guide\\',
                '\\guides\\',
                '\\adr\\',
                '\\rfcs\\',
                '\\specs\\',
                '\\notes\\',
              ];
              if (docSegments.some(segment => normalised.includes(segment))) {
                return true;
              }

              return false;
            };

            const changedFiles = files.map(file => file.filename);
            const hasChanges = changedFiles.length > 0;
            const nonDocFiles = changedFiles.filter(filename => !classify(filename));

            const dockerRelated = filename => {
              // Treat top-level Docker artefacts, supporting directories, and ignore rules
              // as Docker-related so the smoke test only runs when these assets change.
              const normalised = filename.toLowerCase();

              if (normalised === 'dockerfile') {
                return true;
              }

              const dockerfileSuffixes = ['/dockerfile', '\\dockerfile'];
              if (dockerfileSuffixes.some(suffix => normalised.endsWith(suffix))) {
                return true;
              }

              if (normalised === '.dockerignore') {
                return true;
              }

              const dockerPrefixes = ['docker/', 'docker\\', '.docker/', '.docker\\'];
              if (dockerPrefixes.some(prefix => normalised.startsWith(prefix))) {
                return true;
              }

              const dockerSegments = ['/docker/', '\\docker\\'];
              if (dockerSegments.some(segment => normalised.includes(segment))) {
                return true;
              }

              return false;
            };

            const docOnly = hasChanges ? nonDocFiles.length === 0 : true;
            const dockerChanged = changedFiles.some(filename => dockerRelated(filename));

            let reason = 'code_changes';
            if (!hasChanges) {
              reason = 'no_changes';
            } else if (docOnly) {
              reason = 'docs_only';
            }

            core.setOutput('doc_only', docOnly ? 'true' : 'false');
            core.setOutput('run_core', docOnly ? 'false' : 'true');
            core.setOutput('reason', reason);
            core.setOutput('docker_changed', dockerChanged ? 'true' : 'false');

  core-tests-311:
    name: core tests (3.11)
    needs: detect
    if: needs.detect.outputs.doc_only != 'true' && needs.detect.outputs.run_core == 'true'
    uses: ./.github/workflows/reusable-10-ci-python.yml
    with:
      python-version: '3.11'
      marker: "not quarantine and not slow"

  core-tests-312:
    name: core tests (3.12)
    needs: detect
    if: needs.detect.outputs.doc_only != 'true' && needs.detect.outputs.run_core == 'true'
    uses: ./.github/workflows/reusable-10-ci-python.yml
    with:
      python-version: '3.12'
      marker: "not quarantine and not slow"

  docker-smoke:
    name: docker smoke
    needs: detect
    if: needs.detect.outputs.doc_only != 'true' && needs.detect.outputs.run_core == 'true' && needs.detect.outputs.docker_changed == 'true'
    uses: ./.github/workflows/reusable-12-ci-docker.yml

  gate:
    name: gate
    needs:
      - detect
      - core-tests-311
      - core-tests-312
      - docker-smoke
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
    steps:
      - name: Handle docs-only change
        if: needs.detect.outputs.doc_only == 'true'
        id: docs_only
        uses: actions/github-script@v7
        env:
          REASON: ${{ needs.detect.outputs.reason || 'docs_only' }}
        with:
          script: |
            const reason = process.env.REASON || 'docs_only';

            let message;
            if (!reason || reason === 'docs_only') {
              message = 'Gate fast-pass: docs-only change detected; heavy checks skipped.';
            } else if (reason === 'no_changes') {
              message = 'Gate fast-pass: no changes detected; heavy checks skipped.';
            } else {
              message = `Gate fast-pass: docs-only change detected; heavy checks skipped. Reason: ${reason}.`;
            }

            core.info(message);
            core.setOutput('state', 'success');
            core.setOutput('description', message);

            await core.summary
              .addHeading('Gate docs-only fast-pass', 3)
              .addRaw(`${message}\n`)
              .write();

      - name: Clean up legacy docs-only comment
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName !== 'pull_request') {
              core.info('Not a pull_request event; nothing to clean up.');
              return;
            }

            const marker = '<!-- gate-docs-only -->';
            const baseMessage =
              'Gate fast-pass: docs-only change detected; heavy checks skipped.';
            const legacyBodies = new Set([baseMessage]);

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const existing = comments.find(comment => {
              if (typeof comment.body !== 'string') {
                return false;
              }

              if (comment.body.includes(marker)) {
                return true;
              }

              const trimmed = comment.body.trim();
              if (legacyBodies.has(trimmed)) {
                return true;
              }

              return trimmed.startsWith(baseMessage);
            });

            if (!existing) {
              core.info('No docs-only fast-pass comment found to remove.');
              return;
            }

            await github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existing.id,
            });

            core.info(`Removed docs-only fast-pass comment ${existing.id}.`);

      - name: Download coverage (3.11)
        id: coverage_311
        if: ${{ needs.detect.outputs.doc_only != 'true' && needs.core-tests-311.result != 'skipped' }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: coverage-3.11
          path: coverage/core-tests-311

      - name: Download coverage (3.12)
        id: coverage_312
        if: ${{ needs.detect.outputs.doc_only != 'true' && needs.core-tests-312.result != 'skipped' }}
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: coverage-3.12
          path: coverage/core-tests-312

      - name: Normalize coverage runtimes
        if: ${{ steps.coverage_311.outcome == 'success' || steps.coverage_312.outcome == 'success' }}
        run: |
          set -euo pipefail

          normalize() {
            local source="$1"
            local version="$2"

            if [ ! -d "$source" ]; then
              echo "Coverage payload for ${version} not found at ${source}; skipping."
              return 0
            fi

            mkdir -p coverage/runtimes
            local target="coverage/runtimes/${version}"

            rm -rf "${target}"
            mv "$source" "${target}"
          }

          normalize "coverage/core-tests-311" "3.11"
          normalize "coverage/core-tests-312" "3.12"

      - name: Upload coverage bundle (3.11)
        if: ${{ steps.coverage_311.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-3.11
          path: coverage/runtimes/3.11
          if-no-files-found: ignore
          overwrite: true

      - name: Upload coverage bundle (3.12)
        if: ${{ steps.coverage_312.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-3.12
          path: coverage/runtimes/3.12
          if-no-files-found: ignore
          overwrite: true

      - name: Summarize results
        if: ${{ always() }}
        id: summarize
        run: |
          set -euo pipefail

          DOC_ONLY="${{ needs.detect.outputs.doc_only }}"
          RUN_CORE="${{ needs.detect.outputs.run_core }}"
          REASON="${{ needs.detect.outputs.reason }}"
          CORE_311="${{ needs.core-tests-311.result || 'skipped' }}"
          CORE_312="${{ needs.core-tests-312.result || 'skipped' }}"
          DOCKER="${{ needs.docker-smoke.result || 'skipped' }}"
          DOCKER_CHANGED="${{ needs.detect.outputs.docker_changed || 'false' }}"

          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
          ### Gate status
          | Job | Result |
          | --- | ------ |
          | core-tests-311 | ${CORE_311:-unknown} |
          | core-tests-312 | ${CORE_312:-unknown} |
          | docker-smoke | ${DOCKER:-unknown} |
          EOF

          STATE="success"
          DESCRIPTION="All Gate checks succeeded."

          doc_only_normalized="${DOC_ONLY:-false}"
          run_core_normalized="${RUN_CORE:-true}"

          if [ "${doc_only_normalized}" = "true" ] || [ "${run_core_normalized}" != "true" ]; then
            if [ -z "${REASON}" ]; then
              REASON="docs_only"
            fi

            NOTE="Docs-only change detected; heavy checks skipped."
            DESCRIPTION="Gate fast-pass: docs-only change detected; heavy checks skipped."
            if [ "${REASON}" != "docs_only" ]; then
              NOTE="Docs-only change detected; heavy checks skipped (${REASON})."
              DESCRIPTION="Docs-only change; heavy checks skipped (${REASON})."
            fi

            {
              echo
              echo "${NOTE}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            if [ "${CORE_311}" != "success" ]; then
              STATE="failure"
              DESCRIPTION="core-tests-311 result: ${CORE_311}."
            elif [ "${CORE_312}" != "success" ]; then
              STATE="failure"
              DESCRIPTION="core-tests-312 result: ${CORE_312}."
            elif [ "${DOCKER_CHANGED}" = "true" ] && [ "${DOCKER}" != "success" ]; then
              STATE="failure"
              DESCRIPTION="docker-smoke result: ${DOCKER}."
            elif [ "${DOCKER_CHANGED}" != "true" ]; then
              {
                echo
                echo "Docker smoke skipped: no Docker-related changes detected."
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

          {
            echo "state=${STATE}"
            echo "description=${DESCRIPTION}"
          } >> "$GITHUB_OUTPUT"

      - name: Report Gate commit status
        if: ${{ always() }}
        uses: actions/github-script@v7
        env:
          STATE: ${{ steps.summarize.outputs.state || steps.docs_only.outputs.state || 'pending' }}
          DESCRIPTION: ${{ steps.summarize.outputs.description || steps.docs_only.outputs.description || 'Gate status pending' }}
          TARGET_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request?.head?.sha ?? context.sha;
            const rawState = process.env.STATE || 'pending';
            const allowed = new Set(['error', 'failure', 'pending', 'success']);
            const state = allowed.has(rawState) ? rawState : 'pending';
            const rawDescription = process.env.DESCRIPTION || 'Gate status update';
            const description = rawDescription.length > 140 ? `${rawDescription.slice(0, 137)}...` : rawDescription;
            const targetUrl = process.env.TARGET_URL;

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state,
              context: 'Gate / gate',
              description,
              target_url: targetUrl,
            });

      - name: Enforce Gate success
        if: ${{ (steps.summarize.outputs.state || steps.docs_only.outputs.state) == 'failure' }}
        run: |
          echo "Gate reported failure: ${{ steps.summarize.outputs.description || steps.docs_only.outputs.description }}" >&2
          exit 1
