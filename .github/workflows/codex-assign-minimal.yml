name: Codex Assign Minimal

on:
  issues:
    types: [labeled, opened, reopened]
  workflow_dispatch:
    inputs:
      test_issue:
        description: "Manual test: issue number to treat as labeled"
        required: false
      simulate_label:
        description: "Comma separated labels to simulate (include agent:codex to trigger)"
        required: false
      allow_fallback:
        description: "Override allow_fallback (true|false) for simulation"
        required: false
      codex_command:
        description: "Override Codex command (testing invalid command paths)"
        required: false

concurrency:
  group: codex-bootstrap-${{ github.event.issue.number || github.event.inputs.test_issue || 'unknown' }}
  cancel-in-progress: false

jobs:
  detect:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
      pull-requests: read
    outputs:
      needs_codex_bootstrap: ${{ steps.detect.outputs.needs_codex_bootstrap }}
      codex_issue: ${{ steps.detect.outputs.codex_issue }}
      detection_reason: ${{ steps.detect.outputs.detection_reason }}
      sim_force_branch_fail: ${{ steps.detect.outputs.sim_force_branch_fail }}
      sim_force_dual_fail: ${{ steps.detect.outputs.sim_force_dual_fail }}
      sim_manual_mode: ${{ steps.detect.outputs.sim_manual_mode }}
      sim_suppressed: ${{ steps.detect.outputs.sim_suppressed }}
      allow_fallback_override: ${{ steps.detect.outputs.allow_fallback_override }}
      codex_command: ${{ steps.detect.outputs.codex_command }}
    steps:
      - name: Detect codex label
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const inputs = context.payload.inputs || {};
            const manualIssueRaw = (inputs.test_issue || '').trim();
            const manualIssue = manualIssueRaw && /^(\d+)$/.test(manualIssueRaw) ? manualIssueRaw : '';
            if (manualIssueRaw && !manualIssue) { core.warning(`Ignoring non-numeric test_issue input: '${manualIssueRaw}'`); }
            const simulated = (inputs.simulate_label || '').split(',').map(s => s.trim()).filter(Boolean);
            const issue = context.payload.issue;
            let needs = 'false'; let num = ''; let reason = 'no-issue-context';
            let labels = [];
            const allowFallbackOverride = (inputs.allow_fallback || '').trim();
            const codexCommand = (inputs.codex_command || '').trim();
            if (issue) {
              num = String(issue.number);
              labels = (issue.labels || []).map(l => l.name);
              if (labels.includes('agent:codex')) { needs = 'true'; reason = 'labeled-issue-event'; } else { reason = 'issue-without-label'; }
            } else if (manualIssue) {
              num = manualIssue;
              const lowered = simulated.map(s => s.toLowerCase());
              if (lowered.includes('agent:codex')) { needs = 'true'; reason = 'manual-dispatch-simulated-label'; } else { reason = 'manual-dispatch-missing-simulated-label'; }
            } else if (manualIssueRaw && !manualIssue) { reason = 'invalid-manual-issue'; }
            const lowerAll = labels.map(l => l.toLowerCase()).concat(simulated.map(s=>s.toLowerCase()));
            function has(tag){ return lowerAll.includes(tag); }
            core.setOutput('sim_force_branch_fail', has('codex-sim:primary-fail') ? 'true':'false');
            core.setOutput('sim_force_dual_fail', has('codex-sim:dual-fail') ? 'true':'false');
            core.setOutput('sim_manual_mode', has('codex-sim:manual') ? 'true':'false');
            core.setOutput('sim_suppressed', has('codex-sim:suppress') ? 'true':'false');
            if (allowFallbackOverride === 'true' || allowFallbackOverride === 'false') core.setOutput('allow_fallback_override', allowFallbackOverride); else core.setOutput('allow_fallback_override','');
            if (codexCommand) core.setOutput('codex_command', codexCommand); else core.setOutput('codex_command','');
            core.setOutput('needs_codex_bootstrap', needs);
            core.setOutput('codex_issue', num);
            core.setOutput('detection_reason', reason);
            core.info(`needs_codex_bootstrap=${needs} issue=${num} reason=${reason}`);
      - name: Detection summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const tbl = [
              [{data:'Issue',header:true},{data:'Needs',header:true},{data:'Reason',header:true},{data:'PrimaryFail',header:true},{data:'DualFail',header:true},{data:'Manual',header:true},{data:'Suppressed',header:true},{data:'AllowFallbackOv',header:true},{data:'CmdOverride',header:true}],
              ['${{ steps.detect.outputs.codex_issue }}' || '(none)', '${{ steps.detect.outputs.needs_codex_bootstrap }}', '${{ steps.detect.outputs.detection_reason }}', '${{ steps.detect.outputs.sim_force_branch_fail }}', '${{ steps.detect.outputs.sim_force_dual_fail }}', '${{ steps.detect.outputs.sim_manual_mode }}', '${{ steps.detect.outputs.sim_suppressed }}', '${{ steps.detect.outputs.allow_fallback_override }}', '${{ steps.detect.outputs.codex_command }}']
            ];
            core.summary.addHeading('Codex Detection Summary').addTable(tbl).write();
      - name: No trigger note
        if: steps.detect.outputs.needs_codex_bootstrap != 'true'
        run: echo "No bootstrap triggered (reason=${{ steps.detect.outputs.detection_reason }})."

  codex_bootstrap:
    needs: detect
    if: needs.detect.outputs.needs_codex_bootstrap == 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository (required for local action)
        uses: actions/checkout@v4
      - name: Bootstrap Codex
        id: bootstrap
        uses: ./.github/actions/codex-bootstrap
        with:
          issue: ${{ needs.detect.outputs.codex_issue }}
          service_bot_pat: ${{ secrets.SERVICE_BOT_PAT || '' }}
          allow_fallback: ${{ needs.detect.outputs.allow_fallback_override != '' && needs.detect.outputs.allow_fallback_override || vars.CODEX_ALLOW_FALLBACK || 'true' }}
          codex_command: "${{ needs.detect.outputs.codex_command != '' && needs.detect.outputs.codex_command || 'codex: start' }}"
          pr_mode: "${{ needs.detect.outputs.sim_manual_mode == 'true' && 'manual' || 'auto' }}"
          suppress_activate: "${{ needs.detect.outputs.sim_suppressed }}"
          force_branch_fail: "${{ needs.detect.outputs.sim_force_branch_fail }}"
          force_dual_fail: "${{ needs.detect.outputs.sim_force_dual_fail }}"
          fail_on_invalid_command: true
          net_retry_attempts: 2
          net_retry_delay_s: 3
      - name: Upload bootstrap artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-bootstrap-${{ needs.detect.outputs.codex_issue || 'unknown' }}
          path: codex-artifacts
          if-no-files-found: ignore
      - name: Bootstrap outputs summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = core.getInput('codex_pr') || process.env.CODEX_PR || '';
            core.summary
              .addHeading('Codex Bootstrap Outputs')
              .addTable([
                [{data:'Output',header:true},{data:'Value',header:true}],
                ['codex_pr', '${{ steps.bootstrap.outputs.codex_pr || '' }}'],
                ['codex_reused', '${{ steps.bootstrap.outputs.codex_reused || '' }}'],
                ['branch_created', '${{ steps.bootstrap.outputs.branch_created || '' }}'],
                ['token_source', '${{ steps.bootstrap.outputs.token_source || '' }}'],
                ['fallback_used', '${{ steps.bootstrap.outputs.fallback_used || '' }}']
              ])
              .write();
      - name: Structured JSON summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            fs.mkdirSync('codex-artifacts', { recursive: true });
            const summary = {
              issue: '${{ needs.detect.outputs.codex_issue }}',
              detection_reason: '${{ needs.detect.outputs.detection_reason }}',
              codex_pr: '${{ steps.bootstrap.outputs.codex_pr || '' }}',
              codex_reused: '${{ steps.bootstrap.outputs.codex_reused || '' }}',
              branch_created: '${{ steps.bootstrap.outputs.branch_created || '' }}',
              token_source: '${{ steps.bootstrap.outputs.token_source || '' }}',
              fallback_used: '${{ steps.bootstrap.outputs.fallback_used || '' }}',
              ts: new Date().toISOString()
            };
            fs.writeFileSync('codex-artifacts/codex_bootstrap_summary.json', JSON.stringify(summary, null, 2));
            core.info('Wrote codex-artifacts/codex_bootstrap_summary.json');
