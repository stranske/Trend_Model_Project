name: Keepalive Branch Sync

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: Target pull request number
        required: true
      trace:
        description: Keepalive trace identifier
        required: true
      base_ref:
        description: Base branch for the PR
        required: true
      head_ref:
        description: PR head branch
        required: true
      head_sha:
        description: PR head SHA at time of dispatch
        required: true
      head_repository:
        description: Full name of the head repository
        required: false
      head_is_fork:
        description: Whether the PR originates from a fork
        required: false
      agent:
        description: Agent alias requesting the sync
        required: false
      round:
        description: Keepalive round number
        required: false
      idempotency_key:
        description: Sync attempt idempotency key
        required: false

jobs:
  sync:
    name: Prepare sync PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      PREFERRED_TOKEN: ${{ secrets.ACTIONS_BOT_PAT || secrets.SERVICE_BOT_PAT || github.token }}
    steps:
      - name: Validate fork inputs
        id: validate
        run: |
          if [ "${{ inputs.head_is_fork || 'false' }}" = "true" ] && [ -z "${{ inputs.head_repository }}" ]; then
            {
              echo "## Keepalive branch sync";
              echo "";
              echo "Forked PR detected but head repository missing; skipping checkout to avoid fetching the base repo.";
            } >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Forked PR requires head_repository input; aborting sync."
            exit 1
          fi
      - name: Warn when head repository is missing
        run: |
          if [ -z "${{ inputs.head_repository }}" ]; then
            echo "::warning::Head repository missing; defaulting to base repository for checkout."
          fi
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.head_repository || github.repository }}
          ref: ${{ inputs.head_ref }}
          fetch-depth: 0
          token: ${{ env.PREFERRED_TOKEN }}

      - name: Configure git author
        run: |
          git config user.name "stranske automation"
          git config user.email "stranske-automation-bot@users.noreply.github.com"

      - name: Sync branch (direct merge)
        env:
          BASE_REF: ${{ inputs.base_ref }}
          HEAD_REF: ${{ inputs.head_ref }}
        run: |
          set -euo pipefail
          
          echo "Syncing $HEAD_REF with origin/$BASE_REF..."
          
          # Fetch latest base
          git fetch origin "$BASE_REF"
          
          # Merge base into head
          # We use --no-edit to accept default merge message
          if ! git merge origin/"$BASE_REF" --no-edit; then
            echo "::error::Merge conflict detected. Manual intervention required."
            # Abort merge to leave clean state (though runner dies anyway)
            git merge --abort || true
            exit 1
          fi
          
          # Push changes
          if ! git push origin HEAD:refs/heads/"$HEAD_REF"; then
            echo "::error::Failed to push synced branch. It may have diverged or is protected."
            exit 1
          fi
          
          echo "Successfully synced $HEAD_REF with $BASE_REF"
