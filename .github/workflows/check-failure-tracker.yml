name: Track failed checks

on:
  workflow_run:
    workflows: [CI, Docker]
    types: [completed]

permissions:
  issues: write

jobs:
  track:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const conclusion = run.conclusion;
            const { owner, repo } = context.repo;
            const wfName = run.name;
            const title = `${wfName} failing`;
            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}" label:ci-failure`
            });
            const issue = search.data.items[0];
            if (conclusion !== 'success') {
              if (issue) {
                await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: `Run ${run.html_url} failed.` });
              } else {
                await github.rest.issues.create({
                  owner, repo,
                  title,
                  body: `Workflow [${wfName}](${run.html_url}) failed.`,
                  labels: ['ci-failure', 'agent:codex']
                });
              }
            } else if (issue) {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: `Workflow ${wfName} succeeded: ${run.html_url}` });
              await github.rest.issues.update({ owner, repo, issue_number: issue.number, state: 'closed' });
            }
