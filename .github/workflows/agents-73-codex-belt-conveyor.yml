# Closes the loop: merge successful Codex belt PRs, tidy branches and issues,
# and immediately nudge the dispatcher for the next item in the queue.
name: Agents 73 Codex Belt Conveyor

on:
  workflow_call:
    inputs:
      issue:
        description: 'Source issue number for the Codex belt PR'
        required: true
        type: number
      branch:
        description: 'Branch associated with the Codex belt PR (codex/issue-<n>)'
        required: true
        type: string
      pr_number:
        description: 'Pull request number to promote'
        required: true
        type: number
      head_sha:
        description: 'Head SHA used to evaluate status checks'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Preview conveyor actions without writes'
        required: false
        default: false
        type: boolean
    secrets:
      actions_bot_pat:
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: codex-belt-conveyor
  cancel-in-progress: false

jobs:
  promote:
    name: Promote merged Codex belt PR
    runs-on: ubuntu-latest
    outputs:
      merged: ${{ steps.merge.outputs.merged || 'false' }}
      dry_run: ${{ steps.mode.outputs.dry_run || 'false' }}
    env:
      ACTIONS_BOT_PAT: ${{ secrets.actions_bot_pat }}

    steps:
      - name: Determine conveyor mode
        id: mode
        run: |
          echo "dry_run=${{ inputs.dry_run }}" >>"$GITHUB_OUTPUT"

      - name: Summarise invocation
        uses: actions/github-script@v7
        with:
          script: |
            const summary = core.summary;
            summary
              .addHeading('Codex Belt Conveyor')
              .addTable([
                [
                  { data: 'Issue', header: true },
                  { data: 'Branch', header: true },
                  { data: 'PR', header: true }
                ],
                [
                  `#${{ inputs.issue }}`,
                  '${{ inputs.branch }}',
                  `#${{ inputs.pr_number }}`
                ]
              ])
              .write();

      - name: Load PR details
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const branch = '${{ inputs.branch }}'.trim();
            const expectedIssue = Number('${{ inputs.issue }}');
            const { owner, repo } = context.repo;

            const { data } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            if (data.state !== 'open') {
              core.setFailed(`PR #${prNumber} is not open (state=${data.state}).`);
              return;
            }
            if (data.draft) {
              core.setFailed(`PR #${prNumber} is still marked as draft.`);
              return;
            }
            const headBranch = data.head && data.head.ref ? data.head.ref : '';
            if (headBranch !== branch) {
              core.setFailed(`PR #${prNumber} is running on ${headBranch} instead of ${branch}.`);
              return;
            }
            const match = headBranch.match(/^codex\/issue-(\d+)$/);
            if (!match) {
              core.setFailed(`Branch ${headBranch} is not a codex belt branch.`);
              return;
            }
            const inferredIssue = Number(match[1]);
            if (expectedIssue && inferredIssue !== expectedIssue) {
              core.warning(`Expected issue #${expectedIssue} but branch implies #${inferredIssue}. Using branch hint.`);
            }

            core.setOutput('issue', String(inferredIssue || expectedIssue || ''));
            core.setOutput('head_sha', data.head && data.head.sha ? data.head.sha : '');
            core.setOutput('base', data.base && data.base.ref ? data.base.ref : '');

      - name: Ensure Gate succeeded
        id: gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const headSha = '${{ inputs.head_sha }}'.trim() || '${{ steps.pr.outputs.head_sha }}';
            if (!headSha) {
              core.setFailed('Unable to determine head SHA for status inspection.');
              return;
            }
            const { owner, repo } = context.repo;
            const { data } = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: headSha });
            if (!data || data.state !== 'success') {
              const state = data && data.state ? data.state : '(unknown)';
              core.setFailed(`Combined status for ${headSha} is ${state}; conveyor requires success.`);
              return;
            }

      - name: Merge PR with squash
        if: ${{ steps.mode.outputs.dry_run != 'true' }}
        id: merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const { owner, repo } = context.repo;
            try {
              await github.rest.pulls.merge({ owner, repo, pull_number: prNumber, merge_method: 'squash' });
              core.setOutput('merged', 'true');
            } catch (error) {
              core.setFailed(`Failed to merge PR #${prNumber}: ${error.message}`);
            }

      - name: Delete branch after merge
        if: ${{ steps.mode.outputs.dry_run != 'true' && steps.merge.outputs.merged == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const branch = '${{ inputs.branch }}';
            const { owner, repo } = context.repo;
            try {
              await github.rest.git.deleteRef({ owner, repo, ref: `heads/${branch}` });
            } catch (error) {
              core.warning(`Failed to delete branch ${branch}: ${error.message}`);
            }

      - name: Close source issue
        if: ${{ steps.mode.outputs.dry_run != 'true' && steps.merge.outputs.merged == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const issue = Number('${{ inputs.issue }}') || Number('${{ steps.pr.outputs.issue }}');
            const { owner, repo } = context.repo;
            if (!issue) {
              core.warning('Unable to resolve issue number; skipping issue closure.');
              return;
            }
            try {
              await github.rest.issues.update({ owner, repo, issue_number: issue, state: 'closed' });
            } catch (error) {
              core.warning(`Failed to close issue #${issue}: ${error.message}`);
            }
            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: issue, name: 'status:in-progress' });
            } catch (error) {
              if (error.status !== 404) {
                core.warning(`Failed to remove status:in-progress: ${error.message}`);
              }
            }
            try {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue, body: 'Merged via Codex Belt Conveyor after Gate success.' });
            } catch (error) {
              core.warning(`Failed to comment on issue #${issue}: ${error.message}`);
            }

      - name: Leave merge confirmation on PR
        if: ${{ steps.mode.outputs.dry_run != 'true' && steps.merge.outputs.merged == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const issue = Number('${{ inputs.issue }}') || Number('${{ steps.pr.outputs.issue }}');
            const { owner, repo } = context.repo;
            try {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: `Gate succeeded; merged automatically and closed issue #${issue || '(unknown)'}.` });
            } catch (error) {
              core.warning(`Failed to comment on PR #${prNumber}: ${error.message}`);
            }

      - name: Summarise conveyor preview
        if: ${{ steps.mode.outputs.dry_run == 'true' }}
        run: |
          cat <<'EOF' >>"$GITHUB_STEP_SUMMARY"
          Conveyor executed in preview mode. No merges or clean-up actions were performed.
          EOF
