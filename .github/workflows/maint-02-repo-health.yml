name: Maint 02 Repo Health

on:
  schedule:
    # 04:17 UTC every day provides a stable, low-traffic window.
    - cron: '17 4 * * *'
    # Monday 06:45 UTC generates a longer-form weekly snapshot for Ops.
    - cron: '45 6 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/maint-02-repo-health.yml'
      - 'tools/repo_health_probe.py'
  push:
    branches: [phase-2-dev]
    paths:
      - '.github/workflows/maint-02-repo-health.yml'
      - 'tools/repo_health_probe.py'

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  health:
    name: Nightly repository health checks
    runs-on: ubuntu-latest
    env:
      OPS_ISSUE_NUMBER: ${{ vars.OPS_HEALTH_ISSUE || secrets.OPS_HEALTH_ISSUE || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run actionlint
        id: actionlint
        continue-on-error: true
        uses: reviewdog/action-actionlint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-check
          fail_on_error: true

      - name: Probe repository configuration
        id: probe
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m tools.repo_health_probe repo-health-report.json

      - name: Evaluate results
        id: evaluate
        env:
          ACTIONLINT_STATUS: ${{ steps.actionlint.outcome }}
          OPS_ISSUE_NUMBER: ${{ env.OPS_ISSUE_NUMBER }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          from tools.repo_health_probe import build_summary

          report_path = pathlib.Path("repo-health-report.json")
          if report_path.exists():
            report = json.loads(report_path.read_text(encoding="utf-8"))
          else:
            report = {"failures": [], "errors": ["Report file repo-health-report.json is missing."]}

          actionlint_ok = os.environ.get("ACTIONLINT_STATUS") == "success"
          issue_id_present = bool(os.environ.get("OPS_ISSUE_NUMBER"))

          summary = build_summary(report, actionlint_ok=actionlint_ok, issue_id_present=issue_id_present)
          summary_path = pathlib.Path("repo-health-summary.md")
          summary_path.write_text(summary.summary_markdown + "\n", encoding="utf-8")

          issues_payload = "\n".join(summary.issue_lines)
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            print(f"status={summary.status}", file=fh)
            print("summary<<EOF", file=fh)
            print(summary.summary_markdown, file=fh)
            print("EOF", file=fh)
            print("issues<<EOF", file=fh)
            print(issues_payload, file=fh)
            print("EOF", file=fh)
          PY

      - name: Publish run summary
        run: |
          cat repo-health-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Update Ops issue on failure
        if: steps.evaluate.outputs.status == 'failure' && env.OPS_ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        env:
          OPS_ISSUE_NUMBER: ${{ env.OPS_ISSUE_NUMBER }}
          ISSUE_LINES: ${{ steps.evaluate.outputs.issues }}
        with:
          script: |
            const issueNumber = parseInt(process.env.OPS_ISSUE_NUMBER, 10);
            if (!issueNumber) {
              core.warning('OPS_ISSUE_NUMBER is not a valid integer.');
              return;
            }

            const marker = '<!-- repo-health-nightly -->';
            const runLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const issueLines = process.env.ISSUE_LINES?.trim() || 'No additional details available.';
            const body = `${marker}\n### Repo health nightly alert\n\n${issueLines}\n\n- Workflow run: ${runLink}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body,
              });
            }

      - name: Fail job on issues
        if: steps.evaluate.outputs.status == 'failure' && github.event_name != 'pull_request'
        run: |
          echo "Repository health checks reported issues." >&2
          exit 1
