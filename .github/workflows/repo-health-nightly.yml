name: Repo health nightly

on:
  schedule:
    # 04:17 UTC every day provides a stable, low-traffic window.
    - cron: '17 4 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  health:
    name: Nightly repository health checks
    runs-on: ubuntu-latest
    env:
      OPS_ISSUE_NUMBER: ${{ vars.OPS_HEALTH_ISSUE || secrets.OPS_HEALTH_ISSUE || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run actionlint
        id: actionlint
        continue-on-error: true
        uses: reviewdog/action-actionlint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-check

      - name: Probe repository configuration
        id: probe
        continue-on-error: true
        run: |
          python .github/scripts/repo_health_probe.py repo-health-report.json

      - name: Evaluate results
        id: evaluate
        env:
          ACTIONLINT_OUTCOME: ${{ steps.actionlint.outcome }}
          PROBE_OUTCOME: ${{ steps.probe.outcome }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib

          report_path = pathlib.Path("repo-health-report.json")
          report = {}
          if report_path.exists():
            try:
              report = json.loads(report_path.read_text(encoding="utf-8"))
            except json.JSONDecodeError as exc:
              report = {"errors": [f"Invalid report JSON: {exc}"], "failures": []}
          else:
            report = {"errors": ["Report file repo-health-report.json is missing."], "failures": []}

          issue_lines = []

          if os.environ.get("ACTIONLINT_OUTCOME") != "success":
            issue_lines.append("- Workflow lint (`actionlint`) failed. Inspect the job logs for errors.")

          for failure in report.get("failures", []) or []:
            description = failure.get("description") or "Repository configuration check failed."
            detail = failure.get("details")
            if detail:
              issue_lines.append(f"- {description} — {detail}")
            else:
              issue_lines.append(f"- {description}")

          for api_error in report.get("errors", []) or []:
            issue_lines.append(f"- API error: {api_error}")

          status = "success" if not issue_lines else "failure"

          summary_lines = []
          if status == "success":
            summary_lines.append("✅ Repo health nightly checks passed.")
            summary_lines.append("- Workflow lint (`actionlint`) succeeded.")
            summary_lines.append("- Required labels and secrets are present.")
          else:
            summary_lines.append("❌ Repo health nightly checks found issues:")
            summary_lines.extend(issue_lines)

          summary = "\n".join(summary_lines)
          issues_markdown = "\n".join(issue_lines)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            print(f"status={status}", file=fh)
            print("summary<<EOF", file=fh)
            print(summary, file=fh)
            print("EOF", file=fh)
            print("issues<<EOF", file=fh)
            print(issues_markdown, file=fh)
            print("EOF", file=fh)

          pathlib.Path("repo-health-summary.md").write_text(summary, encoding="utf-8")
          PY

      - name: Publish run summary
        run: |
          cat repo-health-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Update Ops issue on failure
        if: steps.evaluate.outputs.status == 'failure' && env.OPS_ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        env:
          OPS_ISSUE_NUMBER: ${{ env.OPS_ISSUE_NUMBER }}
          ISSUE_LINES: ${{ steps.evaluate.outputs.issues }}
        with:
          script: |
            const issueNumber = parseInt(process.env.OPS_ISSUE_NUMBER, 10);
            if (!issueNumber) {
              core.warning('OPS_ISSUE_NUMBER is not a valid integer.');
              return;
            }

            const marker = '<!-- repo-health-nightly -->';
            const runLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const issueLines = process.env.ISSUE_LINES?.trim() || 'No additional details available.';
            const body = `${marker}\n### Repo health nightly alert\n\n${issueLines}\n\n- Workflow run: ${runLink}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body,
              });
            }

      - name: Fail job on issues
        if: steps.evaluate.outputs.status == 'failure'
        run: |
          echo "Repository health checks reported issues." >&2
          exit 1
