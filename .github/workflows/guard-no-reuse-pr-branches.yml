name: Guard — No PR Branch Reuse

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-branch-reuse:
    runs-on: ubuntu-latest
    steps:
      - name: Fail if head branch was used by a merged PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            const headRef = pr.head.ref; // branch name
            const currentPrNumber = pr.number;

            // List all PRs with this head ref (state=all), then check if any other PR is merged
            const { data: prs } = await github.rest.pulls.list({ owner, repo, head: `${owner}:${headRef}`, state: 'all', per_page: 100 });
            for (const p of prs) {
              if (p.number === currentPrNumber) continue;
              // Fetch details to get merged_at reliably
              const { data: details } = await github.rest.pulls.get({ owner, repo, pull_number: p.number });
              if (details.merged_at) {
                core.setFailed(`Branch '${headRef}' already backed merged PR #${details.number}. Create a new branch for this PR.`);
                return;
              }
            }
            core.info(`Branch '${headRef}' has no previously merged PRs — OK.`);