name: Reusable 96 CI Lite

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version to run under
        required: false
        default: "3.11"
        type: string
      marker:
        description: Optional pytest marker expression
        required: false
        default: ""
        type: string
      coverage-min:
        description: Minimum coverage percentage required
        required: false
        default: "70"
        type: string

jobs:
  tests:
    name: ci / python (${{ inputs.python-version }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: ${{ inputs['python-version'] }}
      PYTEST_MARKER: ${{ inputs.marker }}
      COVERAGE_MINIMUM: ${{ inputs['coverage-min'] }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load formatter pins
        shell: bash
        run: |
          set -euo pipefail
          pin_file=".github/workflows/autofix-versions.env"
          if [[ ! -f "${pin_file}" ]]; then
            echo "Missing ${pin_file}; aborting." >&2
            exit 1
          fi
          echo "PIN_FILE=${pin_file}" >> "$GITHUB_ENV"
          # shellcheck disable=SC1090
          source "${pin_file}"
          for var in RUFF_VERSION BLACK_VERSION MYPY_VERSION PYTEST_VERSION PYTEST_COV_VERSION COVERAGE_VERSION; do
            if [[ -z "${!var:-}" ]]; then
              echo "${pin_file} is missing a value for ${var}" >&2
              exit 1
            fi
          done
          grep -E '^[A-Za-z_][A-Za-z0-9_]*=' "${pin_file}" >> "${GITHUB_ENV}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Create virtual environment
        run: |
          python -m venv .venv
          echo "${{ github.workspace }}/.venv/bin" >> "$GITHUB_PATH"
          echo "VIRTUAL_ENV=${{ github.workspace }}/.venv" >> "$GITHUB_ENV"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e '.[dev]' || pip install -e .
          pip install \
            "black==${BLACK_VERSION}" \
            "ruff==${RUFF_VERSION}" \
            "mypy==${MYPY_VERSION}" \
            "pytest==${PYTEST_VERSION}" \
            "pytest-cov==${PYTEST_COV_VERSION}" \
            "coverage==${COVERAGE_VERSION}" \
            jq

      - name: Ruff (lint)
        run: |
          source .venv/bin/activate
          ruff check --output-format github .

      - name: Mypy (type check)
        run: |
          source .venv/bin/activate
          mypy --config-file pyproject.toml src/trend_analysis src/trend_portfolio_app

      - name: Pytest (unit tests with coverage)
        env:
          PYTEST_ADDOPTS: "-ra"
        shell: bash
        run: |
          source .venv/bin/activate
          marker_args=()
          if [[ -n "${PYTEST_MARKER:-}" ]]; then
            marker_args+=("-m" "${PYTEST_MARKER}")
          fi
          pytest --junitxml=pytest-junit.xml \
            --cov=src --cov-report=xml:coverage.xml \
            --cov-report=term-missing --cov-report=json:coverage.json \
            "${marker_args[@]}"

      - name: Analyze coverage trend
        if: always()
        id: coverage_trend
        env:
          BASELINE_PATH: config/coverage-baseline.json
          SUMMARY_PATH: ${{ github.step_summary }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          args=(
            --coverage-xml "coverage.xml"
            --coverage-json "coverage.json"
            --baseline "${BASELINE_PATH}"
            --artifact-path "artifacts/coverage-trend.json"
            --summary-path "artifacts/coverage-summary.md"
          )
          if [[ -n "${SUMMARY_PATH:-}" ]]; then
            args+=(--job-summary "${SUMMARY_PATH}")
          fi
          if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
            args+=(--github-output "${GITHUB_OUTPUT}")
          fi
          if [[ -n "${COVERAGE_MINIMUM:-}" ]]; then
            args+=(--minimum "${COVERAGE_MINIMUM}")
          fi
          python tools/coverage_trend.py "${args[@]}"

      - name: Capture artifacts
        if: always()
        run: |
          mkdir -p artifacts
          cp -f pytest-junit.xml artifacts/pytest-junit.xml || true
          cp -f coverage.xml artifacts/coverage.xml || true
          cp -f coverage.json artifacts/coverage.json || true

      - name: Upload coverage summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary-${{ inputs['python-version'] }}
          path: artifacts
          retention-days: 14

      - name: Post soft coverage alert
        if: >
          always() &&
          github.event_name == 'pull_request' &&
          steps.coverage_trend.outputs.status == 'warn' &&
          steps.coverage_trend.outputs.comment != ''
        uses: actions/github-script@v7
        env:
          COVERAGE_COMMENT: ${{ steps.coverage_trend.outputs.comment }}
        with:
          script: |
            const body = (process.env.COVERAGE_COMMENT || '').trim();
            if (!body) {
              core.info('No coverage alert comment to post.');
              return;
            }
            const marker = 'ðŸ”¶ Coverage drop alert';
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner,
                repo,
                issue_number,
                per_page: 100,
              },
            );
            const existing = comments.find(
              (comment) =>
                comment.body &&
                comment.body.startsWith(marker) &&
                comment.user &&
                comment.user.type === 'Bot',
            );
            if (existing) {
              if (existing.body.trim() === body) {
                core.info(`Coverage alert comment ${existing.id} already up to date.`);
              } else {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
                core.info(`Updated coverage alert comment ${existing.id}.`);
              }
            } else {
              const response = await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
              core.info(`Created coverage alert comment ${response.data.id}.`);
            }

      - name: Remove resolved coverage alert
        if: >
          always() &&
          github.event_name == 'pull_request' &&
          (steps.coverage_trend.outputs.status != 'warn' || steps.coverage_trend.outputs.comment == '')
        uses: actions/github-script@v7
        with:
          script: |
            const marker = 'ðŸ”¶ Coverage drop alert';
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner,
                repo,
                issue_number,
                per_page: 100,
              },
            );
            const existing = comments.find(
              (comment) =>
                comment.body &&
                comment.body.startsWith(marker) &&
                comment.user &&
                comment.user.type === 'Bot',
            );
            if (!existing) {
              core.info('No coverage alert comment to remove.');
              return;
            }
            await github.rest.issues.deleteComment({
              owner,
              repo,
              comment_id: existing.id,
            });
            core.info(`Removed coverage alert comment ${existing.id}.`);

      - name: Enforce coverage minimum
        run: |
          python - <<'PY'
          import os
          import sys
          import xml.etree.ElementTree as ET

          minimum = float(os.environ.get('COVERAGE_MINIMUM', '0'))
          try:
              root = ET.parse('coverage.xml').getroot()
          except FileNotFoundError:
              print('coverage.xml not found; cannot enforce coverage minimum', file=sys.stderr)
              sys.exit(1)
          except ET.ParseError as exc:
              print(f'Failed to parse coverage.xml: {exc}', file=sys.stderr)
              sys.exit(1)
          rate = root.get('line-rate')
          if rate is None:
              print('Missing line-rate attribute in coverage.xml', file=sys.stderr)
              sys.exit(1)
          current = float(rate) * 100.0
          if current + 1e-9 < minimum:
              print(f'Coverage {current:.2f}% is below required minimum {minimum:.2f}%', file=sys.stderr)
              sys.exit(1)
          print(f'Coverage {current:.2f}% meets minimum {minimum:.2f}%')
          PY
