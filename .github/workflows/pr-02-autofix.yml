---
name: PR 02 Autofix

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - labeled

permissions:
  contents: write
  pull-requests: write

env:
  AUTOFIX_OPT_IN_LABEL: ${{ vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix' }}
  AUTOFIX_CLEAN_LABEL: ${{ vars.AUTOFIX_CLEAN_LABEL != '' && vars.AUTOFIX_CLEAN_LABEL || 'autofix:tests' }}

concurrency:
  group: pr-02-autofix-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  label_gate:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.evaluate.outputs.enabled }}
      label: ${{ steps.evaluate.outputs.label }}
      clean_label: ${{ steps.evaluate.outputs.clean_label }}
      fire: ${{ steps.fire_guard.outputs.fire }}
    steps:
      - name: Evaluate label gate
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            const label = process.env.AUTOFIX_OPT_IN_LABEL || 'autofix';
            const cleanLabel = process.env.AUTOFIX_CLEAN_LABEL || 'autofix:clean';
            const payload = context.payload || {};
            const pr = payload.pull_request;
            const labels = pr?.labels || [];
            const hasLabel = labels.some(labelObj => (labelObj?.name || '') === label);
            const triggeredByLabel = payload.action === 'labeled' && (payload.label?.name || '') === label;
            const enabled = Boolean(hasLabel || triggeredByLabel);
            core.setOutput('enabled', String(enabled));
            core.setOutput('label', label);
            core.setOutput('clean_label', cleanLabel);
            if (!enabled) {
              core.info(`Autofix label "${label}" not present; skipping run.`);
            }
        env:
          AUTOFIX_OPT_IN_LABEL: ${{ env.AUTOFIX_OPT_IN_LABEL }}
          AUTOFIX_CLEAN_LABEL: ${{ env.AUTOFIX_CLEAN_LABEL }}
      - name: Compute apply guard
        id: fire_guard
        run: echo "fire=${{ github.event.pull_request != null && steps.evaluate.outputs.enabled == 'true' }}" >> "$GITHUB_OUTPUT"
      - name: Report gate result
        if: always()
        run: echo "autofix_enabled=${{ steps.evaluate.outputs.enabled }}"
      - name: Report event context
        if: always()
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "pr_present=${{ github.event.pull_request != null }}"

  apply:
    needs: label_gate
    if: ${{ github.event.pull_request && ( contains(github.event.pull_request.labels.*.name, vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix') || ( github.event.action == 'labeled' && github.event.label.name == (vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix') ) ) && needs.label_gate.outputs.fire == 'true' }}
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/reusable-18-autofix.yml
    with:
      opt_in_label: ${{ needs.label_gate.outputs.label }}
      clean_label: ${{ needs.label_gate.outputs.clean_label }}
      pr_number: ${{ github.event.pull_request.number }}
      pr_head_ref: ${{ github.event.pull_request.head.ref }}
      pr_title: ${{ github.event.pull_request.title }}
      pr_is_draft: ${{ github.event.pull_request.draft }}
      pr_labels_json: ${{ toJSON(github.event.pull_request.labels.*.name) }}
      same_repo: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
      caller_actor: ${{ github.actor }}

  debug_gate:
    needs: label_gate
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Show gate outputs
        run: |
          echo "enabled=${{ needs.label_gate.outputs.enabled }}"
          echo "label=${{ needs.label_gate.outputs.label }}"
          echo "enabled_bool=${{ fromJSON(needs.label_gate.outputs.enabled) }}"

  condition_probe:
    needs: label_gate
    if: ${{ github.event.pull_request != null && fromJSON(needs.label_gate.outputs.enabled) }}
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Confirm condition
        run: echo "probe_condition=true"
      - name: Evaluate reusable guard
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_IS_DRAFT: ${{ github.event.pull_request.draft }}
          PR_LABELS_JSON: ${{ toJSON(github.event.pull_request.labels.*.name) }}
          REQUIRED_LABEL: ${{ needs.label_gate.outputs.label }}
        run: |
          set -euo pipefail
          has_required_label=$(python -c 'import json, os; labels = set(json.loads(os.environ.get("PR_LABELS_JSON") or "[]")); required = os.environ.get("REQUIRED_LABEL") or ""; print("true" if required and required in labels else "false")')

          guard=true
          if [ "${EVENT_NAME}" != "pull_request" ]; then
            guard=false
          elif [ "${ACTOR}" = "github-actions" ] || [ "${ACTOR}" = "github-actions[bot]" ]; then
            guard=false
          elif printf '%s' "${PR_TITLE}" | grep -q '^chore(autofix):'; then
            guard=false
          elif [ "${PR_IS_DRAFT}" = "true" ] && [ "${has_required_label}" != "true" ]; then
            guard=false
          fi

          echo "autofix_guard=${guard}"
