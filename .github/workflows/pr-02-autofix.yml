---
name: PR 02 Autofix

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - labeled

permissions:
  contents: read
  pull-requests: read

env:
  AUTOFIX_OPT_IN_LABEL: ${{ vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix' }}
  AUTOFIX_CLEAN_LABEL: ${{ vars.AUTOFIX_CLEAN_LABEL != '' && vars.AUTOFIX_CLEAN_LABEL || 'autofix:clean' }}

concurrency:
  group: pr-02-autofix-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  label_gate:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.evaluate.outputs.enabled }}
      label: ${{ steps.evaluate.outputs.label }}
      clean_label: ${{ steps.evaluate.outputs.clean_label }}
    steps:
      - name: Evaluate label gate
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            const label = process.env.AUTOFIX_OPT_IN_LABEL || 'autofix';
            const cleanLabel = process.env.AUTOFIX_CLEAN_LABEL || 'autofix:clean';
            const payload = context.payload || {};
            const pr = payload.pull_request;
            const labels = pr?.labels || [];
            const hasLabel = labels.some(labelObj => (labelObj?.name || '') === label);
            const triggeredByLabel = payload.action === 'labeled' && (payload.label?.name || '') === label;
            const enabled = Boolean(hasLabel || triggeredByLabel);
            core.setOutput('enabled', String(enabled));
            core.setOutput('label', label);
            core.setOutput('clean_label', cleanLabel);
            if (!enabled) {
              core.info(`Autofix label "${label}" not present; skipping run.`);
            }
        env:
          AUTOFIX_OPT_IN_LABEL: ${{ env.AUTOFIX_OPT_IN_LABEL }}
          AUTOFIX_CLEAN_LABEL: ${{ env.AUTOFIX_CLEAN_LABEL }}

  apply:
    needs: label_gate
    if: >
      github.event.pull_request != null && (
        contains(
          github.event.pull_request.labels.*.name,
          vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix'
        ) || (
          github.event.action == 'labeled' &&
          (github.event.label.name || '') == (vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix')
        )
      ) && needs.label_gate.outputs.enabled == 'true'
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/reusable-18-autofix.yml
    secrets: inherit
    with:
      opt_in_label: ${{ needs.label_gate.outputs.label }}
      clean_label: ${{ needs.label_gate.outputs.clean_label }}
