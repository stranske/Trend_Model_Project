---
name: PR 02 Autofix

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - labeled

permissions:
  contents: write
  pull-requests: write

env:
  AUTOFIX_OPT_IN_LABEL: ${{ vars.AUTOFIX_OPT_IN_LABEL != '' && vars.AUTOFIX_OPT_IN_LABEL || 'autofix' }}

concurrency:
  group: pr-02-autofix-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  label_gate:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.evaluate.outputs.enabled }}
      label: ${{ steps.evaluate.outputs.label }}
    steps:
      - name: Evaluate label gate
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            const label = process.env.AUTOFIX_OPT_IN_LABEL || 'autofix';
            const payload = context.payload || {};
            const pr = payload.pull_request;
            const labels = pr?.labels || [];
            const hasLabel = labels.some(labelObj => (labelObj?.name || '') === label);
            const triggeredByLabel = payload.action === 'labeled' && (payload.label?.name || '') === label;
            const enabled = Boolean(hasLabel || triggeredByLabel);
            core.setOutput('enabled', String(enabled));
            core.setOutput('label', label);
            if (!enabled) {
              core.info(`Autofix label "${label}" not present; skipping run.`);
            }
        env:
          AUTOFIX_OPT_IN_LABEL: ${{ env.AUTOFIX_OPT_IN_LABEL }}
      - name: Report gate result
        if: always()
        run: echo "autofix_enabled=${{ steps.evaluate.outputs.enabled }}"
      - name: Report event context
        if: always()
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "pr_present=${{ github.event.pull_request != null }}"

  apply:
    needs: label_gate
    if: ${{ github.event.pull_request != null && fromJSON(needs.label_gate.outputs.enabled) }}
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/reusable-18-autofix.yml
    secrets: inherit
    with:
      opt_in_label: ${{ needs.label_gate.outputs.label }}

  debug_gate:
    needs: label_gate
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Show gate outputs
        run: |
          echo "enabled=${{ needs.label_gate.outputs.enabled }}"
          echo "label=${{ needs.label_gate.outputs.label }}"
          echo "enabled_bool=${{ fromJSON(needs.label_gate.outputs.enabled) }}"

  condition_probe:
    needs: label_gate
    if: ${{ github.event.pull_request != null && fromJSON(needs.label_gate.outputs.enabled) }}
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Confirm condition
        run: echo "probe_condition=true"
