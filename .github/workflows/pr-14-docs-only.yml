name: PR 14 Docs Only

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    paths:
      - '**/*.md'
      - 'docs/**'
      - 'assets/**'

jobs:
  detect-doc-changes:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    outputs:
      doc_only: ${{ steps.detect.outputs.doc_only }}
    steps:
      - name: Detect doc-only changes
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            // Classify files without checkout to keep the workflow lightweight.
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const classify = filename => {
              const normalised = filename.toLowerCase();
              return (
                normalised.endsWith('.md') ||
                normalised.startsWith('docs/') ||
                normalised.startsWith('assets/')
              );
            };

            const nonDocFiles = files
              .map(file => file.filename)
              .filter(filename => !classify(filename));

            const docOnly = nonDocFiles.length === 0;

            core.setOutput('doc_only', docOnly ? 'true' : 'false');
            if (!docOnly) {
              core.info(`Non documentation files changed: ${nonDocFiles.join(', ')}`);
            }

  docs-only:
    name: docs-only
    needs: detect-doc-changes
    if: ${{ needs.detect-doc-changes.outputs.doc_only == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post doc-only notice
        uses: actions/github-script@v7
        with:
          script: |
            // Post a single friendly notice explaining why heavier gates were skipped.
            const body = 'Docâ€‘only change detected; gate skipped by path filters.';

            const existingComments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const alreadyCommented = existingComments.some(comment => comment.body === body);
            if (alreadyCommented) {
              core.info('Doc-only notice already posted.');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });
