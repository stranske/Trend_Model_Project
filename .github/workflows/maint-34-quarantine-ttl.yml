name: maint-34-quarantine-ttl

on:
  schedule:
    - cron: '30 4 * * *'
  workflow_dispatch:
  pull_request:
    paths:
      - 'tests/quarantine.yml'
      - '.github/workflows/maint-34-quarantine-ttl.yml'
      - 'tools/validate_quarantine_ttl.py'
  push:
    branches: [phase-2-dev]
    paths:
      - 'tests/quarantine.yml'
      - '.github/workflows/maint-34-quarantine-ttl.yml'
      - 'tools/validate_quarantine_ttl.py'

permissions: read-all

jobs:
  ttl:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML dependency
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Validate quarantine TTLs
        id: validate
        continue-on-error: true
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          from tools.validate_quarantine_ttl import (
              load_records,
              evaluate_records,
              build_summary,
              emit_json,
          )

          records, invalid_entries = load_records(pathlib.Path("tests/quarantine.yml"))
          report = evaluate_records(records, additional_invalid=invalid_entries)
          summary = build_summary(report)

          summary_path = pathlib.Path("quarantine-ttl-summary.md")
          summary_path.write_text(summary + "\n", encoding="utf-8")
          pathlib.Path("quarantine-ttl-report.json").write_text(emit_json(report) + "\n", encoding="utf-8")

          step_summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if step_summary:
              with open(step_summary, "a", encoding="utf-8") as handle:
                  handle.write(summary + "\n")

          outcome = "success" if report.ok else "failure"
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              print(f"status={outcome}", file=fh)
              print("summary<<EOF", file=fh)
              print(summary, file=fh)
              print("EOF", file=fh)
          if not report.ok:
              raise SystemExit(1)
          PY

      - name: Publish summary
        if: always()
        run: |
          if [ -f quarantine-ttl-summary.md ]; then
            cat quarantine-ttl-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
