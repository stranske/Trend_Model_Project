name: Selftest 82 PR Comment

on:
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'Pull request number that should receive the self-test summary.'
        required: true
      python-versions:
        description: >-
          JSON array of Python versions passed to `selftest-81-reusable-ci.yml` when generating
          the verification matrix.
        required: false
        default: '["3.11"]'
      comment_title:
        description: 'Heading rendered at the top of the posted PR comment.'
        required: false
        default: 'Selftest 82 PR Comment'

jobs:
  exercise-reusable-ci:
    name: Exercise Reusable CI Matrix
    uses: ./.github/workflows/selftest-81-reusable-ci.yml
    with:
      python-versions: ${{ inputs.python-versions }}
    secrets: inherit

  annotate-pr:
    name: Annotate Pull Request
    needs: exercise-reusable-ci
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    steps:
      - name: Download self-test report
        if: ${{ needs.exercise-reusable-ci.outputs.run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.exercise-reusable-ci.outputs.run_id }}
          name: selftest-report
          path: .
        continue-on-error: true
      - name: Post comment with summary table
        uses: actions/github-script@v7
        env:
          MARKER: '<!-- selftest-82-pr-comment -->'
          TABLE: ${{ needs.exercise-reusable-ci.outputs.verification_table }}
          FAILURES: ${{ needs.exercise-reusable-ci.outputs.failures }}
          RESULT: ${{ needs.exercise-reusable-ci.result }}
          PR_NUMBER: ${{ inputs.pull_request_number }}
          COMMENT_TITLE: ${{ inputs.comment_title }}
        with:
          script: |
            const marker = process.env.MARKER || '<!-- selftest-82-pr-comment -->';
            const prRaw = (process.env.PR_NUMBER || '').trim();
            const prNumber = Number.parseInt(prRaw, 10);
            if (!Number.isInteger(prNumber)) {
              core.setFailed(`Invalid pull_request_number input: ${prRaw}`);
              return;
            }

            const title = (process.env.COMMENT_TITLE || 'Selftest 82 PR Comment').trim() || 'Selftest 82 PR Comment';
            const table = process.env.TABLE && process.env.TABLE.trim() ? process.env.TABLE : '*No verification table available.*';
            const failures = process.env.FAILURES || '0';
            const runResult = process.env.RESULT || 'unknown';

            const statusLine = failures === '0'
              ? '✅ **Reusable CI scenarios succeeded.**'
              : `❌ **Reusable CI scenarios reported ${failures} mismatch(es).**`;

            const runBadge = runResult === 'success'
              ? '✅'
              : runResult === 'failure'
                ? '❌'
                : 'ℹ️';

            const lines = [
              marker,
              `### ${title}`,
              `${runBadge} Workflow status: **${runResult}**`,
              statusLine,
              '',
              table,
              '',
              '_Re-run Selftest 82 to refresh this summary._',
              `_Workflow run: ${context.runId}_`,
            ];
            const body = lines.join('\n');

            const { owner, repo } = context.repo;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 100 });
            const existing = comments.data.find((comment) => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
              core.info(`Updated existing Selftest 82 comment (${existing.id}).`);
            } else {
              const created = await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
              core.info(`Created Selftest 82 comment (${created.data.id}).`);
            }
