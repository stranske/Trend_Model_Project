name: Assign to agents (wrapper)

on:
  issues:
    types: [labeled, unlabeled]
  pull_request_target:
    types: [labeled]
  workflow_dispatch:
    inputs:
      mode:
        description: "assign | clear | watch | sweep"
        required: false
        default: ""
      issue:
        description: "Issue number"
        required: false
        default: ""
      agent:
        description: "Agent key"
        required: false
        default: ""
      timeout_minutes:
        description: "Timeout override for watchdog"
        required: false
        default: ""
      started_at:
        description: "Override watchdog start timestamp"
        required: false
        default: ""
      expected_pr:
        description: "Expected PR number for watchdog"
        required: false
        default: ""

permissions:
  actions: write
  contents: read
  issues: read
  pull-requests: read

jobs:
  forward:
    runs-on: ubuntu-latest
    steps:
      - name: Forward event to unified workflow
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const ref = repoInfo.default_branch || 'main';
            const payload = JSON.stringify(context.payload || {});
            const dispatchInputs = context.payload?.inputs || {};
            const manualInputs = {
              mode: (dispatchInputs.mode || '').toString(),
              issue: (dispatchInputs.issue || '').toString(),
              agent: (dispatchInputs.agent || '').toString(),
              timeout_minutes: (dispatchInputs.timeout_minutes || '').toString(),
              started_at: (dispatchInputs.started_at || '').toString(),
              expected_pr: (dispatchInputs.expected_pr || '').toString()
            };
            if (context.eventName !== 'workflow_dispatch') {
              for (const key of Object.keys(manualInputs)) {
                manualInputs[key] = '';
              }
            }
            const inputs = {
              ...manualInputs,
              event_name: context.eventName,
              event_payload: payload
            };
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'agents-41-assign-and-watch.yml',
              ref,
              inputs
            });
            core.info('Forwarded event to agents-41-assign-and-watch.yml.');
