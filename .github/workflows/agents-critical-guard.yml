name: Guard critical agents workflows

on:
  pull_request:

jobs:
  protect-critical-workflows:
    name: Block deletions or renames
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }} --depth=0

      - name: Detect protected workflow changes
        run: |
          set -eo pipefail
          git diff --name-status origin/${{ github.event.pull_request.base.ref }}...HEAD

      - name: Enforce protected workflow policy
        run: |
          set -eo pipefail
          git diff --name-status origin/${{ github.event.pull_request.base.ref }}...HEAD \
            | .github/scripts/ensure_agents_workflows_intact.py
