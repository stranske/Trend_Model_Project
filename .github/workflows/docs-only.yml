name: Docs-only notice

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    paths:
      - '**/*.md'
      - 'docs/**'
      - 'assets/**'

jobs:
  docs-only:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Detect doc-only changes
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const minimatch = require('minimatch');

            const allowedPatterns = ['**/*.md', 'docs/**', 'assets/**'];

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const nonDocFiles = files
              .map(file => file.filename)
              .filter(filename => !allowedPatterns.some(pattern => minimatch(filename, pattern)));

            const docOnly = nonDocFiles.length === 0;

            core.setOutput('doc_only', docOnly ? 'true' : 'false');
            if (!docOnly) {
              core.info(`Non documentation files changed: ${nonDocFiles.join(', ')}`);
            }

      - name: Post doc-only notice
        if: ${{ steps.detect.outputs.doc_only == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const body = 'Doc-only change detected; gate skipped by path filters.';

            const existingComments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const alreadyCommented = existingComments.some(comment => comment.body === body);
            if (alreadyCommented) {
              core.info('Doc-only notice already posted.');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });
