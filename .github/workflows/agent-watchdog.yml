name: Agent watchdog

on:
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number to monitor"
        required: true
      agent:
        description: "Agent key (codex, copilot, etc.)"
        required: false
        default: ""
      expected_pr:
        description: "Expected PR number (optional)"
        required: false
        default: ""
      timeout_minutes:
        description: "Timeout window in minutes"
        required: false
        default: "7"
      started_at:
        description: "ISO timestamp marking the watchdog start"
        required: false
        default: ""

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Watch for cross-referenced PR
        id: monitor
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(core.getInput('issue'));
            if (!issueNumber) {
              core.setFailed('Missing issue number input.');
              return;
            }
            const agent = core.getInput('agent') || '';
            const expectedPrRaw = core.getInput('expected_pr') || '';
            const expectedPr = expectedPrRaw ? Number(expectedPrRaw) : 0;
            const timeoutInput = core.getInput('timeout_minutes') || '7';
            const timeoutMinutes = Number(timeoutInput) > 0 ? Number(timeoutInput) : 7;
            const startInput = core.getInput('started_at') || '';
            let startTime = startInput ? new Date(startInput) : new Date();
            if (Number.isNaN(startTime.getTime())) {
              startTime = new Date();
            }
            const startMs = startTime.getTime();
            const pollMs = 30000;
            const deadline = startMs + timeoutMinutes * 60000;
            const threshold = startMs - 5000;
            const { owner, repo } = context.repo;

            const findCrossReference = async () => {
              const events = await github.paginate(
                github.request,
                {
                  method: 'GET',
                  url: '/repos/{owner}/{repo}/issues/{issue_number}/timeline',
                  owner,
                  repo,
                  issue_number: issueNumber,
                  per_page: 100,
                  headers: { 'accept': 'application/vnd.github.mockingbird-preview+json' }
                }
              );
              for (const event of events) {
                if ((event.event || '') !== 'cross-referenced') {
                  continue;
                }
                const sourceIssue = event.source?.issue;
                if (!sourceIssue || !sourceIssue.pull_request) {
                  continue;
                }
                const prNumber = Number(sourceIssue.number || 0);
                if (!prNumber) {
                  continue;
                }
                if (expectedPr && prNumber !== expectedPr) {
                  continue;
                }
                const createdAt = new Date(event.created_at || '').getTime();
                if (Number.isNaN(createdAt) || createdAt < threshold) {
                  continue;
                }
                return {
                  number: prNumber,
                  url: sourceIssue.html_url || `https://github.com/${owner}/${repo}/pull/${prNumber}`,
                  title: sourceIssue.title || '',
                  createdAt
                };
              }
              return null;
            };

            let found = null;
            while (Date.now() < deadline) {
              found = await findCrossReference();
              if (found) {
                break;
              }
              await new Promise(resolve => setTimeout(resolve, pollMs));
            }

            const elapsedMs = found ? Math.max(0, found.createdAt - startMs) : Math.max(0, Date.now() - startMs);
            const elapsedMinutes = elapsedMs / 60000;
            const friendlyElapsed = elapsedMinutes.toFixed(2);
            const agentLabel = agent ? agent : 'agent';

            core.setOutput('found', found ? 'true' : 'false');
            core.setOutput('pr', found ? String(found.number) : '');
            core.setOutput('elapsed_minutes', friendlyElapsed);

            const runId = process.env.GITHUB_RUN_ID || '';
            const runUrl = runId ? `https://github.com/${owner}/${repo}/actions/runs/${runId}` : '';

            const summary = core.summary.addHeading('Agent Watchdog Result');
            if (found) {
              summary.addTable([
                [{ data: 'Status', header: true }, { data: 'Details', header: true }],
                ['✅ PR detected', `#${found.number} (${found.url}) in ${friendlyElapsed} minutes`],
                ['Workflow run', runUrl ? `[${runId}](${runUrl})` : 'Unavailable']
              ]);
            } else {
              const timeoutDetail = expectedPr
                ? `Expected PR #${expectedPr} but none detected within ${timeoutMinutes} minute window`
                : `No PR detected within ${timeoutMinutes} minute window`;
              summary.addTable([
                [{ data: 'Status', header: true }, { data: 'Details', header: true }],
                ['⚠️ Timeout', timeoutDetail],
                ['Workflow run', runUrl ? `[${runId}](${runUrl})` : 'Unavailable']
              ]);
            }
            await summary.write();

            const commentPrefix = found ? '✅ Agent Watchdog' : '⚠️ Agent Watchdog';
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: issueNumber, per_page: 100, page: 1 });
            const alreadyCommented = (comments || []).some(c => (c.body || '').startsWith(commentPrefix));

            if (found) {
              const body = `${commentPrefix}: Detected PR #${found.number} referencing this issue after ${friendlyElapsed} minute${elapsedMinutes === 1 ? '' : 's'}.\n\nLink: ${found.url}${runUrl ? `\nWatchdog run: ${runUrl}` : ''}`;
              if (!alreadyCommented) {
                await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body });
              }
            } else {
              let detail = `No pull request cross-reference detected for **${agentLabel}** within ${timeoutMinutes} minute${timeoutMinutes === 1 ? '' : 's'}.`;
              if (expectedPr) {
                detail += ` Expected PR #${expectedPr} never appeared.`;
              }
              const body = `${commentPrefix}: ${detail}${runUrl ? `\nWatchdog run: ${runUrl}` : ''}`;
              if (!alreadyCommented) {
                await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body });
              }
            }
