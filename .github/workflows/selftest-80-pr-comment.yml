name: Selftest 80 PR Comment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Why are you running this example?'
        required: false
        default: 'manual test'
      pull_request_number:
        description: 'Pull request number to update with self-test results.'
        required: true
      python-versions:
        description: >-
          JSON array of Python versions forwarded to `selftest-81-reusable-ci.yml`.
          Defaults to the 3.11 matrix exercised by the reusable self-test.
        required: false
        default: '["3.11"]'
      comment_title:
        description: 'Optional heading used for the posted PR comment.'
        required: false
        default: 'Selftest 80 PR Comment'

jobs:
  run-matrix:
    name: Run Self-Test Matrix
    uses: ./.github/workflows/selftest-81-reusable-ci.yml
    with:
      python-versions: ${{ inputs.python-versions }}
    secrets: inherit

  post-comment:
    name: Post Self-Test Comment
    needs: run-matrix
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    steps:
      - name: Download self-test report
        if: ${{ needs.run-matrix.outputs.run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.run-matrix.outputs.run_id }}
          name: selftest-report
          path: .
        continue-on-error: true
      - name: Publish PR comment
        uses: actions/github-script@v7
        env:
          MARKER: '<!-- selftest-80-pr-comment -->'
          TABLE: ${{ needs.run-matrix.outputs.verification_table }}
          FAILURES: ${{ needs.run-matrix.outputs.failures }}
          RESULT: ${{ needs.run-matrix.result }}
          PR_NUMBER: ${{ inputs.pull_request_number }}
          COMMENT_TITLE: ${{ inputs.comment_title }}
        with:
          script: |
            const marker = process.env.MARKER || '<!-- selftest-80-pr-comment -->';
            const prRaw = (process.env.PR_NUMBER || '').trim();
            const prNumber = Number.parseInt(prRaw, 10);
            if (!Number.isInteger(prNumber)) {
              core.setFailed(`Invalid pull_request_number input: ${prRaw}`);
              return;
            }

            const title = (process.env.COMMENT_TITLE || 'Selftest 80 PR Comment').trim() || 'Selftest 80 PR Comment';
            const table = process.env.TABLE && process.env.TABLE.trim() ? process.env.TABLE : '*No verification table available.*';
            const failures = process.env.FAILURES || '0';
            const runResult = process.env.RESULT || 'unknown';

            const statusLine = failures === '0'
              ? '✅ **Self-test passed** – all scenarios produced the expected artifacts.'
              : `❌ **Self-test detected ${failures} scenario mismatch(es).**`;

            const runBadge = runResult === 'success'
              ? '✅'
              : runResult === 'failure'
                ? '❌'
                : 'ℹ️';

            const lines = [
              marker,
              `### ${title}`,
              `${runBadge} Workflow status: **${runResult}**`,
              statusLine,
              '',
              table,
              '',
              `_Workflow run: ${context.runId}_`,
            ];
            const body = lines.join('\n');

            const { owner, repo } = context.repo;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 100 });
            const existing = comments.data.find((comment) => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
              core.info(`Updated existing self-test comment (${existing.id}).`);
            } else {
              const created = await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
              core.info(`Created new self-test comment (${created.data.id}).`);
            }
