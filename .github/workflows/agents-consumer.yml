name: Agents Consumer

on:
  workflow_dispatch:
    inputs:
      enable_readiness:
        description: 'Run readiness probe (true/false)'
        required: false
        default: 'false'
      enable_preflight:
        description: 'Run Codex preflight diagnostics (true/false)'
        required: false
        default: 'false'
      enable_diagnostic:
        description: 'Run bootstrap diagnostic job (true/false)'
        required: false
        default: 'false'
      enable_verify_issue:
        description: 'Verify a specific issue assignment (true/false)'
        required: false
        default: 'false'
      verify_issue_number:
        description: 'Issue number to verify when enable_verify_issue=true'
        required: false
        default: ''
      enable_watchdog:
        description: 'Run watchdog checks (true/false)'
        required: false
        default: 'true'
      enable_keepalive:
        description: 'Run Codex keepalive sweeps (true/false)'
        required: false
        default: 'true'
      enable_bootstrap:
        description: 'Run Codex bootstrap job (true/false)'
        required: false
        default: 'false'
      draft_pr:
        description: 'Open bootstrap PRs as draft (true/false)'
        required: false
        default: 'false'
      options_json:
        description: 'Advanced options payload (JSON) for readiness/custom overrides'
        required: false
        default: '{}'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: agents-consumer-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch reusable agents toolkit
    uses: ./.github/workflows/reusable-70-agents.yml
    env:
      AGENTS_OPTIONS_JSON: ${{ inputs.options_json != '' && inputs.options_json || '{}' }}
    secrets: inherit
    with:
      enable_readiness: ${{ inputs.enable_readiness }}
      readiness_agents: ${{ fromJson(env.AGENTS_OPTIONS_JSON).readiness_agents || 'copilot,codex' }}
      readiness_custom_logins: ${{ fromJson(env.AGENTS_OPTIONS_JSON).readiness_custom_logins || '' }}
      require_all: ${{ fromJson(env.AGENTS_OPTIONS_JSON).require_all || 'false' }}
      enable_preflight: ${{ inputs.enable_preflight }}
      codex_user: ${{ fromJson(env.AGENTS_OPTIONS_JSON).codex_user || '' }}
      codex_command_phrase: ${{ fromJson(env.AGENTS_OPTIONS_JSON).codex_command_phrase || '' }}
      enable_diagnostic: ${{ inputs.enable_diagnostic }}
      diagnostic_attempt_branch: ${{ fromJson(env.AGENTS_OPTIONS_JSON).diagnostic_attempt_branch || 'false' }}
      diagnostic_dry_run: ${{ fromJson(env.AGENTS_OPTIONS_JSON).diagnostic_dry_run || 'true' }}
      enable_verify_issue: ${{ inputs.enable_verify_issue || (fromJson(env.AGENTS_OPTIONS_JSON).enable_verify_issue || '') || (((inputs.verify_issue_number || fromJson(env.AGENTS_OPTIONS_JSON).verify_issue_number || '') != '') && 'true' || 'false') }}
      verify_issue_number: ${{ inputs.verify_issue_number || fromJson(env.AGENTS_OPTIONS_JSON).verify_issue_number || '' }}
      enable_watchdog: ${{ inputs.enable_watchdog }}
      enable_keepalive: ${{ inputs.enable_keepalive }}
      enable_bootstrap: ${{ inputs.enable_bootstrap || fromJson(env.AGENTS_OPTIONS_JSON).enable_bootstrap || 'false' }}
      bootstrap_issues_label: ${{ fromJson(env.AGENTS_OPTIONS_JSON).bootstrap_issues_label || 'agent:codex' }}
      draft_pr: ${{ inputs.draft_pr }}
      options_json: ${{ inputs.options_json || '{}' }}
