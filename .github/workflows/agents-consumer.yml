name: Agents Consumer

on:
  workflow_dispatch:
    inputs:
      enable_readiness:
        description: 'Run readiness probe (true/false)'
        required: false
        default: 'false'
      readiness_agents:
        description: 'Comma-separated agent keys (copilot,codex)'
        required: false
        default: 'copilot,codex'
      readiness_custom_logins:
        description: 'Comma-separated custom logins for readiness probe'
        required: false
        default: ''
      require_all:
        description: 'Fail readiness when requested agent missing (true/false)'
        required: false
        default: 'false'
      enable_preflight:
        description: 'Run Codex preflight diagnostics (true/false)'
        required: false
        default: 'false'
      codex_user:
        description: 'Override Codex connector login'
        required: false
        default: ''
      codex_command_phrase:
        description: 'Command phrase to post for Codex'
        required: false
        default: ''
      enable_diagnostic:
        description: 'Run bootstrap diagnostic job (true/false)'
        required: false
        default: 'false'
      diagnostic_attempt_branch:
        description: 'Attempt branch create in diagnostic (true/false)'
        required: false
        default: 'false'
      diagnostic_dry_run:
        description: 'Execute diagnostic in dry-run mode (true/false)'
        required: false
        default: 'true'
      enable_verify_issue:
        description: 'Verify a specific issue assignment (true/false)'
        required: false
        default: 'false'
      verify_issue_number:
        description: 'Issue number to verify when enable_verify_issue=true'
        required: false
        default: ''
      enable_watchdog:
        description: 'Run watchdog checks (true/false)'
        required: false
        default: 'true'
      enable_keepalive:
        description: 'Run Codex keepalive sweeps (true/false)'
        required: false
        default: 'true'
      enable_bootstrap:
        description: 'Run Codex bootstrap job (true/false)'
        required: false
        default: 'false'
      bootstrap_issues_label:
        description: 'Label that gates Codex bootstrap runs'
        required: false
        default: 'agent:codex'
      draft_pr:
        description: 'Open bootstrap PRs as draft (true/false)'
        required: false
        default: 'false'
      options_json:
        description: 'Advanced options payload forwarded to reusable workflow'
        required: false
        default: '{}'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: agents-consumer-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch reusable agents toolkit
    uses: ./.github/workflows/reusable-70-agents.yml
    secrets: inherit
    with:
      enable_readiness: ${{ inputs.enable_readiness || 'false' }}
      readiness_agents: ${{ inputs.readiness_agents || 'copilot,codex' }}
      readiness_custom_logins: ${{ inputs.readiness_custom_logins || '' }}
      require_all: ${{ inputs.require_all || 'false' }}
      enable_preflight: ${{ inputs.enable_preflight || 'false' }}
      codex_user: ${{ inputs.codex_user || '' }}
      codex_command_phrase: ${{ inputs.codex_command_phrase || '' }}
      enable_diagnostic: ${{ inputs.enable_diagnostic || 'false' }}
      diagnostic_attempt_branch: ${{ inputs.diagnostic_attempt_branch || 'false' }}
      diagnostic_dry_run: ${{ inputs.diagnostic_dry_run || 'true' }}
      enable_verify_issue: ${{ inputs.enable_verify_issue || ((inputs.verify_issue_number || '') != '' && 'true' || 'false') }}
      verify_issue_number: ${{ inputs.verify_issue_number || '' }}
      enable_watchdog: ${{ inputs.enable_watchdog || 'true' }}
      enable_keepalive: ${{ inputs.enable_keepalive || 'true' }}
      enable_bootstrap: ${{ inputs.enable_bootstrap || 'false' }}
      bootstrap_issues_label: ${{ inputs.bootstrap_issues_label || 'agent:codex' }}
      draft_pr: ${{ inputs.draft_pr || 'false' }}
      options_json: ${{ inputs.options_json || '{}' }}
