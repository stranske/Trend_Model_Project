name: CI Matrix Summary

on:
  workflow_run:
    workflows: ["CI", "Check Failure Tracker"]
    types: [completed]

permissions:
  contents: read
  actions: read
  issues: read

jobs:
  aggregate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (for formatting or reference)
        uses: actions/checkout@v4
      - name: Gather artifacts & failure snapshot
        uses: actions/github-script@v7
        id: gather
        with:
          script: |
            const { owner, repo } = context.repo;
            const run = context.payload.workflow_run;
            const runId = run.id;
            // We attempt to find artifacts from the triggering workflow (coverage summaries, snapshots)
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: runId, per_page: 100 });
            function pick(name){ return artifacts.data.artifacts.find(a=>a.name===name); }
            const want = ['coverage-summary','coverage-trend','ci-failures-snapshot','coverage-trend-history'];
            const meta = {};
            for (const n of want) meta[n] = !!pick(n);
            // Duration & conclusion
            const started = new Date(run.run_started_at || run.created_at);
            const updated = new Date(run.updated_at || run.completed_at || Date.now());
            const durationSec = Math.max(0, Math.round((updated - started)/1000));
            core.setOutput('run_duration_sec', String(durationSec));
            core.setOutput('run_conclusion', run.conclusion || run.status || 'unknown');
            core.setOutput('artifact_meta', JSON.stringify(meta));
            core.setOutput('trigger_run_url', run.html_url);
      - name: Download available artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: '*'
          merge-multiple: true
      - name: Initialize summary
        run: |
          set -euo pipefail
          {
            echo "# CI Matrix Summary"
            echo "Trigger Run: ${{ steps.gather.outputs.trigger_run_url }}"
            echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo
          } > ci-matrix-summary.md
      - name: Derive quick stats
        id: stats
        run: |
          set -euo pipefail
          python <<'PY'
          import json
          from pathlib import Path

          def read_json(path: str):
              file = Path(path)
              if not file.is_file():
                  return None
              try:
                  with file.open(encoding="utf-8") as handle:
                      return json.load(handle)
              except Exception:
                  return None

          failures = read_json("ci_failures_snapshot.json") or {}
          open_failures = len(failures.get("issues", []))

          trend = read_json("coverage-trend.json") or {}
          history = read_json("coverage-trend-history.json")
          if not isinstance(history, list):
              history = []

          avg_latest = trend.get("avg_coverage")
          worst_latest = trend.get("worst_job_coverage")

          avg_prev = None
          worst_prev = None
          if len(history) >= 2:
              prev_entry = history[-2]
              if isinstance(prev_entry, dict):
                  avg_prev = prev_entry.get("avg_coverage")
                  worst_prev = prev_entry.get("worst_job_coverage")

          def delta(latest, prev):
              try:
                  if latest is None or prev is None:
                      return None
                  return round(float(latest) - float(prev), 2)
              except Exception:
                  return None

          derived = {
              "open_failure_issues": open_failures,
              "coverage_avg_latest": avg_latest,
              "coverage_avg_prev": avg_prev,
              "coverage_avg_delta": delta(avg_latest, avg_prev),
              "coverage_worst_latest": worst_latest,
              "coverage_worst_prev": worst_prev,
              "coverage_worst_delta": delta(worst_latest, worst_prev),
              "coverage_history_len": len(history),
          }

          with open("matrix-derived.json", "w", encoding="utf-8") as handle:
              json.dump(derived, handle, indent=2, sort_keys=True)

          print(json.dumps(derived, indent=2, sort_keys=True))
          PY
          DERIVED=$(jq -c '.' matrix-derived.json 2>/dev/null || echo '{}')
          printf 'derived=%s\n' "$DERIVED" >> "$GITHUB_OUTPUT"
      - name: Append quick stats
        if: ${{ always() }}
        run: |
          if [ -f matrix-derived.json ]; then
            echo "## Quick Stats" >> ci-matrix-summary.md
            jq -r '"- Open failure issues: \(.open_failure_issues)"' matrix-derived.json >> ci-matrix-summary.md 2>/dev/null || true
            if jq -e '.coverage_avg_latest != null' matrix-derived.json >/dev/null 2>&1; then
              jq -r '"- Coverage avg (latest): \(.coverage_avg_latest)%"' matrix-derived.json >> ci-matrix-summary.md || true
            fi
            if jq -e '(.coverage_avg_prev != null) and (.coverage_avg_delta != null)' matrix-derived.json >/dev/null 2>&1; then
              jq -r '"- Coverage delta vs prev: \(.coverage_avg_delta|if .>=0 then "+" else "" end)\(.) pp"' matrix-derived.json >> ci-matrix-summary.md || true
            fi
            if jq -e '.coverage_worst_latest != null' matrix-derived.json >/dev/null 2>&1; then
              jq -r '"- Worst job coverage (latest): \(.coverage_worst_latest)%"' matrix-derived.json >> ci-matrix-summary.md || true
            fi
            if jq -e '(.coverage_worst_prev != null) and (.coverage_worst_delta != null)' matrix-derived.json >/dev/null 2>&1; then
              jq -r '"- Worst job coverage delta vs prev: \(.coverage_worst_delta|if .>=0 then "+" else "" end)\(.) pp"' matrix-derived.json >> ci-matrix-summary.md || true
            fi
            jq -r '"- Coverage history entries: \(.coverage_history_len)"' matrix-derived.json >> ci-matrix-summary.md 2>/dev/null || true
            echo "- Run duration (trigger workflow): ${{ steps.gather.outputs.run_duration_sec }}s (conclusion: ${{ steps.gather.outputs.run_conclusion }})" >> ci-matrix-summary.md
            if [ -f ci_failures_snapshot.json ]; then
              ISSUE_COUNT=$(jq '.issues|length' ci_failures_snapshot.json 2>/dev/null || echo 0)
              if [ "$ISSUE_COUNT" -gt 0 ]; then
                jq -r '"- Open failure issue numbers: " + (.issues | map("#"+(.number|tostring)) | join(", "))' ci_failures_snapshot.json >> ci-matrix-summary.md || true
              fi
            fi
            echo >> ci-matrix-summary.md
          fi
      - name: Append coverage summary
        if: ${{ always() }}
        run: |
          if [ -f coverage_summary.md ]; then
            echo "## Coverage Summary" >> ci-matrix-summary.md
            sed -n '1,60p' coverage_summary.md >> ci-matrix-summary.md || true
            echo >> ci-matrix-summary.md
          fi
      - name: Append failure signatures
        if: ${{ always() }}
        run: |
          if [ -f ci_failures_snapshot.json ]; then
            echo "## Open Failure Signatures" >> ci-matrix-summary.md
            python -c "import json;d=json.load(open('ci_failures_snapshot.json'));print('| Issue | Occurrences | Last Seen | URL |');print('|---|---:|---|---|');[print(f\"| #{it['number']} | {it.get('occurrences') or ''} | {it.get('last_seen') or ''} | [link]({it['url']}) |\") for it in d.get('issues',[])]" >> ci-matrix-summary.md || true
            echo >> ci-matrix-summary.md
          fi
      - name: Append raw coverage artifact note
        if: ${{ always() }}
        run: |
          if ls coverage-*.json >/dev/null 2>&1; then
            echo "## Raw Coverage Artifacts Present" >> ci-matrix-summary.md
            echo >> ci-matrix-summary.md
          fi
      - name: Append coverage trend
        if: ${{ always() }}
        run: |
          if [ -f coverage-trend.json ]; then
            echo "## Coverage Trend Record" >> ci-matrix-summary.md
            python -c "import json,sys;rec=json.load(open('coverage-trend.json'));[print(f'- {k}: {rec.get(k)}') for k in ['run_id','avg_coverage','worst_job_coverage','timestamp_utc']]" >> ci-matrix-summary.md || true
            echo >> ci-matrix-summary.md
          fi
      - name: Append artifact presence meta
        run: |
          echo "## Artifact Presence" >> ci-matrix-summary.md
          echo '${{ steps.gather.outputs.artifact_meta }}' >> ci-matrix-summary.md
      - name: Publish summary to job summary
        run: cat ci-matrix-summary.md >> "$GITHUB_STEP_SUMMARY" || true
      - name: Upload matrix summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-matrix-summary
          path: ci-matrix-summary.md
      - name: Build machine-readable JSON summary
        if: ${{ always() }}
        run: |
          export RUN_DUR='${{ steps.gather.outputs.run_duration_sec }}'
          export RUN_CONC='${{ steps.gather.outputs.run_conclusion }}'
          export ART_META='${{ steps.gather.outputs.artifact_meta }}'
          python <<'PY'
          import json, os
          try:
              derived = json.load(open('matrix-derived.json'))
          except Exception:
              derived = {}
          try:
              artifacts = json.loads(os.environ.get('ART_META','{}'))
          except Exception:
              artifacts = {}
          out = {
              "run_duration_sec": int(os.environ.get('RUN_DUR') or 0),
              "run_conclusion": os.environ.get('RUN_CONC') or 'unknown',
              "derived": derived,
              "artifacts": artifacts,
          }
          with open('ci-matrix-summary.json','w') as w:
              json.dump(out, w, indent=2, sort_keys=True)
          print(json.dumps(out, indent=2, sort_keys=True))
          PY
          cat ci-matrix-summary.json || true
      - name: Upload JSON summary artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-matrix-summary-json
          path: ci-matrix-summary.json