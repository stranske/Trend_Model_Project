# See docs/ci/AGENTS_POLICY.md for guardrails and override process.
# This is a thin wrapper that calls the reusable agents issue intake workflow
# so Codex keeps the existing label-triggered behaviour.
name: Agents 63 Codex Issue Bridge

on:
  issues:
    types: [opened, labeled, reopened]
  workflow_dispatch:
    inputs:
      test_issue:
        description: "Manually test with a specific issue number (optional)"
        required: false
        default: ""
      post_codex_comment:
        description: "Auto-post '@codex start' as the actor (true/false)"
        required: false
        default: "true"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: codex-issue-${{ github.event.issue.number || github.event.inputs.test_issue || github.run_id }}
  cancel-in-progress: true

jobs:
  bridge:
    # Run on any label event once agent:codex is present so concurrency cancellations
    # from follow-up labels (e.g. agents:keepalive) still execute the bridge.
    if: >
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issues' &&
        (
          (
            github.event.action == 'labeled' &&
            (
              contains(github.event.label.name, 'agent:codex') ||
              contains(github.event.label.name, 'agents:codex') ||
              contains(join(github.event.issue.labels.*.name, ' '), 'agent:codex') ||
              contains(join(github.event.issue.labels.*.name, ' '), 'agents:codex')
            )
          ) ||
          (
            github.event.action != 'labeled' &&
            (
              contains(join(github.event.issue.labels.*.name, ' '), 'agent:codex') ||
              contains(join(github.event.issue.labels.*.name, ' '), 'agents:codex')
            )
          )
        )
      )
    uses: ./.github/workflows/agents-63-issue-intake.yml
    with:
      intake_mode: codex_bridge
      issue_number: ${{ github.event.issue.number || github.event.inputs.test_issue || '' }}
      post_codex_comment: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.post_codex_comment || 'true') || 'true' }}
    secrets:
      service_bot_pat: ${{ secrets.SERVICE_BOT_PAT }}
      owner_pr_pat: ${{ secrets.OWNER_PR_PAT }}
