# See docs/ci/AGENTS_POLICY.md for guardrails and override process.
# This is a thin wrapper that calls the reusable agents issue bridge workflow
# with agent=codex to maintain existing Codex behavior.
name: Agents 63 Codex Issue Bridge

on:
  issues:
    types: [opened, labeled, reopened]
  workflow_dispatch:
    inputs:
      test_issue:
        description: "Manually test with a specific issue number (optional)"
        required: false
        default: ""
      post_codex_comment:
        description: "Auto-post '@codex start' as the actor (true/false)"
        required: false
        default: "true"
      pr_mode:
        description: "create | invite (invite = human opens the PR)"
        required: false
        default: "create"
      codex_pr_draft:
        description: "Force created PR to be draft (true/false)"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: codex-issue-${{ github.event.issue.number || inputs.test_issue || github.run_id }}
  cancel-in-progress: true

jobs:
  bridge:
    # Run on any label event once agent:codex is present so concurrency cancellations
    # from follow-up labels (e.g. agents:keepalive) still execute the bridge.
    if: >
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issues' &&
        (
          (
            github.event.action == 'labeled' &&
            (
              contains(github.event.label.name, 'agent:codex') ||
              contains(github.event.label.name, 'agents:codex') ||
              contains(join(github.event.issue.labels.*.name, ' '), 'agent:codex') ||
              contains(join(github.event.issue.labels.*.name, ' '), 'agents:codex')
            )
          ) ||
          (
            github.event.action != 'labeled' &&
            (
              contains(join(github.event.issue.labels.*.name, ' '), 'agent:codex') ||
              contains(join(github.event.issue.labels.*.name, ' '), 'agents:codex')
            )
          )
        )
      )
    uses: ./.github/workflows/reusable-agents-issue-bridge.yml
    with:
      agent: "codex"
      issue_number: ${{ github.event.issue.number || inputs.test_issue || '' }}
      mode: ${{ inputs.pr_mode || 'create' }}
      post_agent_comment: ${{ inputs.post_codex_comment || 'true' }}
      agent_pr_draft: ${{ inputs.codex_pr_draft || 'false' }}
    secrets:
      service_bot_pat: ${{ secrets.SERVICE_BOT_PAT }}
      owner_pr_pat: ${{ secrets.OWNER_PR_PAT }}
