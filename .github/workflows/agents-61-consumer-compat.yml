name: Agents 61 Consumer Compat

on:
  workflow_dispatch:
    inputs:
      enable_readiness:
        description: 'Run readiness probe (true/false)'
        required: false
        default: 'false'
      enable_preflight:
        description: 'Run Codex preflight diagnostics (true/false)'
        required: false
        default: 'false'
      enable_diagnostic:
        description: 'Run bootstrap diagnostic job (true/false)'
        required: false
        default: 'false'
      enable_verify_issue:
        description: 'Verify a specific issue assignment (true/false)'
        required: false
        default: 'false'
      verify_issue_number:
        description: 'Issue number to verify when enable_verify_issue=true'
        required: false
        default: ''
      enable_watchdog:
        description: 'Run watchdog checks (true/false)'
        required: false
        default: 'true'
      enable_keepalive:
        description: 'Run Codex keepalive sweeps (true/false)'
        required: false
        default: 'true'
      enable_bootstrap:
        description: 'Run Codex bootstrap job (true/false)'
        required: false
        default: 'false'
      draft_pr:
        description: 'Open bootstrap PRs as draft (true/false)'
        required: false
        default: 'false'
      options_json:
        description: 'Advanced options payload (JSON) for readiness/custom overrides'
        required: false
        default: '{}'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: agents-61-consumer-compat-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch reusable agents toolkit
    uses: ./.github/workflows/reusable-16-agents.yml
    secrets: inherit
    with:
      enable_readiness: ${{ inputs.enable_readiness }}
      readiness_agents: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).readiness_agents) || 'copilot,codex' }}
      readiness_custom_logins: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).readiness_custom_logins) || '' }}
      require_all: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).require_all) || 'false' }}
      enable_preflight: ${{ inputs.enable_preflight }}
      codex_user: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).codex_user) || '' }}
      codex_command_phrase: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).codex_command_phrase) || '' }}
      enable_diagnostic: ${{ inputs.enable_diagnostic }}
      diagnostic_attempt_branch: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).diagnostic_attempt_branch) || 'false' }}
      diagnostic_dry_run: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).diagnostic_dry_run) || 'true' }}
      enable_verify_issue: ${{ inputs.enable_verify_issue || ((inputs.options_json != '' && fromJson(inputs.options_json).enable_verify_issue) || '') || ((((inputs.verify_issue_number || (inputs.options_json != '' && fromJson(inputs.options_json).verify_issue_number) || '') != '')) && 'true' || 'false') }}
      verify_issue_number: ${{ inputs.verify_issue_number || ((inputs.options_json != '' && fromJson(inputs.options_json).verify_issue_number) || '') }}
      enable_watchdog: ${{ inputs.enable_watchdog }}
      enable_keepalive: ${{ inputs.enable_keepalive }}
      enable_bootstrap: ${{ inputs.enable_bootstrap || ((inputs.options_json != '' && fromJson(inputs.options_json).enable_bootstrap) || 'false') }}
      bootstrap_issues_label: ${{ (inputs.options_json != '' && fromJson(inputs.options_json).bootstrap_issues_label) || 'agent:codex' }}
      draft_pr: ${{ inputs.draft_pr }}
      options_json: ${{ inputs.options_json || '{}' }}
