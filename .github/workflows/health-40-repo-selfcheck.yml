name: Maint 35 Repo Health Self Check

on:
  schedule:
    - cron: '20 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  repo-health:
    name: Repository health summary
    runs-on: ubuntu-latest
    steps:
      - name: Collect repository signals
        id: collect
        uses: actions/github-script@v7
        env:
          REQUIRED_LABELS: agent:codex,agent:copilot,automerge,risk:low,codex-ready
          SERVICE_BOT_PAT: ${{ secrets.SERVICE_BOT_PAT }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const requiredLabels = (process.env.REQUIRED_LABELS || '')
              .split(',')
              .map((label) => label.trim())
              .filter(Boolean);

            const timestamp = new Date().toISOString();
            const repoInfo = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.data.default_branch;

            const missingLabels = [];
            for (const label of requiredLabels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: label });
              } catch (error) {
                if (error.status === 404) {
                  missingLabels.push(label);
                } else {
                  throw error;
                }
              }
            }

            let branchStatus = 'unknown';
            let branchNote = 'Branch protection not checked.';
            const serviceBotPat = process.env.SERVICE_BOT_PAT || '';
            let privilegedChecksUsed = false;
            let privilegedChecksSkipped = false;

            const runPrivilegedCheck = async () => {
              const { Octokit } = require('@octokit/rest');
              const elevatedGithub = new Octokit({ auth: serviceBotPat });
              try {
                await elevatedGithub.repos.getBranchProtection({
                  owner,
                  repo,
                  branch: defaultBranch,
                });
                branchStatus = 'enabled';
                branchNote = `Branch protection is configured for ${defaultBranch}.`;
              } catch (error) {
                if (error.status === 404) {
                  branchStatus = 'missing';
                  branchNote = `Branch protection is not configured for ${defaultBranch}.`;
                } else if (error.status === 403) {
                  branchStatus = 'forbidden';
                  branchNote = 'The supplied token lacks permission to read branch protection settings.';
                  core.warning(branchNote);
                } else {
                  branchStatus = 'error';
                  branchNote = `Branch protection check failed: ${error.message}`;
                  core.warning(branchNote);
                }
              }
            };

            if (serviceBotPat) {
              privilegedChecksUsed = true;
              await runPrivilegedCheck();
            } else {
              privilegedChecksSkipped = true;
              branchStatus = 'skipped';
              branchNote = 'SERVICE_BOT_PAT not configured; skipped branch protection check.';
              core.notice('Skipped privileged checks because SERVICE_BOT_PAT is not configured.');
            }

            const checks = [
              {
                key: 'labels',
                title: 'Label inventory',
                status: missingLabels.length === 0 ? 'pass' : 'attention',
                detail:
                  missingLabels.length === 0
                    ? 'All required labels are present.'
                    : `Missing labels: ${missingLabels.join(', ')}`,
              },
              {
                key: 'branch',
                title: 'Default branch protection',
                status:
                  branchStatus === 'enabled'
                    ? 'pass'
                    : branchStatus === 'missing'
                    ? 'attention'
                    : branchStatus === 'skipped'
                    ? 'skipped'
                    : 'warn',
                detail: branchNote,
              },
              {
                key: 'default-branch',
                title: 'Default branch',
                status: 'info',
                detail: defaultBranch,
              },
            ];

            core.info(
              [
                `Repo health summary @ ${timestamp}`,
                `• Required labels present: ${missingLabels.length === 0 ? 'yes' : 'no'}`,
                `• Branch protection status: ${branchStatus}`,
                privilegedChecksUsed
                  ? '• Privileged checks: executed with SERVICE_BOT_PAT'
                  : '• Privileged checks: skipped (SERVICE_BOT_PAT not configured)',
              ].join('\n')
            );

            core.setOutput('checks', JSON.stringify(checks));
            core.setOutput('timestamp', timestamp);
            core.setOutput('default_branch', defaultBranch);
            core.setOutput('privileged_checks_skipped', privilegedChecksSkipped ? 'true' : 'false');

      - name: Repo health summary
        env:
          CHECKS_JSON: ${{ steps.collect.outputs.checks }}
          TIMESTAMP: ${{ steps.collect.outputs.timestamp }}
          DEFAULT_BRANCH: ${{ steps.collect.outputs.default_branch }}
          PRIVILEGED_SKIPPED: ${{ steps.collect.outputs.privileged_checks_skipped }}
        run: |
          python - <<'PY'
          import json
          import os

          checks = json.loads(os.environ.get('CHECKS_JSON') or '[]')
          timestamp = os.environ.get('TIMESTAMP') or ''
          default_branch = os.environ.get('DEFAULT_BRANCH') or ''
          privileged_skipped = (os.environ.get('PRIVILEGED_SKIPPED') or '').lower() == 'true'

          status_labels = {
              'pass': '✅ Pass',
              'attention': '⚠️ Needs attention',
              'warn': '⚠️ Warning',
              'info': 'ℹ️ Info',
              'skipped': '⚠️ Skipped',
          }

          lines = ['# Repo health summary']
          if timestamp:
              lines.append('')
              lines.append(f'*Run timestamp:* `{timestamp}`')
          if default_branch:
              lines.append('')
              lines.append(f'*Default branch:* `{default_branch}`')

          if checks:
              lines.append('')
              lines.append('| Check | Status | Details |')
              lines.append('| --- | --- | --- |')
              for check in checks:
                  title = check.get('title', 'Unknown')
                  status = status_labels.get(check.get('status', 'info'), check.get('status', 'info'))
                  detail = (check.get('detail') or '').replace('\n', '<br>')
                  lines.append(f'| {title} | {status} | {detail} |')

          if privileged_skipped:
              lines.append('')
              lines.append('> ℹ️ Privileged checks were skipped because `SERVICE_BOT_PAT` is not configured.')

          output = '\n'.join(lines) + '\n'
          print(output)

          summary_path = os.environ['GITHUB_STEP_SUMMARY']
          with open(summary_path, 'a', encoding='utf-8') as handle:
              handle.write(output)
          PY
