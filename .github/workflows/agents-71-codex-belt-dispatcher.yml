# Automates selection of ready Codex issues and primes a codex/issue-<n> branch
# before handing control to the Codex belt worker.
name: Agents 71 Codex Belt Dispatcher

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      force_issue:
        description: 'Optional issue number to dispatch immediately'
        required: false
        default: ''
        type: string

permissions:
  contents: write
  issues: write
  actions: write

concurrency:
  group: codex-belt-dispatcher
  cancel-in-progress: false

jobs:
  dispatch:
    name: Select next Codex issue
    runs-on: ubuntu-latest
    env:
      ACTIONS_BOT_PAT: ${{ secrets.ACTIONS_BOT_PAT }}
    steps:
      - name: Ensure ACTIONS_BOT_PAT is configured
        run: |
          if [ -z "$ACTIONS_BOT_PAT" ]; then
            echo '::error::ACTIONS_BOT_PAT secret is required for dispatcher writes.'
            exit 1
          fi

      - name: Resolve candidate issue
        id: pick
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const forced = (context.payload.inputs && context.payload.inputs.force_issue) || '';
            const { owner, repo } = context.repo;

            const summary = core.summary;
            summary.addHeading('Codex Belt Dispatcher');

            let issueNumber = null;
            let reason = '';

            if (forced && String(forced).trim()) {
              issueNumber = Number(String(forced).trim());
              reason = 'manual-dispatch';
            }

            if (!issueNumber) {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                labels: 'agent:codex,status:ready',
                sort: 'created',
                direction: 'asc',
                per_page: 30,
              });
              const match = issues.find((issue) => !issue.pull_request);
              if (match) {
                issueNumber = match.number;
                reason = 'queue-selection';
              }
            }

            if (!issueNumber) {
              summary.addRaw('No open issues with labels `agent:codex` and `status:ready` were found.').write();
              core.setOutput('issue', '');
              core.setOutput('reason', 'empty');
              return;
            }

            summary.addTable([
              [
                { data: 'Issue', header: true },
                { data: 'Reason', header: true }
              ],
              [
                `#${issueNumber}`,
                reason || '(unspecified)'
              ]
            ]);

            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.default_branch || 'main';
            const branch = `codex/issue-${issueNumber}`;

            core.setOutput('issue', String(issueNumber));
            core.setOutput('branch', branch);
            core.setOutput('base', base);
            core.setOutput('reason', reason || '');
            summary.addRaw(`Selected issue #${issueNumber} â†’ branch \`${branch}\` on base \`${base}\`.`).write();

      - name: Stop when queue is empty
        if: ${{ steps.pick.outputs.issue == '' }}
        run: echo 'No work queued.'

      - name: Checkout default branch
        if: ${{ steps.pick.outputs.issue != '' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pick.outputs.base }}
          token: ${{ env.ACTIONS_BOT_PAT }}
          fetch-depth: 0

      - name: Create codex branch if missing
        if: ${{ steps.pick.outputs.issue != '' }}
        run: |
          set -euo pipefail
          branch="${{ steps.pick.outputs.branch }}"
          default_ref="${{ steps.pick.outputs.base }}"

          git config user.name "stranske-automation-bot"
          git config user.email "stranske-automation-bot@users.noreply.github.com"

          if git ls-remote --heads origin "$branch" >/dev/null 2>&1; then
            echo "Branch $branch already exists on origin; leaving as-is."
          else
            git checkout -b "$branch"
            git push origin "$branch"
            echo "Created branch $branch from $default_ref."
          fi

      - name: Transition issue to in-progress
        if: ${{ steps.pick.outputs.issue != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const issue = Number('${{ steps.pick.outputs.issue }}');
            if (!issue) { return; }
            const { owner, repo } = context.repo;
            const branch = '${{ steps.pick.outputs.branch }}';
            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: issue, name: 'status:ready' });
            } catch (error) {
              if (error.status !== 404) {
                core.warning(`Failed to remove status:ready: ${error.message}`);
              }
            }
            try {
              await github.rest.issues.addLabels({ owner, repo, issue_number: issue, labels: ['status:in-progress'] });
            } catch (error) {
              core.warning(`Failed to add status:in-progress: ${error.message}`);
            }
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue,
                body: `Codex belt dispatcher queued this issue and created branch \`${branch}\`.`
              });
            } catch (error) {
              core.warning(`Failed to comment on issue #${issue}: ${error.message}`);
            }

      - name: Dispatch worker
        if: ${{ steps.pick.outputs.issue != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.ACTIONS_BOT_PAT }}
          script: |
            const { owner, repo } = context.repo;
            await github.rest.repos.createDispatchEvent({
              owner,
              repo,
              event_type: 'codex-belt.work',
              client_payload: {
                issue: Number('${{ steps.pick.outputs.issue }}'),
                branch: '${{ steps.pick.outputs.branch }}',
                base: '${{ steps.pick.outputs.base }}',
                source: '${{ steps.pick.outputs.reason || 'queue-selection' }}'
              },
            });
            core.summary.addRaw('Worker dispatch event submitted.').write();
