name: Agent watchdog (wrapper)

on:
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number to monitor"
        required: true
      agent:
        description: "Agent key (codex, copilot, etc.)"
        required: false
        default: ""
      expected_pr:
        description: "Expected PR number (optional)"
        required: false
        default: ""
      timeout_minutes:
        description: "Timeout window in minutes"
        required: false
        default: "7"
      started_at:
        description: "ISO timestamp marking the watchdog start"
        required: false
        default: ""

permissions:
  actions: write
  contents: read
  issues: read
  pull-requests: read

jobs:
  forward:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch unified watchdog
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const ref = repoInfo.default_branch || 'main';
            const inputs = context.payload?.inputs || {};
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'agents-41-assign-and-watch.yml',
              ref,
              inputs: {
                mode: 'watch',
                issue: (inputs.issue || '').toString(),
                agent: (inputs.agent || '').toString(),
                expected_pr: (inputs.expected_pr || '').toString(),
                timeout_minutes: (inputs.timeout_minutes || '').toString(),
                started_at: (inputs.started_at || '').toString(),
                event_name: 'workflow_dispatch',
                event_payload: JSON.stringify({ inputs })
              }
            });
            core.info('Dispatched watch operation to agents-41-assign-and-watch.yml.');
