name: Health 42 Actionlint

on:
  pull_request:
    paths:
      - '.github/workflows/**/*.yml'
  push:
    branches: [phase-2-dev]
    paths:
      - '.github/workflows/**/*.yml'
  schedule:
    - cron: '5 5 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  lint:
    name: workflow lint (maint-36)
    runs-on: ubuntu-latest
    env:
      ACTIONLINT_VERSION: '1.7.1'
    steps:
      - uses: actions/checkout@v4

      - name: Compute actionlint allowlist
        id: allowlist
        shell: bash
        run: |
          python - <<'PY' '.github/actionlint-allowlist.txt' "$GITHUB_OUTPUT"
          import sys
          from pathlib import Path


          def load_entries(path: Path) -> list[str]:
              if not path.is_file():
                  return []
              entries: list[str] = []
              for raw in path.read_text(encoding='utf-8').splitlines():
                  line = raw.strip()
                  if not line or line.startswith('#'):
                      continue
                  entries.append(line)
              return entries


          entries = load_entries(Path(sys.argv[1]))
          args_path = Path('actionlint-allowlist.args')
          if entries:
              args_path.write_text(
                  '\n'.join(f'-ignore={entry}' for entry in entries) + '\n',
                  encoding='utf-8',
              )
          else:
              args_path.write_text('', encoding='utf-8')

          with Path(sys.argv[2]).open('a', encoding='utf-8') as handle:
              handle.write(f'args_file={args_path}\n')
          PY

      - name: Restore cached actionlint
        id: actionlint-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/actionlint
          key: actionlint-${{ runner.os }}-${{ env.ACTIONLINT_VERSION }}

      - name: Install actionlint
        if: steps.actionlint-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.cache/actionlint"
          curl -sSL "https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_linux_amd64.tar.gz" \
            | tar -xz -C "$HOME/.cache/actionlint" actionlint
          chmod +x "$HOME/.cache/actionlint/actionlint"

      - name: Add actionlint to PATH
        shell: bash
        run: echo "$HOME/.cache/actionlint" >> "$GITHUB_PATH"

      - name: Run actionlint
        id: actionlint
        shell: bash
        env:
          ALLOWLIST_FILE: ${{ steps.allowlist.outputs.args_file }}
        run: |
          set -euo pipefail

          extra_args=()
          if [ -n "${ALLOWLIST_FILE:-}" ] && [ -f "$ALLOWLIST_FILE" ]; then
            mapfile -t extra_args < <(sed -e 's/[[:space:]]*$//' -e '/^$/d' "$ALLOWLIST_FILE")
          fi

          tmpdir="$(mktemp -d)"
          sarif_path="${tmpdir}/actionlint.sarif"

          lint_status=0
          if ! actionlint -color never -format sarif "${extra_args[@]}" >"${sarif_path}"; then
            lint_status=$?
          fi

          if [ "$lint_status" -ne 0 ]; then
            echo '::group::actionlint (text output)'
            actionlint -color never "${extra_args[@]}" || true
            echo '::endgroup::'
          fi

          rd_status=0
          if ! cat "${sarif_path}" \
            | reviewdog -f=sarif \
              -name="maint-36 actionlint" \
              -reporter="$REPORTER" \
              -filter-mode="nofilter" \
              -level="warning" \
              -fail-level="error"; then
            rd_status=$?
          fi

          rm -rf "${tmpdir}"

          if [ "$lint_status" -ne 0 ]; then
            exit "$lint_status"
          fi

          exit "$rd_status"

      - name: Publish lint summary
        if: always()
        run: |
          if [ -n "${{ steps.actionlint.outcome }}" ]; then
            {
              echo '## maint-36 actionlint'
              echo "- Outcome: ${{ steps.actionlint.outcome }}"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
