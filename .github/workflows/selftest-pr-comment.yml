name: Self-Test PR Validation

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  selftest:
    name: Run Self-Test Matrix
    uses: ./.github/workflows/selftest-reusable-ci.yml
    secrets: inherit

  pr_comment:
    name: Post Self-Test Summary
    needs: selftest
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    steps:
      - name: Download self-test report
        if: ${{ needs.selftest.outputs.run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: selftest-report
          run-id: ${{ needs.selftest.outputs.run_id }}
          path: .
        continue-on-error: true
      - name: Post / update PR comment
        uses: actions/github-script@v7
        env:
          TABLE: ${{ needs.selftest.outputs.verification_table }}
          FAILURES: ${{ needs.selftest.outputs.failures }}
          RESULT: ${{ needs.selftest.result }}
        with:
          script: |
            const marker = '<!-- selftest-reusable-ci -->';
            const failures = process.env.FAILURES || '0';
            const runResult = process.env.RESULT || 'unknown';
            let parsed = null;
            try {
              const fs = require('fs');
              if (fs.existsSync('selftest-report.json')) {
                parsed = JSON.parse(fs.readFileSync('selftest-report.json', 'utf8'));
              }
            } catch (error) {
              core.warning(`Unable to parse selftest-report.json: ${error}`);
            }
            const table = process.env.TABLE || '*No table available*';
            const statusLine = failures === '0'
              ? '✅ **Self-test passed** (all scenarios matched expected artifacts).'
              : `❌ **Self-test found ${failures} scenario mismatch(es)**.`;
            const runBadge = runResult === 'success'
              ? '✅'
              : runResult === 'failure'
                ? '❌'
                : 'ℹ️';
            const header = `${runBadge} Workflow status: **${runResult}**`;
            const body = `${marker}\n${header}\n${statusLine}\n\n${table}\n\n<details><summary>Raw JSON report</summary>\n\n${parsed ? '```json\n'+JSON.stringify(parsed, null, 2)+'\n```' : '_Report not available_'}\n\n</details>`;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const existing = comments.data.find((c) => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
              core.info(`Updated PR comment #${existing.id}`);
            } else {
              const created = await github.rest.issues.createComment({ owner, repo, issue_number, body });
              core.info(`Created PR comment #${created.data.id}`);
            }
