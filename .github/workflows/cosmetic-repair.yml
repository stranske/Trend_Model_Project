name: Cosmetic Repair

on:
  workflow_dispatch:
    inputs:
      base-branch:
        description: Base branch to target when opening the repair PR
        default: main
        required: false
      python-version:
        description: Python version to use for pytest
        default: '3.11'
        required: false
      dry-run:
        description: Run the repair helper in dry-run mode without creating commits
        default: 'false'
        required: false
      branch-suffix:
        description: Optional suffix appended to the repair branch name
        default: ''
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  repair:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: ${{ inputs.python-version }}
      BASE_BRANCH: ${{ inputs.base-branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.BASE_BRANCH }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e '.[dev]'

      - name: Run pytest (allow failures)
        id: pytest
        run: |
          set +e
          source .venv/bin/activate
          pytest -q --junitxml=pytest-report.xml
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Run cosmetic repair script
        run: |
          set -euo pipefail
          cmd=("python" "scripts/ci_cosmetic_repair.py")
          if [ "${{ inputs['dry-run'] }}" = "true" ]; then
            cmd+=("--dry-run" "--skip-pr")
          else
            cmd+=("--apply")
          fi
          if [ -n "${{ inputs['branch-suffix'] }}" ]; then
            cmd+=("--branch-suffix" "${{ inputs['branch-suffix'] }}")
          fi
          cmd+=("--base" "${{ github.event.repository.default_branch }}")
          echo "Running: ${cmd[*]}"
          "${cmd[@]}"

      - name: Capture cosmetic summary outputs
        if: always()
        id: cosmetic-summary
        env:
          SUMMARY_FILE: .cosmetic-repair-summary.json
        run: |
          python -c "import json, os; from pathlib import Path; summary = Path(os.environ['SUMMARY_FILE']); \
          if summary.exists(): \
              data = json.loads(summary.read_text(encoding='utf-8')); \
              with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as handle: \
                  for key in ('status', 'branch', 'pr_url'): \
                      value = data.get(key); \
                      if value: \
                          handle.write(f'{key}={value}\\n')"

      - name: Upload pytest report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cosmetic-repair-artifacts
          path: |
            pytest-report.xml
            tmp_logs/cosmetic_repair_summary.json
          if-no-files-found: ignore

      - name: Evaluate repair outcome
        id: outcome
        env:
          PYTEST_EXIT_CODE: ${{ steps.pytest.outputs.exit_code }}
        run: |
          python -c "import json, os; from pathlib import Path; exit_code = int(os.environ.get('PYTEST_EXIT_CODE') or 0); \
          summary_path = Path('tmp_logs/cosmetic_repair_summary.json'); \
          should_fail = False; \
          reason = ''; \
          if exit_code != 0: \
              if summary_path.exists(): \
                  summary = json.loads(summary_path.read_text(encoding='utf-8')); \
                  if summary.get('applied', 0) == 0: \
                      should_fail = True; \
                      reason = 'Pytest failures detected but no cosmetic fixes were applied.'; \
              else: \
                  should_fail = True; \
                  reason = 'Pytest failures detected but repair summary was not generated.'; \
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh: \
              fh.write('should_fail={}\n'.format('true' if should_fail else 'false')); \
              if reason: \
                  fh.write('reason={}\n'.format(reason))"

      - name: Create cosmetic repair PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: cosmetic-repair/${{ github.run_id }}
          base: ${{ env.BASE_BRANCH }}
          title: "Cosmetic repair: pytest drift"
          commit-message: "ci: apply cosmetic repairs"
          labels: 'testing,autofix:applied,autofix'
          body: |
            ## Cosmetic repair summary

            * Pytest exit code: `${{ steps.pytest.outputs.exit_code }}`
            * Workflow run: ${{ github.run_id }}

            The cosmetic repair job detected cosmetic-only failures and attempted
            automated fixes using `scripts/ci_cosmetic_repair.py`.

      - name: Fail if unresolved failures remain
        if: steps.outcome.outputs.should_fail == 'true'
        run: |
          summary_file=".cosmetic-repair-summary.json"
          {
            echo "### Cosmetic repair summary"
            echo
            if [ -f "$summary_file" ]; then
              python -c "import json, pathlib; summary = pathlib.Path('$summary_file'); \
              data = json.loads(summary.read_text(encoding='utf-8')); \
              status = data.get('status', 'unknown'); \
              print(f'- Status: **{status}**'); \
              changed = data.get('changed_files') or []; \
              if changed: \
                  print(f'- Changed files ({len(changed)}):'); \
                  print('\\n'.join(f'  - {path}' for path in changed)); \
              else: \
                  print('- No file changes detected.'); \
              pr_url = data.get('pr_url'); \
              if pr_url: \
                  print(f'- PR: {pr_url}'); \
              instructions = data.get('instructions') or []; \
              if instructions: \
                  print('- Instructions processed:'); \
                  for entry in instructions: \
                      kind = entry.get('kind', 'unknown'); \
                      path = entry.get('path', '?'); \
                      guard = entry.get('guard', ''); \
                      extra = f' ({guard})' if guard else ''; \
                      print(f'  - {kind} -> {path}{extra}')"
            else
              git status --short || true
            fi
          } >> "$GITHUB_STEP_SUMMARY"
