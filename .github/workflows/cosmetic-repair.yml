name: Cosmetic Repair

on:
  workflow_dispatch:
    inputs:
      base-branch:
        description: Base branch to target when opening the repair PR
        default: main
        required: false
      python-version:
        description: Python version to use for pytest
        default: '3.11'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  repair:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: ${{ inputs.python-version }}
      BASE_BRANCH: ${{ inputs.base-branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.BASE_BRANCH }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e '.[dev]'

      - name: Run pytest (allow failures)
        id: pytest
        run: |
          set +e
          source .venv/bin/activate
          pytest -q --junitxml=pytest-report.xml
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Run cosmetic repair script
        run: |
          source .venv/bin/activate
          python scripts/ci_cosmetic_repair.py --junit pytest-report.xml --summary tmp_logs/cosmetic_repair_summary.json

      - name: Collect artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cosmetic-repair-artifacts
          path: |
            pytest-report.xml
            tmp_logs/cosmetic_repair_summary.json
          if-no-files-found: ignore

      - name: Evaluate repair outcome
        id: outcome
        env:
          PYTEST_EXIT_CODE: ${{ steps.pytest.outputs.exit_code }}
        run: |
          python <<'PY'
import json
import os
from pathlib import Path

exit_code = int(os.environ.get("PYTEST_EXIT_CODE") or 0)
summary_path = Path("tmp_logs/cosmetic_repair_summary.json")
should_fail = False
reason = ""

if exit_code != 0:
    if summary_path.exists():
        summary = json.loads(summary_path.read_text(encoding="utf-8"))
        if summary.get("applied", 0) == 0:
            should_fail = True
            reason = "Pytest failures detected but no cosmetic fixes were applied."
    else:
        should_fail = True
        reason = "Pytest failures detected but repair summary was not generated."

with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
    fh.write(f"should_fail={'true' if should_fail else 'false'}\n")
    if reason:
        fh.write(f"reason={reason}\n")
PY

      - name: Create cosmetic repair PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: cosmetic-repair/${{ github.run_id }}
          base: ${{ env.BASE_BRANCH }}
          title: "Cosmetic repair: pytest drift"
          commit-message: "ci: apply cosmetic repairs"
          labels: testing,autofix:applied,autofix
          body: |
            ## Cosmetic repair summary

            * Pytest exit code: `${{ steps.pytest.outputs.exit_code }}`
            * Workflow run: ${{ github.run_id }}

            The cosmetic repair job detected cosmetic-only failures and attempted
            automated fixes using `scripts/ci_cosmetic_repair.py`.

      - name: Fail if unresolved failures remain
        if: steps.outcome.outputs.should_fail == 'true'
        run: |
          echo "${{ steps.outcome.outputs.reason }}" >&2
          exit 1
