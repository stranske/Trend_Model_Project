# UI Run Reproduction (2025-12-15)

This document tracks progress toward making **all parameters** in the captured UI state honored simultaneously.

Related debugging note: [docs/debugging/turnover_and_churn_heuristics.md](docs/debugging/turnover_and_churn_heuristics.md)

## Inputs

- Captured UI state: `docs/debugging/ui_run_2025-12-15.json`
- Captured UI state (underweight strikes enabled): `docs/debugging/ui_run_2025-12-15_min_weight_strikes.json`
- Captured UI state (8→12 constituents constraints): `docs/debugging/ui_run_2025-12-15_8to12.json`
- Captured UI state (target 8, min 6, max 12): `docs/debugging/ui_run_2025-12-15_8target_6to12.json`
- Data file: `data/Trend Universe Data.csv`
- Reproduction script: `scripts/reproduce_ui_run.py`

## How to reproduce

```bash
source .venv/bin/activate
python scripts/reproduce_ui_run.py \
  --params docs/debugging/ui_run_2025-12-15.json \
  --data "data/Trend Universe Data.csv" \
  --out tmp/debug_runs/ui_run_2025-12-15
```

Underweight strikes mapping check:

```bash
source .venv/bin/activate
python scripts/reproduce_ui_run.py \
  --params docs/debugging/ui_run_2025-12-15_min_weight_strikes.json \
  --data "data/Trend Universe Data.csv" \
  --out tmp/debug_runs/ui_run_2025-12-15_min_weight_strikes

8→12 constituents constraints run:

```bash
source .venv/bin/activate
python scripts/reproduce_ui_run.py \
  --params docs/debugging/ui_run_2025-12-15_8to12.json \
  --data "data/Trend Universe Data.csv" \
  --out tmp/debug_runs/ui_run_2025-12-15_8to12_check
```

Target 8, min 6, max 12 (expected to allow drift + z-score churn):

```bash
source .venv/bin/activate
python scripts/reproduce_ui_run.py \
  --params docs/debugging/ui_run_2025-12-15_8target_6to12.json \
  --data "data/Trend Universe Data.csv" \
  --out tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check
```
```

## Diff helper

After each new run, diff it against a known baseline folder:

```bash
python scripts/diff_ui_runs.py \
  --a tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3 \
  --b tmp/debug_runs/ui_run_2025-12-15_after_underweight_ui \
  --out tmp/debug_runs/ui_run_2025-12-15_after_underweight_ui/diff
```

This writes:

- `diff_summary.md` (human-readable)
- `diff_summary.json` (machine-readable)

## Baseline outcome (current)

The reproduction now **succeeds** end-to-end (multi-period enabled) and writes baseline artifacts to:

- `tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/` (latest; includes rebalance-date weights)
- `tmp/debug_runs/ui_run_2025-12-15/` (original baseline)
- `tmp/debug_runs/ui_run_2025-12-15_min_weight_strikes/` (underweight strikes mapping check)

Latest rerun (same captured UI payload, post-changes):

- `tmp/debug_runs/ui_run_2025-12-15_after_underweight_ui/`

Latest rerun (Trend Universe, focus: min/max constituents + terminations):

- `tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/`
  - Effective config: [tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/config.json](tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/config.json)
  - Period summary: [tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/period_results_summary.csv](tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/period_results_summary.csv)
  - Manager changes: [tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_minmax_terminations_check/period_manager_changes.csv)
  - Evidence:
    - `portfolio.rank.n=8` / `portfolio.threshold_hold.target_n=8`, but `portfolio.constraints.min_funds=10` and `max_funds=25`.
    - `selected_funds_n` is **10 for all 22 periods** (min/max constituent constraints are honored, but the minimum overrides the 8-fund target).
    - Drops occur in most periods (**45** `action=dropped` events total), but they are primarily **pruning/cap-related** (`cap_max_funds`, `one_per_firm`, `rebalance`) rather than `z_exit` exits.

Corrected run (intended sizing semantics: target 8, min 8, max 12):

- `tmp/debug_runs/ui_run_2025-12-15_8to12_check/`
  - Effective config: [tmp/debug_runs/ui_run_2025-12-15_8to12_check/config.json](tmp/debug_runs/ui_run_2025-12-15_8to12_check/config.json)
  - Period summary: [tmp/debug_runs/ui_run_2025-12-15_8to12_check/period_results_summary.csv](tmp/debug_runs/ui_run_2025-12-15_8to12_check/period_results_summary.csv)
  - Manager changes: [tmp/debug_runs/ui_run_2025-12-15_8to12_check/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_8to12_check/period_manager_changes.csv)
  - Evidence:
    - `portfolio.constraints.min_funds=8` and `max_funds=12`.
    - `selected_funds_n` stays at **8** for all periods (within min/max).
    - Realised terminations via exit rules appear: **5** drop events with `reason=z_exit` / `z_exit_hard`.

Sizing semantics fix (avoid legacy max_active_positions override; allow size drift within bounds):

- Legacy sizing knob `max_active_positions` could silently override the displayed/derived `max_funds` in the Results page and confuse reproduction efforts.
- Removed that override and aligned sizing display to `mp_min_funds`/`mp_max_funds`.
- Updated the multi-period engine so that after the initial seed, the portfolio is no longer forcibly refilled to `target_n` every period; it can drift within `[min_funds, max_funds]` based on entry/exit triggers.

Run (target 8, min 6, max 12):

- `tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/`
  - Effective config: [tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/config.json](tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/config.json)
  - Period summary: [tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/period_results_summary.csv](tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/period_results_summary.csv)
  - Manager changes: [tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_8target_6to12_check/period_manager_changes.csv)
  - Evidence:
    - Constraints: `min_funds=6`, `max_funds=12`.
    - Realised holdings count drifts from **8 → 12** and remains within bounds (`selected_funds_n` range **[8, 12]**).
    - Z-score churn is present: **10** `reason=z_entry` adds and **6** `reason=z_exit*` drops.

Generated artifacts (current):

- `config.json` (effective config after Streamlit mapping)
- `metrics.csv` (top-level API metrics)
- `period_results_summary.csv` (one row per multi-period step)
- `period_fund_weights.csv` and `period_ew_weights.csv` (tidy per-period weights)
- `period_rebalance_weights.csv` (tidy per-rebalance-date weights; long format)

Note: `diagnostic.json` is `null` for successful runs.

## Parameter-to-config mapping notes (from Streamlit)

The Streamlit config mapping lives in `streamlit_app/components/analysis_runner.py`.

Notable mappings:

- `rebalance_freq: "Q"` is passed into `config.portfolio["rebalance_freq"]`.
- `max_changes_per_period` maps to `config.portfolio["turnover_budget_max_changes"]`.
- `mp_max_funds` maps to `config.portfolio.constraints.max_funds`.
- `mp_min_funds` maps to `config.portfolio.constraints.min_funds`.
- `min_weight_strikes` maps to `config.portfolio.constraints.min_weight_strikes`.
- `selected_risk_free` is *not* automatically mapped; the analysis config only uses `model_state.risk_free_column` when present.

## Parameter compliance catalog (UI payload → effective config → evidence)

This is the catalog you asked for: which captured UI parameters are (a) mapped into the analysis config and (b) appear to affect the run, vs those that are currently ignored.

Evidence sources:

- Effective config: [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/config.json](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/config.json)
- Period summary: [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_results_summary.csv](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_results_summary.csv)
- Per-period weights: [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_fund_weights.csv](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_fund_weights.csv)
- Rebalance-date weights: [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_rebalance_weights.csv](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_rebalance_weights.csv)
- Manager changes: [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_manager_changes.csv)

### Honored (mapped + reflected in baseline)

- `selection_count` → `portfolio.rank.n` and `portfolio.threshold_hold.target_n`: baseline period 1 shows `selected_funds_n=8`.
- `rebalance_freq` → `portfolio.rebalance_freq`: rebalance schedule is exported; the sample period `2000-07-31/2003-06-30/2003-07-31/2004-06-30` has 5 rebalance dates and 5 distinct weight rows in [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_rebalance_weights.csv](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_rebalance_weights.csv).
- `max_changes_per_period` → `portfolio.turnover_budget_max_changes`: adds+drops are ≤ 6 for all non-seed periods; the only period above the cap is the initial seed period (8 adds), visible in [tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_rebalance_weights_fix3/period_manager_changes.csv).
- `transaction_cost_bps` → `portfolio.transaction_cost_bps`: period summary has non-zero `transaction_cost` values.
- `max_turnover` → `portfolio.max_turnover`: turnover values are recorded per period.
- `weighting_scheme` → `portfolio.weighting_scheme` (`risk_parity`): per-period weights are non-equal (compare `period_fund_weights.csv` vs `period_ew_weights.csv`).
- Entry/exit rules: `z_entry_soft`, `z_exit_soft`, `soft_strikes`, `entry_soft_strikes`, `z_entry_hard`, `z_exit_hard` → `portfolio.threshold_hold.*`: weights and manager changes vary by period, indicating threshold-hold policy is active.
- Stickiness: `sticky_add_periods`, `sticky_drop_periods` → `portfolio.sticky_add_x`, `portfolio.sticky_drop_y`.
- Constraints: `long_only`, `max_weight`, `mp_max_funds`, `max_active_positions`, `min_tenure_periods` → `portfolio.constraints.*`, `portfolio.max_active`, `portfolio.min_tenure_n`.
- `mp_min_funds` → `portfolio.constraints.min_funds`: verified in [tmp/debug_runs/ui_run_2025-12-15_min_funds/config.json](tmp/debug_runs/ui_run_2025-12-15_min_funds/config.json) and enforced via `manager_changes` entries with `reason=min_funds` in [tmp/debug_runs/ui_run_2025-12-15_min_funds/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_min_funds/period_manager_changes.csv).
- `min_weight_strikes` → `portfolio.constraints.min_weight_strikes`: verified in [tmp/debug_runs/ui_run_2025-12-15_min_weight_strikes/config.json](tmp/debug_runs/ui_run_2025-12-15_min_weight_strikes/config.json).
- Data handling: `missing_policy` → `data.missing_policy` and winsorization fields → `preprocessing.winsorise.*`.
- Multi-period scheduling: `multi_period_frequency`, `lookback_periods`, `evaluation_periods`, `start_date`, `end_date` → `multi_period.*`.
- Risk model robustness: `shrinkage_enabled`, `shrinkage_method`, `condition_threshold`, `safe_mode` → `robustness.*`.
- Regime toggle: `regime_enabled`, `regime_proxy` → `regime.*`.
- Benchmark/risk-free: `selected_benchmark` → `benchmarks`, and `selected_risk_free` is reflected via `data.risk_free_column` (set from UI before config mapping).

### Mapped but needs follow-up evidence (mapped, but we have not yet proved correctness)

- Underweight exit triggers: `min_weight_strikes` is now configurable and mapped, but the baseline reproduction does not currently produce `reason=low_weight_strikes` events in [tmp/debug_runs/ui_run_2025-12-15_min_weight_strikes/period_manager_changes.csv](tmp/debug_runs/ui_run_2025-12-15_min_weight_strikes/period_manager_changes.csv).

### Ignored / not implemented (present in UI, not used in config/pipeline)

These UI parameters are currently not mapped into the analysis config and therefore are not implemented by the simulation pipeline:

- Reporting toggles: `report_attribution`, `report_benchmark_comparison`, `report_concentration`, `report_factor_exposures`, `report_regime_analysis`, `report_rolling_metrics` (they drive Streamlit display, not core simulation)

These are parsed in the Streamlit mapping but are not present in this run’s effective config because they were set to 0 / disabled:

- `bottom_k` (disabled when 0)
- `slippage_bps` (disabled when 0)

### Clarification (mapped but intentionally transformed)

- `date_mode: "explicit"` becomes `multi_period.start_mode: "oos"` in the effective config. This is intentional in the Streamlit mapping: explicit dates are interpreted as OOS month boundaries.

## Next debugging checkpoints

1. Add a reproduction scenario that triggers at least one `low_weight_strikes` exit (so we can validate the behavior end-to-end, not just mapping).
2. Add per-period watch list outputs (near-entry/near-exit/deferred due to cap) and export them for UI.
