# Keepalive Evaluation â€“ PR 3429 (2025-11-10)

This report reviews keepalive automation activity on pull request [#3429](https://github.com/stranske/Trend_Model_Project/pull/3429)
against the requirements in:

- `docs/keepalive/GoalsAndPlumbing.md`
- `docs/keepalive/SyncChecklist.md`
- `docs/keepalive/Agents.md`

Evidence sources collected during 2025-11-10 include:

- `gh run list --workflow "Agents 70 Orchestrator" --json ... --limit 20`
- `gh run list --branch codex/issue-3428 --status cancelled --json ...`
- `gh run list --workflow "Keepalive Branch Sync" --json ...`
- Timeline export `tmp_logs/pr3429_timeline.json` (latest 100 events)

## 1. Activation Guardrails (Goals & Plumbing Â§1)

| Requirement | Evidence | Status |
| --- | --- | --- |
| `agents:keepalive` label present when instructions post | Timeline shows label removal at 07:07:42Z (`unlabeled` event by `stranske`) while Roundsâ€¯11â€“13 landed between 07:08Z and 07:11Z (`tmp_logs/pr3429_timeline.json`). | âŒ Violated |
| Human kickoff via @mention | Roundâ€¯2 instruction (`06:52:48Z`) authored by `stranske` directly pings `@codex` with the task list. | âœ… |
| Gate success at current head | Instruction comments (e.g. Roundâ€¯10 and Roundâ€¯19) include the â€œLatest Runs: âœ… success â€” Gateâ€ block generated by the orchestrator. | âœ… |

**Impact:** Guardrail labels disappeared for ~6h, yet automation continued posting instructions, breaching Goals Â§1.

## 2. Repeat Contract (Goals & Plumbing Â§2)

- Orchestrator reruns after Roundâ€¯10 ignored the missing label and kept emitting instructions (Roundsâ€¯11â€“13).
- No evidence of a compensating pause or halt was observed.

âŒ Overall â€“ repeat guardrails are not enforced.

## 3. Run Cap Enforcement (Goals & Plumbing Â§3)

The orchestrator ran 12 times in a 10-minute window (14:50:14Z â†’ 15:00Z range) per `gh run list --workflow "Agents 70 Orchestrator"`, demonstrating no effective run cap. Concurrency increases noise and heightens the risk of overlapping traces.

Additional log evidence captured **before** `agents:pause` went live (runs `19254934411` at 04:27Z, `19254946001` at 04:28Z, and `19255030604` at 04:32Z on 2025-11-11) shows the gate emitting `keepalive_run_cap=2` while every utilisation counter remained `0`. The second run landed less than a minute after the first yet still reported zero recent or in-flight executions, confirming the throttle failed to register prior activity prior to the manual pause label being applied.

```
Run 19254934411 @ 04:27Z
##[notice]keepalive_run_cap=2
##[notice]keepalive_active_runs=0
##[notice]keepalive_active_runs_recent=0

Run 19255030604 @ 04:32Z
##[notice]keepalive_run_cap=2
##[notice]keepalive_active_runs=0
##[notice]keepalive_active_runs_recent=0
##[notice]keepalive_active_runs_recent_window=5
```

As of 2025-11-11 05:45Z, orchestrator runs now publish their target in the workflow `run-name` (e.g. â€œAgents 70 Orchestrator (PR #3471)â€), and `countActiveRuns()` falls back to these titles when GitHub omits `pull_requests`. A new Node regression test (`countActiveRuns recognises PR metadata embedded in run titles`) enforces the behaviour; we still need to observe live utilisation counters to confirm the fix.

âŒ Violated â€“ cap is not preventing rapid-fire reruns. Follow-up: on 2025-11-10 we updated `evaluateKeepaliveGate` to treat recently completed orchestrator/worker runs (â‰¤5â€¯min window) as part of the active count, so consecutive cron sweeps should now pause once the throttle engages. Need confirmation from the next scheduled cycle.

## 4. Pause & Stop Controls (Goals & Plumbing Â§4)

- `agents:pause` never appeared.
- Despite the critical label gap (07:07Zâ€“13:34Z), automation did not pause rounds.

âŒ Controls failed to halt activity when guardrails broke.

## 5. No-Noise Policy (Goals & Plumbing Â§5)

Twenty-four keepalive instructions (plus duplicate Roundâ€¯5 entries) posted in ~7 hours, including three rounds while guardrails were invalid. The volume and timing constitute contract noise.

âš ï¸ Partially satisfied â€“ instructions are well-formed, but cadence becomes spam once prerequisites fail.

## 6. Instruction Comment Contract (Goals & Plumbing Â§6)

Each instruction comment carries the required hidden markers, scope/tasks tables, testing sections, and receives ğŸ‘€/ğŸš€ reactions. No formatting deviations observed.

âœ… Passed.

## 7. Detection & Dispatch Flow (Goals & Plumbing Â§7)

- `keepalive-state` tracer comments capture head/base metadata (e.g. Roundâ€¯19 at 13:45:03Z).
- Worker success notices (Roundsâ€¯19â€“23) repeat even though Gate reruns keep cancelling (see Â§8), indicating dispatches run but fail to advance the branch.
- Branch-sync workflow (06:26Z) ended `failure` for head `phase-2-dev` (run `19222734980`).
- Maintainer-dispatched rerun `19239811962` (17:09Z) completed successfully after the fetch fix, confirming the dry-run path now reaches merge evaluation.

âš ï¸ Partial â€“ snapshotting occurs, yet downstream sync actions fail to produce a new head.

## 8. Branch-Sync Gate (Goals & Plumbing Â§8 / Sync Checklist)

| Step | Expectation | Evidence | Status |
| --- | --- | --- | --- |
| 1. Snapshot before instruction | Capture head/base at emit time. | `keepalive-state` payloads (Roundsâ€¯17â€“24) include head SHA + refs. | âœ… |
| 2. Short poll â‰¤120â€¯s | Observe new head after worker completes. | No new SHA recorded; repeated â€œworker successâ€ comments without head change. | âš ï¸ |
| 3. Update-branch dispatch | Fire `update-branch` when head unchanged. | Keepalive Branch Sync dry run `19239811962` (trace `dryrun-20251110-fetchfi`) fetched `phase-2-dev`, merged cleanly, and marked the sync as empty after the new `git fetch --no-tags --prune` step. | âœ… |
| 4. Create-pr fallback | Open connector PR and merge. | No timeline references to connector PRs post-round; head stays static. | âŒ |
| 5. Escalate when still stale | Apply `agents:sync-required` and post escalation (if `agents:debug`). | No escalation label/comment despite repeated cancellations. | âŒ |

## 9. Orchestrator Invariants (Goals & Plumbing Â§9)

- Scheduled runs pile up without respecting the run cap (see Â§3).
- Guardrail failures do not abort instructions.

âŒ Invariants broken.

## 10. Restart & Success Conditions (Goals & Plumbing Â§10)

- Keepalive rounds loop without new commits or checklist progress.
- Task list in each instruction remains fully unchecked.

âš ï¸ Pending â€“ automation restarts but never converges.

## Connector Payload Contract (Sync Checklist)

- No evidence that `update-branch` or `create-pr` payloads were accepted; branch never advanced and no connector PR was opened. | âŒ

## Pause Label Clearance

- `agents:sync-required` was never applied, so no clearance occurred. | âš ï¸ Missing escalation.

## Outstanding Actions

1. **Restore guardrail enforcement** â€“ Block instruction emission whenever `agents:keepalive` is absent and add regression coverage for the Roundsâ€¯11â€“13 scenario; confirm during the next guardrail drill. Manual reruns `19254098629` and `19254213558` (trace `manual-run-cap-20251111`) both reported `keepalive_gate_reason=keepalive-label-missing` because they still pointed at PRÂ 3444 (no longer labelled). After retargeting the sweep to PRÂ 3468, run `19254322103` passed the gate with the expected notices. Behaviour now matches configuration; follow-up is to codify the regression tests and ensure we always point validation runs at the labelled PR.
2. **Monitor run-cap throttle** â€“ Manual sweep `19253985636` (trace `manual-run-cap-20251111`, PRÂ 3444) now exposes the counters in the log (`keepalive_run_cap=2`, `active_runs=0`, `active_runs_inflight=0`, `active_runs_recent=0`, `keepalive_active_runs_recent_window=5`) and halted because `agents:keepalive` was missing. The follow-up run `19254098629` produced the same zeroed utilisation. After retargeting to PRÂ 3468, run `19254322103` succeeded yet still logged zero active runs. Newly captured **pre-pause** runs on PRÂ 3471 (`19254934411`, `19254946001`, `19255030604`) show the same zero utilisation even though the executions land within the five-minute window, confirming the throttle was ignoring prior runs. We updated the orchestrator run name plus `countActiveRuns()` (2025-11-11 05:45Z) so default-branch runs expose the PR number and are counted; next scheduled sweep should demonstrate non-zero inflight/recent counts or reveal any remaining gaps.
3. **Monitor sync dispatches** â€“ Branch-sync workflow now fetches with `git fetch --no-tags --prune origin "$BASE_REF"`; dry-run `19239811962` verified the empty-merge path. Watch the first non-empty merge to ensure update/create fallbacks succeed.
4. **Add failure escalation** â€“ Ensure stale heads after update/create attempts apply `agents:sync-required` and post the escalation note; plan escalation script changes once sync validation completes.
5. **Document outcome** â€“ Keep `docs/keepalive/AttemptLog_Nov2025.md` and guardrail docs in sync as fixes land so PR owners can reference a single status source.

## PR #3444 Evidence Plan (2025-11-11)

| Workflow run (ID) | Job / log reference | Guardrail focus | Planned usage |
| --- | --- | --- | --- |
| [Gate (19248010641)](https://github.com/stranske/Trend_Model_Project/actions/runs/19248010641) | `github scripts tests` job â€“ log lines showing `countActiveRuns` subtests (`gh run view 19248010641 --job 55026665489 --log \| sed -n '300,360p'`) | Run-cap throttle counts in-flight + â‰¤5â€¯min completes | Capture TAP output confirming subtests 34â€“36 pass so we can cite concrete evidence that the throttle logic is under test. |
| [Gate (19248010641)](https://github.com/stranske/Trend_Model_Project/actions/runs/19248010641) | `python ci / python 3.12` job â€“ pytest progress lines for `tests/test_agents_pr_meta_keepalive.py`, `tests/test_keepalive_guard_utils.py`, `tests/test_keepalive_post_work.py`, `tests/test_keepalive_workflow.py` (`gh run view 19248010641 --job 55026665495 --log \| sed -n '900,1040p'`) | Label + orchestrator guard behaviour | Record that the keepalive-specific suites executed cleanly, then map each module to Goals Â§Â§1â€“4 and Â§9 requirements during evaluation. |
| [Gate summary (19248010641)](https://github.com/stranske/Trend_Model_Project/actions/runs/19248010641) | `summary` job â€“ `Append keepalive checklists` block (`gh run view 19248010641 --job 55026993570 --log \| grep -n "keepalive"`) | Instruction payload completeness | Verify the summary generator still appends the keepalive checklist sections; quote the rendered markdown in the evaluation when assessing noise controls. |
| [Agents PR meta manager (19248010559)](https://github.com/stranske/Trend_Model_Project/actions/runs/19248010559) | `Upsert PR body sections` job â€“ issue sync log (`gh run view 19248010559 --job 55026653075 --log \| sed -n '320,400p'`) | Task/acceptance traceability | Confirm PR body sync still mirrors issue scope/tasks so instruction comments can inherit accurate checklists. |

## Follow-up â€“ 2025-11-11

- Pulled Gate run [19248010641](https://github.com/stranske/Trend_Model_Project/actions/runs/19248010641) logs. The `github scripts tests` jobâ€™s TAP output records:
	- `ok 34 - countActiveRuns tallies in-flight runs without duplication`
	- `ok 35 - countActiveRuns treats recent completed runs as active within the window`
	- `ok 36 - countActiveRuns ignores the current run id to avoid self-counting`
	These results confirm the newly-instrumented throttle logic (5â€¯min window) is under automated test.
- The same Gate runâ€™s `python ci / python 3.12` job shows pytest executing the keepalive suites (`tests/test_agents_pr_meta_keepalive.py`, `tests/test_keepalive_guard_utils.py`, `tests/test_keepalive_post_work.py`, `tests/test_keepalive_workflow.py`), providing coverage for label checks, orchestrator dispatch flow, and post-work reconciliation. All modules reported `PASS` in the progress log.
- The `summary` job within that run includes the `Append keepalive checklists` block and appends the rendered markdown to `gate-summary.md`, establishing that PR summaries still surface scope/tasks/acceptance data sourced from the issue.
- Agents PR meta manager run [19248010559](https://github.com/stranske/Trend_Model_Project/actions/runs/19248010559) logs show the `Upsert PR body sections` job fetching issue #3442 content and regenerating the automated status summary. This ensures downstream instructions inherit the same checklist structure represented in the summary job.
- Remaining gap: despite the stronger test coverage, none of the observed jobs enforce the live guardrail state (missing `agents:keepalive` label during Roundsâ€¯11â€“13) or trigger escalation when branch sync stalls. Evidence confirms the tooling is instrumented, but operational failures persist until the outstanding actions above are resolved.
- Next step: observe the 2025-11-11 scheduled orchestrator sweep to verify the run-cap throttle counters report expected utilisation and block excess dispatches; capture the summary output for the record.
- New data point: the 2025-11-11 02:18Z orchestrator sweep (`run 19252736124`) shows the `Evaluate keepalive gate` job emitting `::notice::keepalive_gate_proceed=false` and `keepalive_gate_reason=missing-pr-number`. No `run cap detail` line or `active_runs` outputs were produced, so the throttle counters remain unverified when the PR number is absent.
- Additional data point: manual sweep `19253985636` (2025-11-11 03:30Z) halted with `keepalive_gate_reason=keepalive-label-missing` and recorded the counters directly in the log (`keepalive_run_cap=2`, `active_runs=0`, `active_runs_inflight=0`, `active_runs_recent=0`, `keepalive_active_runs_recent_window=5`), confirming the new notices render even when the gate blocks the run.
- Follow-up reruns `19254098629` (2025-11-11 03:37Z) and `19254213558` (2025-11-11 03:44Z) â€” both executed after we believed the guardrail label was restored â€” still surfaced `keepalive_gate_reason=keepalive-label-missing` with the same zeroed counters. `gh pr view 3468 --json labels` confirms the label exists on the branch PR, but `gh api ... issues/3444/timeline` shows it was removed from PRÂ 3444 at 20:05Z on 2025-11-10 and never re-added. The manual sweep was querying PRÂ 3444; after rerunning with `keepalive_pr=3468` (run `19254322103`) the gate proceeded and emitted the notices. Next step is to capture a run with non-zero utilisation and bake the target-PR check into the regression harness.
- Historical reference: run `19244506591` (2025-11-10 20:03Z) resolved `KEEPALIVE_PR=3444` and reached `keepalive_gate_proceed=true`. The job summary (UI-only) records the run-cap utilisation, but that markdown is not exposed through the CLI logs we pulled; we still need to observe a gate **success** with the new notices to capture inflight/recent counts above zero.
- Prepare a regression patch if the sweep still exceeds the cap; otherwise promote the guardrail test plan into CI once evidence shows the throttle is effective.

### Review Procedure â€“ 2025-11-11

1. Re-read `docs/keepalive/GoalsAndPlumbing.md` (focus on Â§Â§1â€“5, Â§8, Â§9) and `docs/keepalive/SyncChecklist.md` to restate expected behaviour before evaluating evidence.
2. Collect PR metadata and job history via `gh pr view 3444 --json ...` and `gh pr diff 3444` to enumerate modified artefacts and workflow runs.
3. Execute the evidence plan in Â§â€œPR #3444 Evidence Planâ€:
	 - Extract the `countActiveRuns` TAP lines from the Gate `github scripts tests` job.
	 - Pull the pytest progress block covering keepalive test modules from the Gate `python ci / python 3.12` job.
	 - Capture the `Append keepalive checklists` output and PR-body sync logs from the summary and PR meta manager jobs.
4. Map each captured log snippet back to the relevant guardrail requirement (Goals Â§Â§1â€“5, Â§9; Sync Checklist Â§Â§1â€“5) and flag whether the evidence demonstrates enforcement or simply coverage.
5. Reconcile the findings with the Outstanding Actions list, updating this report and `docs/keepalive/AttemptLog_Nov2025.md` with explicit conclusions and next steps.

## Remediation Notes (2025-11-10)

- Timeline gap: `agents:keepalive` absent 07:07Zâ€“13:34Z while three rounds continued to post.
- Gate churn: at least nine Gate runs cancelled on `codex/issue-3428` between 13:32Z and 14:50Z (command output above).
- Orchestrator cadence: 12 runs triggered in 10 minutes (`19235652928` â†’ `19236890071`).
- Branch sync: latest failure `19222734980` (phase-2-dev) recorded minutes before the PR keepalive burst.
- Branch sync detail: job `Prepare sync branch` formerly aborted with `fatal: depth 0 is not a positive number`, blocking the update-branch fallback.
- Workflow patch: `agents-keepalive-branch-sync.yml` now uses `git fetch --no-tags --prune origin "$BASE_REF"`; dry run `19239811962` completed successfully (sync empty), validating the fix.
- 2025-11-11 review: Coverage-focused PR #3444 introduced no changes to keepalive automation; issues in Â§Â§1â€“4 and Â§Â§7â€“9 remain outstanding pending targeted fixes.

## Immediate mitigation applied (2025-11-11 04:50 UTC)

- Created repository label `agents:pause` and applied it to PR #3471 to halt further keepalive rounds while the evaluation continues. This enforces Goals Â§4 (Pause & Stop Controls) immediately and prevents additional instruction posts or orchestrator dispatches targeting that PR until the label is removed. See `docs/keepalive/AttemptLog_Nov2025.md` step 39 for the recorded action.

