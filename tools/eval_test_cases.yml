base_config: &base_config
  analysis:
    weighting:
      scheme: equal
    top_n: 8
    target_vol: 0.10
    frequency: "D"
  constraints:
    max_weight: 0.2

base_schema: &base_schema
  type: object
  properties:
    analysis:
      type: object
      properties:
        weighting:
          type: object
          properties:
            scheme:
              type: string
        top_n:
          type: integer
        target_vol:
          type: number
        frequency:
          type: string
    constraints:
      type: object
      properties:
        max_weight:
          type: number

cases:
  - id: risk_parity_weighting
    instruction: "Use risk parity weighting."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: set
          path: analysis.weighting.scheme
          value: risk_parity
      risk_flags: []
      summary: "Set weighting scheme to risk_parity."

  - id: select_top_12
    instruction: "Select top 12 funds."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: set
          path: analysis.top_n
          value: 12
      risk_flags: []
      summary: "Set top_n to 12."

  - id: remove_position_limits
    instruction: "Remove position limits."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: remove
          path: constraints.max_weight
          value: null
      risk_flags:
        - REMOVES_CONSTRAINT
      summary: "Remove max_weight constraint."

  - id: target_vol_15
    instruction: "Target 15% volatility."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: set
          path: analysis.target_vol
          value: 0.15
      risk_flags: []
      summary: "Set target_vol to 0.15."

  - id: monthly_and_risk_parity
    instruction: "Use monthly frequency and risk parity."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: set
          path: analysis.frequency
          value: "M"
        - op: set
          path: analysis.weighting.scheme
          value: risk_parity
      risk_flags: []
      summary: "Set frequency to monthly and weighting to risk_parity."

  - id: unknown_key_request
    instruction: "Enable turbo mode."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations: []
      risk_flags: []
      summary: "Requested unknown key: turbo_mode."

  - id: conflicting_top_n
    instruction: "Set top_n to 5 and then set top_n to 12."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: set
          path: analysis.top_n
          value: 12
      risk_flags: []
      summary: "Resolve conflict by setting top_n to 12."

  - id: ambiguous_request
    instruction: "Make the portfolio more conservative."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations: []
      risk_flags: []
      summary: "Need clarification on requested changes."

  - id: conflicting_frequency
    instruction: "Use monthly frequency and weekly frequency."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations:
        - op: set
          path: analysis.frequency
          value: "M"
      risk_flags: []
      summary: "Chose monthly frequency."

  - id: typo_key
    instruction: "Set analysis.weighting.sheme to risk_parity."
    current_config: *base_config
    allowed_schema: *base_schema
    expected_patch:
      operations: []
      risk_flags: []
      summary: "Unknown key 'analysis.weighting.sheme'; did you mean 'analysis.weighting.scheme'?"
